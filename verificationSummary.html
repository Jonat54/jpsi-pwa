<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R√©sum√© V√©rification - JPSI v1.4.40</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
  <script>
    // D√©sactiver les avertissements XMLHttpRequest synchrones
    const originalWarn = console.warn;
    console.warn = function(...args) {
      if (args[0] && typeof args[0] === 'string' && args[0].includes('XMLHttpRequest')) {
        return; // Ignorer les avertissements XMLHttpRequest
      }
      originalWarn.apply(console, args);
    };
  </script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    body {
      min-height: 100vh;
      min-width: 100vw;
      background: repeating-linear-gradient(135deg, #23272b 0 10px, #262a2e 10px 20px);
      font-family: 'SF Pro Display', 'Segoe UI', Arial, sans-serif;
      box-sizing: border-box;
      overflow-x: hidden;
      overflow-y: auto;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    
    .header-card {
      background: #f6f7f9;
      border: 3.5px solid #9B2423;
      border-radius: 38px;
      box-shadow: 0 6px 24px 0 rgba(30,32,36,0.13), 0 1.5px 0 #e5e7eb inset;
      padding: 2rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }
    
    .back-button {
      background: #9B2423;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .back-button:hover {
      background: #7a1d1c;
    }
    
    .header-title {
      font-size: 2.2rem;
      font-weight: 700;
      color: #23272b;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .header-subtitle {
      font-size: 0.9rem;
      font-weight: 500;
      color: #6b7280;
      margin: 0;
    }
    
    .edit-button {
      background: #9B2423;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 600;
      margin-left: auto;
      box-shadow: 0 4px 12px rgba(155, 36, 35, 0.3);
    }
    
    .edit-button:hover {
      background: #7a1d1c;
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(155, 36, 35, 0.4);
    }
    
    /* Bouton de modification discret */
    .settings-button {
      background: #6b7280;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 600;
      margin-left: 10px;
      box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
      opacity: 0.7;
    }
    
    .settings-button:hover {
      background: #4b5563;
      transform: scale(1.05);
      opacity: 1;
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
    }
    
    /* Modale de modification */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f3f4f6;
    }
    
    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #23272b;
      margin: 0;
    }
    
    .modal-close {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.2s;
    }
    
    .modal-close:hover {
      background: #dc2626;
      transform: scale(1.1);
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }
    
    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 1rem;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #9B2423;
      box-shadow: 0 0 0 3px rgba(155, 36, 35, 0.1);
    }
    
    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 2px solid #f3f4f6;
    }
    
    .btn-save {
      background: #10b981;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-save:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    
    .btn-cancel {
      background: #6b7280;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-cancel:hover {
      background: #4b5563;
    }
    
    .info-grid {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .info-section {
      background: #f6f7f9;
      border: 3.5px solid #9B2423;
      border-radius: 38px;
      box-shadow: 0 6px 24px 0 rgba(30,32,36,0.13), 0 1.5px 0 #e5e7eb inset;
      padding: 1.5rem 2rem;
      width: 100%;
      box-sizing: border-box;
    }
    
    .info-section h3 {
      margin: 0 0 1.2rem 0;
      color: #374151;
      font-size: 1.3rem;
      font-weight: 700;
      border-bottom: 2px solid #f3f4f6;
      padding-bottom: 0.5rem;
    }
    
    .info-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .info-table th {
      background: #f3f4f6;
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      font-size: 0.9rem;
    }
    
    .info-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #f9fafb;
      font-size: 0.95rem;
      color: #374151;
    }
    
    /* Mise en page simple et propre pour les informations */
    .info-simple-layout {
      display: flex;
      gap: 3rem;
      margin-top: 0.5rem;
    }
    
    .info-left {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .info-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .info-line {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.15rem 0;
    }
    
    .info-code {
      font-weight: 600;
      color: #6b7280;
      font-size: 0.95rem;
    }
    
    .info-separator {
      color: #9B2423;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .info-name {
      font-weight: 700;
      color: #374151;
      font-size: 1rem;
    }
    
    .info-address {
      font-weight: 500;
      color: #374151;
      font-size: 0.95rem;
    }
    
    .info-city {
      font-weight: 500;
      color: #374151;
      font-size: 0.95rem;
    }
    
    .info-label {
      font-weight: 600;
      color: #6b7280;
      font-size: 0.9rem;
      min-width: 140px;
    }
    
    .info-date {
      font-weight: 600;
      color: #374151;
      font-size: 0.95rem;
    }
    
    /* Styles pour les observations */
    .observations-content {
      margin-top: 1rem;
    }
    
    .loading-text {
      color: #6b7280;
      font-style: italic;
    }
    
    .observation-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 12px;
      border-left: 4px solid #9B2423;
      transition: all 0.2s ease;
    }
    
    .observation-item:hover {
      background: #f3f4f6;
      transform: translateX(4px);
    }
    
    .observation-item:last-child {
      margin-bottom: 0;
    }
    
    .observation-icon {
      font-size: 1.2rem;
      margin-top: 0.1rem;
      flex-shrink: 0;
    }
    
    .observation-text {
      flex: 1;
      font-size: 0.95rem;
      line-height: 1.4;
      color: #374151;
    }
    
    .observation-header {
      background: #9B2423;
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      text-align: center;
      box-shadow: 0 2px 8px rgba(155, 36, 35, 0.3);
    }
    
    .observation-type-header {
      background: #f3f4f6;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      margin: 1rem 0 0.5rem 0;
      font-weight: 600;
      color: #374151;
      border-left: 3px solid #6b7280;
      font-size: 0.9rem;
    }
    
    .observation-editor-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: #f8fafc;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
    }
    
    .observation-editor-header {
      margin-bottom: 1rem;
    }
    
    .observation-editor-header h4 {
      margin: 0 0 0.5rem 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: #374151;
    }
    
    .observation-editor-header p {
      margin: 0;
      font-size: 0.9rem;
      color: #6b7280;
    }
    
    .observation-editor-textarea {
      width: 100%;
      min-height: 200px;
      padding: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.95rem;
      line-height: 1.5;
      color: #374151;
      background: white;
      resize: vertical;
      transition: all 0.2s;
    }
    
    .observation-editor-textarea:focus {
      outline: none;
      border-color: #9B2423;
      box-shadow: 0 0 0 3px rgba(155, 36, 35, 0.1);
    }
    
    .observation-editor-textarea:hover {
      border-color: #9B2423;
    }
    
    /* Styles pour la prochaine v√©rification */
    .next-verification-content {
      margin-top: 1rem;
    }
    
    .verification-line {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 0;
    }
    
    .verification-label {
      font-weight: 600;
      color: #374151;
      font-size: 0.95rem;
      min-width: 150px;
    }
    
    .verification-date {
      font-weight: 600;
      color: #9B2423;
      font-size: 1rem;
    }
    
    /* Styles pour le bon de v√©rification */
    .bon-content {
      margin-top: 1rem;
    }
    
    .bon-line {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 0;
      margin-bottom: 1rem;
    }
    
    .bon-label {
      font-weight: 600;
      color: #374151;
      font-size: 0.95rem;
      min-width: 150px;
    }
    
    .bon-number {
      font-weight: 700;
      color: #9B2423;
      font-size: 1.1rem;
      background: #f3f4f6;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
    }
    
    .registre-checkbox {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: #f9fafb;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
    }
    
    .registre-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #9B2423;
    }
    
    .registre-checkbox label {
      font-size: 0.95rem;
      color: #374151;
      font-weight: 500;
    }
    
    .equipment-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    
    .equipment-table th {
      background: #f3f4f6;
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      font-size: 0.9rem;
    }
    
    .equipment-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #f9fafb;
      font-size: 0.95rem;
      color: #374151;
    }
    
    .equipment-count {
      text-align: center;
      font-weight: 600;
      color: #9B2423;
    }
    
    .observation-field {
      margin-bottom: 1.5rem;
    }
    
    .observation-label {
      display: block;
      font-weight: 600;
      color: #374151;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    
    .observation-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    
    .observation-textarea:focus {
      outline: none;
      border-color: #9B2423;
    }
    
    .next-verification-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    
    .next-verification-icon {
      font-size: 1.5rem;
    }
    
    .next-verification-details h4 {
      font-size: 0.9rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.25rem;
    }
    
    .next-verification-date {
      font-size: 1rem;
      font-weight: 600;
      color: #9B2423;
    }
    
    /* Styles optimis√©s pour iPad - Signatures */
    .signatures-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 2rem;
      margin-top: 1rem;
    }
    
    .signature-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .signature-card:hover {
      border-color: #9B2423;
      box-shadow: 0 4px 16px rgba(155, 36, 35, 0.1);
    }
    
    .signature-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f3f4f6;
    }
    
    .signature-icon {
      font-size: 1.5rem;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #9B2423 0%, #c53030 100%);
      color: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(155, 36, 35, 0.2);
    }
    
    .signature-header h4 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
      color: #374151;
    }
    
    .signature-content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .signature-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      transition: all 0.2s ease;
    }
    
    .signature-checkbox:hover {
      border-color: #9B2423;
      background: #f3f4f6;
    }
    
    .signature-checkbox input[type="checkbox"] {
      width: 24px;
      height: 24px;
      accent-color: #9B2423;
      margin-top: 0.25rem;
      flex-shrink: 0;
    }
    
    .signature-checkbox label {
      font-size: 0.95rem;
      color: #374151;
      line-height: 1.5;
      font-weight: 500;
    }
    
    .signature-area {
      position: relative;
      border: 3px solid #e5e7eb;
      border-radius: 12px;
      background: white;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .signature-area:hover {
      border-color: #9B2423;
      box-shadow: 0 4px 12px rgba(155, 36, 35, 0.1);
    }
    
    .signature-canvas {
      width: 100%;
      height: 200px;
      cursor: crosshair;
      display: block;
      background: white;
    }
    
    .signature-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      cursor: pointer;
      z-index: 10;
    }
    
    .signature-placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #9ca3af;
      font-style: italic;
      font-size: 1rem;
      text-align: center;
      pointer-events: none;
      z-index: 5;
    }
    
    .signature-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 0.5rem;
    }
    
    .signature-button {
      padding: 0.75rem 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: white;
      color: #374151;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.2s ease;
      min-width: 100px;
    }
    
    .signature-button:hover {
      background: #f3f4f6;
      border-color: #9B2423;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .signature-button:active {
      transform: translateY(0);
    }
    
    .signature-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Styles pour les champs de nom */
    .signature-name-field {
      margin: 1rem 0;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .signature-name-field label {
      font-weight: 600;
      color: #374151;
      font-size: 0.9rem;
    }
    
    .signature-name-input {
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
      color: #374151;
      background: white;
      transition: all 0.2s ease;
      font-family: 'Courier New', monospace;
    }
    
    .signature-name-input:focus {
      outline: none;
      border-color: #9B2423;
      box-shadow: 0 0 0 3px rgba(155, 36, 35, 0.1);
    }
    
    .signature-name-input:read-only {
      background: #f9fafb;
      color: #6b7280;
      cursor: not-allowed;
    }
    
    .actions-section {
      padding: 2rem;
      background: #f6f7f9;
      border: 3.5px solid #9B2423;
      border-radius: 38px;
      box-shadow: 0 6px 24px 0 rgba(30,32,36,0.13), 0 1.5px 0 #e5e7eb inset;
      text-align: center;
    }
    
    .generate-button {
      background: linear-gradient(135deg, #9B2423 0%, #c53030 100%);
      color: white;
      border: none;
      padding: 1.25rem 2.5rem;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(155, 36, 35, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .generate-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .generate-button:hover::before {
      left: 100%;
    }
    
    .generate-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(155, 36, 35, 0.4);
      background: linear-gradient(135deg, #c53030 0%, #dc2626 100%);
    }
    
    .generate-button:disabled {
      background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .generate-button:disabled:hover {
      transform: none;
      box-shadow: none;
    }
    
    .generate-button.loading {
      opacity: 0.7;
    }
    
    .button-group {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .generate-button.secondary {
      background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
      box-shadow: 0 4px 20px rgba(55, 65, 81, 0.3);
    }
    
    .generate-button.secondary:hover {
      background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
      box-shadow: 0 8px 30px rgba(55, 65, 81, 0.4);
    }
    
    /* Modale de signature */
    .signature-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
    }
    
    .signature-modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 0;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .signature-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px 16px 24px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .signature-modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #1d1d1f;
    }
    
    .signature-modal-close {
      font-size: 24px;
      font-weight: 300;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .signature-modal-close:hover {
      background-color: #f3f4f6;
      color: #374151;
    }
    
    .signature-modal-body {
      padding: 24px;
    }
    
    .signature-modal-body canvas {
      width: 100%;
      height: 200px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: #fff;
      cursor: crosshair;
    }
    
    .signature-modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      justify-content: flex-end;
    }
    
    .signature-canvas-container {
      position: relative;
    }
    
    .signature-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      cursor: pointer;
      z-index: 10;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
        gap: 1rem;
      }
      
      .header-card {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
      }
      
      .info-section {
        padding: 1rem;
      }
      
      .back-button {
        align-self: center;
      }
      
      .info-simple-layout {
        flex-direction: column;
        gap: 1.5rem;
      }
      
      .info-line {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
      }
      
      .info-label {
        min-width: auto;
      }
      
      .observation-item {
        padding: 0.75rem;
        margin-bottom: 0.75rem;
      }
      
      .verification-line,
      .bon-line {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .verification-label,
      .bon-label {
        min-width: auto;
      }
      
      .registre-checkbox {
        padding: 0.5rem;
      }
      
      .signatures-container {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .signature-card {
        padding: 1rem;
      }
      
      .signature-icon {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
      }
      
      .signature-header h4 {
        font-size: 1.1rem;
      }
      
      .signature-checkbox {
        padding: 0.75rem;
      }
      
      .signature-checkbox input[type="checkbox"] {
        width: 20px;
        height: 20px;
      }
      
      .signature-canvas {
        height: 150px;
      }
      
      .signature-button {
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
        min-width: 80px;
      }
      
      .equipment-table {
        font-size: 0.8rem;
      }
      
      .equipment-table th,
      .equipment-table td {
        padding: 0.5rem;
      }
      
      .signature-canvas {
        width: 100%;
        height: 120px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- En-t√™te principal -->
    <div class="header-card">
      <button class="back-button" onclick="goBack()" title="Retour">
        ‚Äπ
      </button>
      <div class="header-title">
        <span id="clientName">R√©sum√© V√©rification</span>
        <span class="header-subtitle" id="siteName">Chargement...</span>
      </div>
      <button onclick="openEditModal()" class="settings-button" title="Modifier les informations du rapport">
        ‚öôÔ∏è
      </button>
    </div>

    <!-- Sections d'information -->
    <div class="info-grid">
      <!-- Section Informations -->
      <div class="info-section">
        <h3>üìã Informations g√©n√©rales</h3>
        <div class="info-simple-layout">
          <!-- Partie gauche -->
          <div class="info-left">
            <div class="info-line">
              <span class="info-code" id="clientCode">--</span>
              <span class="info-separator">-</span>
              <span class="info-name" id="clientNameDetail">--</span>
            </div>
            <div class="info-line">
              <span class="info-code" id="siteNumber">--</span>
              <span class="info-separator">-</span>
              <span class="info-name" id="siteNameDetail">--</span>
            </div>
            <div class="info-line">
              <span class="info-address" id="siteAddress">--</span>
            </div>
            <div class="info-line">
              <span class="info-city" id="siteCity">--</span>
            </div>
          </div>
          
          <!-- Partie droite -->
          <div class="info-right">
            <div class="info-line">
              <span class="info-label">D√©but v√©rification :</span>
              <span class="info-date" id="startDate">--</span>
            </div>
            <div class="info-line">
              <span class="info-label">Fin v√©rification :</span>
              <span class="info-date" id="endDate">--</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Section √âquipements v√©rifi√©s -->
      <div class="info-section">
        <h3>√âquipements v√©rifi√©s</h3>
        <table class="equipment-table" id="equipmentRecapTable">
          <thead>
            <tr>
              <th>Type d'√©quipement</th>
              <th>Quantit√©</th>
            </tr>
          </thead>
          <tbody id="equipmentRecapTableBody">
            <tr>
              <td colspan="2" style="text-align: center; color: #999; font-style: italic;">Chargement des √©quipements...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Section Observations -->
      <div class="info-section">
        <h3>üìä Observations</h3>
        <div class="observations-content" id="observationsContent">
          <div class="loading-text">Analyse en cours...</div>
        </div>
      </div>

      <!-- Section Prochaine v√©rification -->
      <div class="info-section">
        <h3>üìÖ Prochaine v√©rification</h3>
        <div class="next-verification-content">
          <div class="verification-line">
            <span class="verification-label">V√©rification annuelle :</span>
            <span class="verification-date" id="nextVerificationDate">Chargement...</span>
          </div>
        </div>
      </div>
      
      <!-- Section Bon de v√©rification -->
      <div class="info-section">
        <h3>üìã Bon de v√©rification</h3>
        <div class="bon-content">
          <div class="bon-line">
            <span class="bon-label">Num√©ro du bon :</span>
            <span class="bon-number" id="bonNumber">G√©n√©ration en cours...</span>
          </div>
          <div class="registre-checkbox">
            <input type="checkbox" id="registreCheckbox">
            <label for="registreCheckbox">Registre de s√©curit√© √©marg√©</label>
          </div>
        </div>
      </div>

      <!-- Section Signatures -->
      <div class="info-section">
        <h3>‚úçÔ∏è Signatures</h3>
        <div class="signatures-container">
          <!-- Signature client -->
          <div class="signature-card">
            <div class="signature-header">
              <div class="signature-icon">üë§</div>
              <h4>Signature client</h4>
            </div>
            <div class="signature-content">
              <div class="signature-checkbox">
                <input type="checkbox" id="clientCheckbox">
                <label for="clientCheckbox">Je reconnais l'exactitude des quantitatifs indiqu√©s, des travaux r√©alis√©s, et prend connaissance des travaux √† r√©aliser.</label>
              </div>
              <div class="signature-name-field">
                <label for="clientNameInput">Nom du client :</label>
                <input type="text" id="clientNameInput" placeholder="Nom du client" class="signature-name-input">
              </div>
              <div class="signature-area">
                <canvas id="clientSignature" class="signature-canvas" width="400" height="200"></canvas>
                <div class="signature-overlay" id="clientSignatureOverlay"></div>
                <div class="signature-placeholder" id="clientPlaceholder">Cochez d'abord la case ci-dessus pour pouvoir signer</div>
              </div>
              <div class="signature-actions">
                <button class="signature-button" onclick="clearClientSignature()" disabled>Effacer</button>
              </div>
            </div>
          </div>
          
          <!-- Signature technicien -->
          <div class="signature-card">
            <div class="signature-header">
              <div class="signature-icon">üîß</div>
              <h4>Signature technicien</h4>
            </div>
            <div class="signature-content">
              <div class="signature-checkbox">
                <input type="checkbox" id="technicianCheckbox">
                <label for="technicianCheckbox">Je reconnais avoir inform√© le client des op√©rations de maintenance faites ou √† effectuer, ainsi que des travaux √† r√©aliser.</label>
              </div>
              <div class="signature-name-field">
                <label for="technicianNameInput">Nom du technicien :</label>
                <input type="text" id="technicianNameInput" value="Jonathan PRUD'HOMME" class="signature-name-input" readonly>
              </div>
              <div class="signature-area">
                <canvas id="technicianSignature" class="signature-canvas" width="400" height="200"></canvas>
                <div class="signature-overlay" id="technicianSignatureOverlay"></div>
                <div class="signature-placeholder" id="technicianPlaceholder">Cliquez pour signer</div>
              </div>
              <div class="signature-actions">
                <button class="signature-button" onclick="clearTechnicianSignature()">Effacer</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions-section">
      <div class="button-group">
        <button class="generate-button secondary" id="generateBtn2" onclick="generatePDF2()" disabled>
          üìã G√©n√©rer le PDF d√©taill√©
        </button>
      </div>
    </div>
  </div>

  <!-- Modale de signature -->
  <div id="signatureModal" class="signature-modal">
    <div class="signature-modal-content">
      <div class="signature-modal-header">
        <div class="signature-modal-title" id="signatureModalTitle">Signature du client</div>
        <span class="signature-modal-close" onclick="closeSignatureModal()">&times;</span>
      </div>
      <div class="signature-modal-body">
        <canvas id="signatureCanvas" width="400" height="200"></canvas>
        <div class="signature-modal-actions">
          <button class="signature-button" onclick="clearSignature()">Effacer</button>
          <button class="signature-button primary" onclick="saveSignature()">Valider</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration Supabase
    const SUPABASE_URL = 'https://anyzqzhjvankvbbajahj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFueXpxemhqdmFua3ZiYmFqYWhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NTIzMjgsImV4cCI6MjA2NjMyODMyOH0.74pICcGtU_Ks0COTtPsSOQ8qtLfOzRHTNa1A41BAiMU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Variables globales
    let verificationData = null;
    let clientData = null;
    let siteData = null;
    let equipmentData = {
      extincteurs: [],
      eclairages: [],
      alarmes: [],
      desenfumages: [],
      rias: [],
      plans_evacuation: []
    };
    let currentCanvas = null;
    let currentContext = null;
    let hasClientSignature = false;
    let hasTechnicianSignature = false;
    let clientCheckboxChecked = false;
    let technicianCheckboxChecked = false;
    let registreCheckboxChecked = false;
    let numeroDeBon = null;
    
    // R√©cup√©ration des param√®tres URL
    const urlParams = new URLSearchParams(window.location.search);
    const siteId = urlParams.get('site');
    const clientId = urlParams.get('client');
    const siteName = urlParams.get('siteName');
    const clientName = urlParams.get('clientName');
    
    console.log('üîç Param√®tres URL r√©cup√©r√©s:', { siteId, clientId, siteName, clientName });
    
    // Fonction pour g√©n√©rer un num√©ro de bon depuis la table BV
    async function generateBonNumber() {
      try {
        console.log('üî¢ G√©n√©ration du num√©ro de bon...');
        
        // R√©cup√©rer le dernier num_bv de la table BV directement
        const { data: lastBV, error } = await supabase
          .from('BV')
          .select('num_bv')
          .order('num_bv', { ascending: false })
          .limit(1);

        if (error) {
          console.error('‚ùå Erreur lors de la r√©cup√©ration du dernier BV:', error);
          // Fallback avec timestamp
          const currentYear = new Date().getFullYear();
          numeroDeBon = `${currentYear}-0001`;
          console.log('üî¢ Num√©ro de fallback g√©n√©r√©:', numeroDeBon);
          return;
        }

        let nextNumber = 1;
        if (lastBV && lastBV.length > 0 && lastBV[0].num_bv) {
          nextNumber = parseInt(lastBV[0].num_bv) + 1;
          console.log('üî¢ Dernier num√©ro trouv√©:', lastBV[0].num_bv);
          console.log('üî¢ Prochain num√©ro:', nextNumber);
        } else {
          console.log('‚ö†Ô∏è Aucun BV trouv√©, d√©but avec 0001');
        }

        // Formater le num√©ro au format ann√©e-num√©ro sur 4 chiffres
        const currentYear = new Date().getFullYear();
        numeroDeBon = `${currentYear}-${nextNumber.toString().padStart(4, '0')}`;
        console.log('üî¢ Num√©ro de bon g√©n√©r√©:', numeroDeBon);
        
        // V√©rifier que ce num√©ro n'existe pas d√©j√†
        const { data: existingBV, error: checkError } = await supabase
          .from('BV')
          .select('num_bv')
          .eq('num_bv', nextNumber);
        
        if (checkError) {
          console.error('‚ùå Erreur lors de la v√©rification du num√©ro:', checkError);
        } else if (existingBV && existingBV.length > 0) {
          console.warn('‚ö†Ô∏è Num√©ro d√©j√† existant, g√©n√©ration d\'un nouveau...');
          // Incr√©menter et r√©essayer
          nextNumber++;
          numeroDeBon = `${currentYear}-${nextNumber.toString().padStart(4, '0')}`;
          console.log('üî¢ Nouveau num√©ro de bon g√©n√©r√©:', numeroDeBon);
        }
        
      } catch (error) {
        console.error('‚ùå Erreur lors de la g√©n√©ration du num√©ro de bon:', error);
        // Fallback avec timestamp
        const currentYear = new Date().getFullYear();
        numeroDeBon = `${currentYear}-0001`;
        console.log('üî¢ Num√©ro de fallback g√©n√©r√©:', numeroDeBon);
      }
    }
    
    // Fonction pour nettoyer les noms pour le nom de fichier
    function cleanFileName(name) {
      if (!name) return 'Inconnu';
      return name
        .replace(/[^a-zA-Z0-9\s\-_]/g, '') // Supprimer les caract√®res sp√©ciaux
        .replace(/\s+/g, ' ') // Remplacer les espaces multiples par un seul
        .trim();
    }
    
        // Initialisation des canvas de signature optimis√©s pour iPad
    function initSignatureCanvas() {
      const clientCanvas = document.getElementById('clientSignature');
      const technicianCanvas = document.getElementById('technicianSignature');
      const clientOverlay = document.getElementById('clientSignatureOverlay');
      const technicianOverlay = document.getElementById('technicianSignatureOverlay');
      
      if (!clientCanvas || !technicianCanvas || !clientOverlay || !technicianOverlay) {
        console.error('‚ùå Canvas ou overlays de signature non trouv√©s');
        return;
      }
      
      // Configuration des canvas optimis√©s pour iPad
      [clientCanvas, technicianCanvas].forEach(canvas => {
        // Dimensions adaptatives
        canvas.width = 400;
        canvas.height = 200;
        canvas.style.width = '100%';
        canvas.style.height = '200px';
        
        // Styles optimis√©s pour tactile
        canvas.style.touchAction = 'none';
        canvas.style.userSelect = 'none';
        canvas.style.webkitUserSelect = 'none';
      });
      
      // Configuration des overlays pour iPad
      [clientOverlay, technicianOverlay].forEach(overlay => {
        const isClient = overlay.id === 'clientSignatureOverlay';
        
        // √âv√©nements tactiles optimis√©s
        overlay.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('üéØ Click d√©tect√© sur overlay:', this.id);
          if (isClient && !clientCheckboxChecked) {
            alert('Veuillez d\'abord cocher la case ci-dessus');
            return;
          }
          openSignatureModal(isClient ? 'client' : 'technician');
        });
        
        // Support tactile avanc√© pour iPad
        overlay.addEventListener('touchstart', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('üì± Touch d√©tect√© sur overlay:', this.id);
          if (isClient && !clientCheckboxChecked) {
            alert('Veuillez d\'abord cocher la case ci-dessus');
            return;
          }
          openSignatureModal(isClient ? 'client' : 'technician');
        }, { passive: false });
        
        overlay.addEventListener('touchmove', function(e) {
          e.preventDefault();
          e.stopPropagation();
        }, { passive: false });
        
        overlay.addEventListener('touchend', function(e) {
          e.preventDefault();
          e.stopPropagation();
        }, { passive: false });
      });
      
      console.log('‚úÖ Canvas et overlays de signature optimis√©s pour iPad initialis√©s');
    }
    
    // Variables pour la modale de signature
    let signatureCanvas = null;
    let signatureContext = null;
    let currentSignatureType = null;
    let isDrawing = false;
    
    // Ouvrir la modale de signature
    function openSignatureModal(signatureType) {
      currentSignatureType = signatureType;
      const modalTitle = signatureType === 'client' ? 'Signature du client' : 'Signature du technicien';
      
      document.getElementById('signatureModalTitle').textContent = modalTitle;
      document.getElementById('signatureModal').style.display = 'block';
      
      signatureCanvas = document.getElementById('signatureCanvas');
      signatureContext = signatureCanvas.getContext('2d');
      
      // Configurer le canvas de signature
      signatureContext.strokeStyle = '#000';
      signatureContext.lineWidth = 3;
      signatureContext.lineCap = 'round';
      
      // Effacer le canvas
      signatureContext.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
      
      // Ajouter les √©v√©nements de dessin
      signatureCanvas.addEventListener('mousedown', startDrawing);
      signatureCanvas.addEventListener('mousemove', draw);
      signatureCanvas.addEventListener('mouseup', stopDrawing);
      signatureCanvas.addEventListener('mouseout', stopDrawing);
      
      // Support tactile
      signatureCanvas.addEventListener('touchstart', startDrawingTouch);
      signatureCanvas.addEventListener('touchmove', drawTouch);
      signatureCanvas.addEventListener('touchend', stopDrawing);
      
      console.log('‚úÖ Modale de signature ouverte pour:', signatureType);
    }
    
    // Fermer la modale de signature
    function closeSignatureModal() {
      console.log('üîí Tentative de fermeture de la modale de signature');
      const modal = document.getElementById('signatureModal');
      if (modal) {
        modal.style.display = 'none';
        console.log('‚úÖ Modale ferm√©e avec succ√®s');
      } else {
        console.error('‚ùå √âl√©ment signatureModal non trouv√©');
      }
      
      // Retirer les √©v√©nements
      if (signatureCanvas) {
        signatureCanvas.removeEventListener('mousedown', startDrawing);
        signatureCanvas.removeEventListener('mousemove', draw);
        signatureCanvas.removeEventListener('mouseup', stopDrawing);
        signatureCanvas.removeEventListener('mouseout', stopDrawing);
        signatureCanvas.removeEventListener('touchstart', startDrawingTouch);
        signatureCanvas.removeEventListener('touchmove', drawTouch);
        signatureCanvas.removeEventListener('touchend', stopDrawing);
        console.log('‚úÖ √âv√©nements de signature supprim√©s');
      }
    }
    
    // Gestion des signatures dans la modale
    function startDrawing(event) {
      isDrawing = true;
      draw(event);
    }
    
    function draw(event) {
      if (!isDrawing) return;
      
      const rect = signatureCanvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      
      signatureContext.lineTo(x, y);
      signatureContext.stroke();
      signatureContext.beginPath();
      signatureContext.moveTo(x, y);
    }
    
    function startDrawingTouch(event) {
      event.preventDefault();
      isDrawing = true;
      drawTouch(event);
    }
    
    function drawTouch(event) {
      if (!isDrawing) return;
      event.preventDefault();
      
      const rect = signatureCanvas.getBoundingClientRect();
      const touch = event.touches[0];
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      
      signatureContext.lineTo(x, y);
      signatureContext.stroke();
      signatureContext.beginPath();
      signatureContext.moveTo(x, y);
    }
    
    function stopDrawing() {
      isDrawing = false;
      signatureContext.beginPath();
    }
    
    // Effacer la signature dans la modale
    function clearSignature() {
      signatureContext.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    }
    
    // Sauvegarder la signature
    function saveSignature() {
      console.log('üíæ FONCTION SAVESIGNATURE APPEL√âE !');
      console.log('üíæ Sauvegarde de la signature pour:', currentSignatureType);
      
      if (currentSignatureType === 'client') {
        const clientCanvas = document.getElementById('clientSignature');
        const ctx = clientCanvas.getContext('2d');
        ctx.clearRect(0, 0, clientCanvas.width, clientCanvas.height);
        ctx.drawImage(signatureCanvas, 0, 0, clientCanvas.width, clientCanvas.height);
        hasClientSignature = true;
        document.getElementById('clientPlaceholder').style.display = 'none';
        console.log('‚úÖ Signature client sauvegard√©e');
      } else {
        const technicianCanvas = document.getElementById('technicianSignature');
        const ctx = technicianCanvas.getContext('2d');
        ctx.clearRect(0, 0, technicianCanvas.width, technicianCanvas.height);
        ctx.drawImage(signatureCanvas, 0, 0, technicianCanvas.width, technicianCanvas.height);
        hasTechnicianSignature = true;
        document.getElementById('technicianPlaceholder').style.display = 'none';
        console.log('‚úÖ Signature technicien sauvegard√©e');
      }
      
      checkCanGenerate();
      console.log('üîí Fermeture de la modale de signature');
      closeSignatureModal();
    }
    
    // Fonction pour g√©rer l'arr√™t du dessin sur les canvas principaux
    function stopDrawingMain() {
      isDrawing = false;
      if (currentCanvas && currentCanvas.id === 'clientSignature') {
        hasClientSignature = true;
        document.getElementById('clientPlaceholder').style.display = 'none';
      } else if (currentCanvas && currentCanvas.id === 'technicianSignature') {
        hasTechnicianSignature = true;
        document.getElementById('technicianPlaceholder').style.display = 'none';
      }
      checkCanGenerate();
    }
    
    function clearClientSignature() {
      const canvas = document.getElementById('clientSignature');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      hasClientSignature = false;
      document.getElementById('clientPlaceholder').style.display = 'block';
      checkCanGenerate();
    }
    
    function clearTechnicianSignature() {
      const canvas = document.getElementById('technicianSignature');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      hasTechnicianSignature = false;
      document.getElementById('technicianPlaceholder').style.display = 'block';
      checkCanGenerate();
    }
    
    // Gestion des checkboxes
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('clientCheckbox').addEventListener('change', function() {
        clientCheckboxChecked = this.checked;
        toggleClientSignatureAccess(this.checked);
        checkCanGenerate();
      });
      
      document.getElementById('technicianCheckbox').addEventListener('change', function() {
        technicianCheckboxChecked = this.checked;
        checkCanGenerate();
      });
      
      document.getElementById('registreCheckbox').addEventListener('change', function() {
        registreCheckboxChecked = this.checked;
        checkCanGenerate();
      });
    });
    
    // Fonction pour activer/d√©sactiver la signature client
    function toggleClientSignatureAccess(enabled) {
      const clientCanvas = document.getElementById('clientSignature');
      const clientOverlay = document.getElementById('clientSignatureOverlay');
      const clientPlaceholder = document.getElementById('clientPlaceholder');
      const clearButton = document.querySelector('.signature-box:first-of-type .signature-actions .signature-button');
      
      if (enabled) {
        // Activer la signature
        clientCanvas.style.opacity = '1';
        clientOverlay.style.display = 'block';
        clientPlaceholder.textContent = 'Cliquez pour signer';
        clientPlaceholder.style.color = '#999';
        if (clearButton) {
          clearButton.disabled = false;
        }
      } else {
        // D√©sactiver la signature
        clientCanvas.style.opacity = '0.5';
        clientOverlay.style.display = 'none';
        clientPlaceholder.textContent = 'Cochez d\'abord la case ci-dessus pour pouvoir signer';
        clientPlaceholder.style.color = '#dc2626';
        if (clearButton) {
          clearButton.disabled = true;
        }
        
        // Effacer la signature si elle existait
        if (hasClientSignature) {
          clearClientSignature();
        }
      }
    }
    
    function checkCanGenerate() {
      const generateBtn = document.getElementById('generateBtn');
      const generateBtn2 = document.getElementById('generateBtn2');
      const canGenerate = hasClientSignature && hasTechnicianSignature && clientCheckboxChecked && technicianCheckboxChecked && registreCheckboxChecked;
      
      // V√©rifier si les boutons existent avant d'essayer de les modifier
      if (generateBtn) {
        generateBtn.disabled = !canGenerate;
      }
      
      // Pour les tests, le bouton 2 est toujours activ√©
      if (generateBtn2) {
        generateBtn2.disabled = false;
      }
    }
    
    // Chargement des donn√©es
    async function loadVerificationData() {
      try {
        console.log('üîç Chargement des donn√©es de v√©rification...');
        
        // Utiliser les donn√©es pass√©es en param√®tres
        if (siteId && clientName && siteName) {
          verificationData = {
            id: siteId,
            type_equipement: 'v√©rification compl√®te',
            type: 'Site complet',
            emplacement: decodeURIComponent(siteName),
            marque: 'Divers',
            date_derniere_verif: new Date().toISOString().split('T')[0],
            site_id: siteId
          };
          
          // Charger les donn√©es compl√®tes du site depuis Supabase
          const { data: siteDataFromDB, error: siteError } = await supabase
            .from('sites')
            .select('*')
            .eq('id_site', siteId)
            .single();

          if (siteError) {
            console.error('Erreur lors du chargement du site:', siteError);
          siteData = { 
            nom: decodeURIComponent(siteName), 
            id_client: clientId 
          };
          } else {
            siteData = siteDataFromDB;
          }

          // Charger les donn√©es compl√®tes du client depuis Supabase
          const { data: clientDataFromDB, error: clientError } = await supabase
            .from('clients')
            .select('*')
            .eq('id_client', clientId)
            .single();

          if (clientError) {
            console.error('Erreur lors du chargement du client:', clientError);
          clientData = { 
            nom_client: decodeURIComponent(clientName) 
          };
          } else {
            clientData = clientDataFromDB;
          }
          
                  // Mettre √† jour l'interface
        updateInterface();
        
        // Charger les √©quipements du site
        await loadEquipmentData();
        
        // Charger les dates de v√©rification
        await loadVerificationDates();
        
        // G√©n√©rer et afficher le num√©ro du bon
        await generateBonNumber();
        document.getElementById('bonNumber').textContent = numeroDeBon || 'Erreur de g√©n√©ration';
        } else {
          // Pas de donn√©es disponibles
          console.error('‚ùå Donn√©es manquantes pour le r√©sum√©');
          alert('Impossible de charger les donn√©es du site. V√©rifiez que le site existe.');
          return;
        }
        
      } catch (error) {
        console.error('Erreur lors du chargement:', error);
        alert('Erreur lors du chargement des donn√©es');
      }
    }
    
    // Fonction pour charger les dates de v√©rification
    async function loadVerificationDates() {
      try {
        // R√©cup√©rer l'ID de l'intervention depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const interventionId = urlParams.get('intervention');
        
        if (!interventionId) {
          console.error('‚ùå ID d\'intervention manquant dans l\'URL');
          document.getElementById('startDate').textContent = 'Non d√©finie';
          document.getElementById('endDate').textContent = 'Non d√©finie';
          return;
        }
        
        console.log('üîç Chargement des dates de v√©rification pour l\'intervention:', interventionId);
        
        // R√©cup√©rer toutes les v√©rifications de cette intervention
        const { data: verifications, error } = await supabase
          .from('verifications')
          .select('date_verification')
          .eq('id_intervention', interventionId)
          .not('date_verification', 'is', null);
        
        if (error) {
          console.error('‚ùå Erreur lors du chargement des v√©rifications:', error);
          document.getElementById('startDate').textContent = 'Erreur';
          document.getElementById('endDate').textContent = 'Erreur';
          return;
        }
        
        console.log('üîç V√©rifications trouv√©es:', verifications);
        
        let earliestDate = null;
        let latestDate = null;
        
        // Calculer les dates de d√©but et fin bas√©es sur les dates de v√©rification
        verifications.forEach(verification => {
          if (verification.date_verification) {
            const date = new Date(verification.date_verification);
            if (!earliestDate || date < earliestDate) earliestDate = date;
            if (!latestDate || date > latestDate) latestDate = date;
          }
        });
        
        // Mettre √† jour l'affichage
        if (earliestDate) {
          document.getElementById('startDate').textContent = earliestDate.toLocaleDateString('fr-FR');
          // Initialiser les donn√©es modifiables
          editableData.startDate = earliestDate.toISOString().split('T')[0];
        } else {
          document.getElementById('startDate').textContent = 'Non d√©finie';
        }
        
        if (latestDate) {
          document.getElementById('endDate').textContent = latestDate.toLocaleDateString('fr-FR');
          // Initialiser les donn√©es modifiables
          editableData.endDate = latestDate.toISOString().split('T')[0];
        } else {
          document.getElementById('endDate').textContent = 'Non d√©finie';
        }
        
        console.log('üìÖ Dates de v√©rification:', {
          d√©but: earliestDate ? earliestDate.toLocaleDateString('fr-FR') : 'Non d√©finie',
          fin: latestDate ? latestDate.toLocaleDateString('fr-FR') : 'Non d√©finie'
        });
        
      } catch (error) {
        console.error('Erreur lors du chargement des dates:', error);
        document.getElementById('startDate').textContent = 'Erreur';
        document.getElementById('endDate').textContent = 'Erreur';
      }
    }
    
    // Fonction pour charger les √©quipements du site
    async function loadEquipmentData() {
      try {
        console.log('üîç Chargement des √©quipements pour le site:', siteId);
        
        // Charger les extincteurs
        const { data: extincteurs, error: extError } = await supabase
          .from('extincteurs')
          .select('*')
          .eq('id_site', siteId);
        
        console.log('üîç Extincteurs charg√©s:', extincteurs);
        console.log('üîç Erreur extincteurs:', extError);
        
        if (!extError && extincteurs) {
          equipmentData.extincteurs = extincteurs;
          console.log('‚úÖ Extincteurs ajout√©s:', equipmentData.extincteurs.length);
          
          // Charger les agents pour chaque extincteur
          for (let ext of equipmentData.extincteurs) {
            if (ext.agent_ext) {
              const { data: agent, error: agentError } = await supabase
                .from('AgentExtincteur')
                .select('long_agt')
                .eq('id_agt', ext.agent_ext)
                .single();
              
              if (!agentError && agent) {
                ext.agent_long_name = agent.long_agt;
              }
            }
          }
        } else {
          console.log('‚ùå Erreur ou pas d\'extincteurs trouv√©s');
          equipmentData.extincteurs = [];
        }
        
        // Charger les √©clairages
        const { data: eclairages, error: eclError } = await supabase
          .from('eclairages')
          .select('*')
          .eq('id_site', siteId);
        
        if (!eclError && eclairages) {
          equipmentData.eclairages = eclairages;
        }
        
        // Charger les alarmes
        const { data: alarmes, error: alarmError } = await supabase
          .from('alarmes')
          .select('*')
          .eq('id_site', siteId);
        
        if (!alarmError && alarmes) {
          equipmentData.alarmes = alarmes;
        }
        
        // Charger les d√©senfumages
        const { data: desenfumages, error: desError } = await supabase
          .from('desenfumages')
          .select('*')
          .eq('id_site', siteId);
        
        if (!desError && desenfumages) {
          equipmentData.desenfumages = desenfumages;
          console.log('‚úÖ D√©senfumages charg√©s:', desenfumages.length);
        } else {
          console.log('‚ùå Erreur ou pas de d√©senfumages trouv√©s:', desError);
          equipmentData.desenfumages = [];
        }
        
        // Charger les RIAS
        const { data: rias, error: riaError } = await supabase
          .from('rias')
          .select('*')
          .eq('id_site', siteId);
        
        if (!riaError && rias) {
          equipmentData.rias = rias;
        }
        
        // Charger les plans d'√©vacuation
        const { data: plans_evacuation, error: planError } = await supabase
          .from('plans')
          .select('*')
          .eq('id_site', siteId);
        
        if (!planError && plans_evacuation) {
          equipmentData.plans_evacuation = plans_evacuation;
        }
        

        
        console.log('‚úÖ √âquipements charg√©s:', equipmentData);
        
        // Mettre √† jour le tableau
        await updateEquipmentTable();
        
        // G√©n√©rer le r√©sum√© des observations
        await generateObservationsSummary();
        
      } catch (error) {
        console.error('‚ùå Erreur lors du chargement des √©quipements:', error);
        // En cas d'erreur, on affiche un message et on arr√™te
        alert('Erreur lors du chargement des √©quipements. V√©rifiez votre connexion.');
        return;
      }
    }
    
    // Fonction pour g√©n√©rer le r√©sum√© des observations
    async function generateObservationsSummary() {
      console.log('üîç G√©n√©ration du r√©sum√© des observations...');
      
      const observationsContent = await generateObservationsContent();
      document.getElementById('observationsContent').innerHTML = observationsContent;
    }
    
    // Fonction pour g√©n√©rer tout le contenu des observations
    async function generateObservationsContent() {
      const observations = [];
      
      try {
        // R√©cup√©rer l'ID de l'intervention depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const interventionId = urlParams.get('intervention');
        
        if (!interventionId) {
          console.error('‚ùå ID d\'intervention manquant dans l\'URL');
          return '<div class="observation-item"><span class="observation-icon">‚ùå</span><span class="observation-text">Erreur: Intervention non trouv√©e</span></div>';
        }
        
        console.log('üîç R√©cup√©ration des observations pour l\'intervention:', interventionId);
        
        // R√©cup√©rer toutes les v√©rifications avec observations de cette intervention
        const { data: verifications, error } = await supabase
          .from('verifications')
          .select('type_equipement, id_equipement, observations')
          .eq('id_intervention', interventionId)
          .not('observations', 'is', null)
          .neq('observations', '');
        
        if (error) {
          console.error('‚ùå Erreur lors du chargement des observations:', error);
          return '<div class="observation-item"><span class="observation-icon">‚ùå</span><span class="observation-text">Erreur lors du chargement des observations</span></div>';
        }
        
        console.log('üîç V√©rifications avec observations trouv√©es:', verifications);
        
        // R√©cup√©rer les d√©tails des √©quipements pour avoir leurs num√©ros
        for (const verification of verifications) {
          const { type_equipement, id_equipement, observations: observationText } = verification;
          
          if (!observationText || observationText.trim() === '') continue;
          
          // R√©cup√©rer le num√©ro de l'√©quipement selon son type
          let numero = 'N/A';
          let typeLabel = type_equipement;
          
          try {
            switch (type_equipement) {
              case 'extincteurs':
                const { data: ext } = await supabase
                  .from('extincteurs')
                  .select('num_ext')
                  .eq('id_ext', id_equipement)
                  .single();
                if (ext) numero = ext.num_ext || 'N/A';
                typeLabel = 'Extincteur';
                break;
                
              case 'eclairages':
                const { data: ecl } = await supabase
                  .from('eclairages')
                  .select('num_ecl')
                  .eq('id_ecl', id_equipement)
                  .single();
                if (ecl) numero = ecl.num_ecl || 'N/A';
                typeLabel = '√âclairage';
                break;
                
              case 'alarmes':
                const { data: alarm } = await supabase
                  .from('alarmes')
                  .select('num_alarme')
                  .eq('id_alarme', id_equipement)
                  .single();
                if (alarm) numero = alarm.num_alarme || 'N/A';
                typeLabel = 'Alarme';
                break;
                
              case 'desenfumages':
                const { data: des } = await supabase
                  .from('desenfumages')
                  .select('id_desenfumage')
                  .eq('id_des', id_equipement)
                  .single();
                if (des) numero = des.id_desenfumage || 'N/A';
                typeLabel = 'D√©senfumage';
                break;
                
              case 'rias':
                const { data: ria } = await supabase
                  .from('rias')
                  .select('num_ria')
                  .eq('id_ria', id_equipement)
                  .single();
                if (ria) numero = ria.num_ria || 'N/A';
                typeLabel = 'RIA';
                break;
                
              case 'plans':
              case 'plans_evacuation':
                const { data: plan } = await supabase
                  .from('plans')
                  .select('num_plan')
                  .eq('id_plan', id_equipement)
                  .single();
                if (plan) numero = plan.num_plan || 'N/A';
                typeLabel = 'Plan d\'√©vacuation';
                break;
            }
          } catch (equipmentError) {
            console.error('‚ùå Erreur lors de la r√©cup√©ration du num√©ro d\'√©quipement:', equipmentError);
          }
          
          observations.push({
            type: typeLabel,
            numero: numero,
            observation: observationText.trim()
          });
        }
        
        console.log('‚úÖ Observations r√©cup√©r√©es:', observations);
        
      } catch (error) {
        console.error('‚ùå Erreur lors de la r√©cup√©ration des observations:', error);
        return '<div class="observation-item"><span class="observation-icon">‚ùå</span><span class="observation-text">Erreur lors de la r√©cup√©ration des observations</span></div>';
      }
      
              if (observations.length === 0) {
          return '<div class="observation-item"><span class="observation-icon">‚úÖ</span><span class="observation-text">Aucune observation</span></div>';
        }
        
        // Regrouper les observations par type d'observation
        const groupedObservations = {};
        
        observations.forEach(obs => {
          // Normaliser l'observation pour le regroupement
          const normalizedObs = obs.observation.toLowerCase().trim();
          
          if (!groupedObservations[normalizedObs]) {
            groupedObservations[normalizedObs] = {
              originalText: obs.observation,
              equipments: []
            };
          }
          
          groupedObservations[normalizedObs].equipments.push({
            type: obs.type,
            numero: obs.numero
          });
        });
        
        let html = '';
        
        // Ajouter un en-t√™te avec le nombre total d'observations
        html = `<div class="observation-header">üìä <strong>${observations.length} observation(s) au total</strong></div>`;
        
        // G√©n√©rer la liste group√©e par type d'observation
        Object.entries(groupedObservations).forEach(([normalizedObs, data]) => {
          // Trier les √©quipements par type puis par num√©ro
          const sortedEquipments = data.equipments.sort((a, b) => {
            if (a.type !== b.type) {
              return a.type.localeCompare(b.type);
            }
            // Trier num√©riquement si possible
            const numA = parseInt(a.numero);
            const numB = parseInt(b.numero);
            if (!isNaN(numA) && !isNaN(numB)) {
              return numA - numB;
            }
            return a.numero.localeCompare(b.numero);
          });
          
          // Regrouper les √©quipements par type
          const equipmentsByType = {};
          sortedEquipments.forEach(equipment => {
            if (!equipmentsByType[equipment.type]) {
              equipmentsByType[equipment.type] = [];
            }
            equipmentsByType[equipment.type].push(equipment.numero);
          });
          
          // En-t√™te du type d'observation
          html += `<div class="observation-type-header">üîç <strong>${data.originalText}</strong> (${sortedEquipments.length} √©quipement(s))</div>`;
          
          // Liste des √©quipements group√©s par type
          Object.entries(equipmentsByType).forEach(([type, numeros]) => {
            const numerosList = numeros.join(', ');
            html += `
              <div class="observation-item">
                <span class="observation-icon">üìù</span>
                <span class="observation-text"><strong>${type}</strong> ${numerosList}</span>
              </div>
            `;
          });
          
                  // Espace entre les types d'observation
        html += '<div style="margin-bottom: 1rem;"></div>';
      });
      
      // Ajouter le champ de saisie pour les observations finales
      html += `
        <div class="observation-editor-section">
          <div class="observation-editor-header">
            <h4>üìù Observations finales</h4>
            <p>Modifiez le texte des observations selon vos besoins</p>
          </div>
          <textarea 
            id="finalObservationsText" 
            class="observation-editor-textarea" 
            rows="8" 
            placeholder="Observations finales de la v√©rification..."
          >${generateFinalObservationsText(groupedObservations)}</textarea>
        </div>
      `;
      
              return html;
    }
    
    // Fonction pour g√©n√©rer le texte final des observations
    function generateFinalObservationsText(groupedObservations) {
      let text = '';
      
      Object.entries(groupedObservations).forEach(([normalizedObs, data]) => {
        // Trier les √©quipements par type puis par num√©ro
        const sortedEquipments = data.equipments.sort((a, b) => {
          if (a.type !== b.type) {
            return a.type.localeCompare(b.type);
          }
          const numA = parseInt(a.numero);
          const numB = parseInt(b.numero);
          if (!isNaN(numA) && !isNaN(numB)) {
            return numA - numB;
          }
          return a.numero.localeCompare(b.numero);
        });
        
        // Regrouper les √©quipements par type
        const equipmentsByType = {};
        sortedEquipments.forEach(equipment => {
          if (!equipmentsByType[equipment.type]) {
            equipmentsByType[equipment.type] = [];
          }
          equipmentsByType[equipment.type].push(equipment.numero);
        });
        
        // Ajouter les √©quipements avec leur observation (format group√©)
        Object.entries(equipmentsByType).forEach(([type, numeros]) => {
          // Cr√©er la liste des num√©ros avec formatage intelligent
          let numerosList;
          if (numeros.length === 1) {
            numerosList = `n¬∞${numeros[0]}`;
          } else if (numeros.length === 2) {
            numerosList = `n¬∞${numeros[0]} et ${numeros[1]}`;
          } else {
            // Pour 3 ou plus : n¬∞1, 3, 5 et 7
            const lastNum = numeros.pop();
            numerosList = `n¬∞${numeros.join(', ')} et ${lastNum}`;
          }
          
          text += `${type} ${numerosList} : ${data.originalText}\n`;
        });
        
        text += '\n';
      });
      
      return text.trim();
    }
    

    
    // G√©n√©rer les anomalies d√©tect√©es
    function generateAnomalies() {
      const observations = [];
      
              // Utiliser les observations v√©rifi√©es de cette intervention
        verifiedObservations.forEach(obs => {
          observations.push({
            type: obs.type,
            numero: obs.numero,
            observation: obs.observation
          });
        });
      
      if (observations.length === 0) {
        return '<div class="summary-item"><span class="summary-item-icon">‚úÖ</span><span class="summary-item-text">Aucune observation</span></div>';
      }
      
      // Regrouper les observations par type d'√©quipement et par probl√®me
      const groupedObservations = {};
      
      observations.forEach(obs => {
        if (!groupedObservations[obs.type]) {
          groupedObservations[obs.type] = {};
        }
        
        // Normaliser l'observation pour le regroupement
        const normalizedObs = obs.observation.toLowerCase().trim();
        
        if (!groupedObservations[obs.type][normalizedObs]) {
          groupedObservations[obs.type][normalizedObs] = {
            numeros: [],
            originalText: obs.observation
          };
        }
        
        groupedObservations[obs.type][normalizedObs].numeros.push(obs.numero);
      });
      
      let html = '';
      
      // G√©n√©rer le r√©sum√© synth√©tis√©
      Object.entries(groupedObservations).forEach(([type, problems]) => {
        Object.entries(problems).forEach(([normalizedProblem, data]) => {
          const numeros = data.numeros.sort((a, b) => {
            // Trier num√©riquement si possible
            const numA = parseInt(a);
            const numB = parseInt(b);
            if (!isNaN(numA) && !isNaN(numB)) {
              return numA - numB;
            }
            return a.localeCompare(b);
          }).join(', ');
          
          html += `
            <div class="summary-item">
              <span class="summary-item-icon">üìù</span>
              <span class="summary-item-text"><strong>${type} ${numeros}</strong> : ${data.originalText}</span>
            </div>
          `;
        });
      });
      
      return html;
    }
    
    // G√©n√©rer les actions recommand√©es
    async function generateActions() {
      const actions = [];
      const observations = [];
      
      // R√©cup√©rer les observations v√©rifi√©es de cette intervention
      const verifiedObservations = await getVerifiedObservations();
      
      // Collecter toutes les observations v√©rifi√©es
      verifiedObservations.forEach(obs => {
        observations.push(obs.observation.toLowerCase());
      });
      
      // Analyser les observations pour d√©terminer les actions
      const hasMaintenance = observations.some(obs => 
        obs.includes('maintenance') || 
        obs.includes('remplacement') || 
        obs.includes('r√©vision') ||
        obs.includes('devis')
      );
      
      const hasCritical = observations.some(obs => 
        obs.includes('d√©faut') || 
        obs.includes('panne') || 
        obs.includes('hs') ||
        obs.includes('batterie') ||
        obs.includes('pression') ||
        obs.includes('manque')
      );
      
      if (hasCritical) {
        actions.push('Intervention corrective imm√©diate requise');
        actions.push('Mise √† jour du registre de s√©curit√©');
      }
      
      if (hasMaintenance) {
        actions.push('√âtablir un devis pour maintenance');
      }
      
      if (actions.length === 0) {
        return '<div class="summary-item"><span class="summary-item-icon">‚úÖ</span><span class="summary-item-text">Aucune action requise</span></div>';
      }
      
      let html = '';
      actions.forEach(action => {
        html += `
          <div class="summary-item">
            <span class="summary-item-icon">üîß</span>
            <span class="summary-item-text">${action}</span>
          </div>
        `;
      });
      
      return html;
    }
    
    // Fonction pour r√©cup√©rer les √©quipements v√©rifi√©s de cette intervention
    async function getVerifiedEquipment() {
      try {
        // R√©cup√©rer l'ID de l'intervention depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const interventionId = urlParams.get('intervention');
        
        if (!interventionId) {
          console.error('‚ùå ID d\'intervention manquant dans l\'URL');
          return {};
        }
        
        console.log('üîç R√©cup√©ration des √©quipements v√©rifi√©s pour l\'intervention:', interventionId);
        
        // R√©cup√©rer toutes les v√©rifications de cette intervention
        const { data: verifications, error } = await supabase
          .from('verifications')
          .select('type_equipement, id_equipement')
          .eq('id_intervention', interventionId);
        
        if (error) {
          console.error('‚ùå Erreur lors du chargement des v√©rifications:', error);
          return {};
        }
        
        console.log('üîç V√©rifications trouv√©es:', verifications);
        
        // Grouper par type d'√©quipement
        const verifiedEquipment = {
          extincteurs: [],
          eclairages: [],
          alarmes: [],
          desenfumages: [],
          rias: [],
          plans_evacuation: []
        };
        
        // R√©cup√©rer les d√©tails des √©quipements v√©rifi√©s
        for (const verification of verifications) {
          const { type_equipement, id_equipement } = verification;
          
          // R√©cup√©rer les d√©tails de l'√©quipement selon son type
          let equipmentDetails = null;
          
          switch (type_equipement) {
            case 'extincteurs':
              const { data: ext } = await supabase
                .from('extincteurs')
                .select('*')
                .eq('id_ext', id_equipement)
                .single();
              if (ext) {
                // Charger l'agent extincteur pour avoir le nom long
                if (ext.agent_ext) {
                  const { data: agent, error: agentError } = await supabase
                    .from('AgentExtincteur')
                    .select('long_agt')
                    .eq('id_agt', ext.agent_ext)
                    .single();
                  
                  if (!agentError && agent) {
                    ext.agent_long_name = agent.long_agt;
                  }
                }
                verifiedEquipment.extincteurs.push(ext);
              }
              break;
              
            case 'eclairages':
              const { data: ecl } = await supabase
                .from('eclairages')
                .select('*')
                .eq('id_ecl', id_equipement)
                .single();
              if (ecl) verifiedEquipment.eclairages.push(ecl);
              break;
              
            case 'alarmes':
              const { data: alarm } = await supabase
                .from('alarmes')
                .select('*')
                .eq('id_alarme', id_equipement)
                .single();
              if (alarm) verifiedEquipment.alarmes.push(alarm);
              break;
              
            case 'desenfumages':
              const { data: des } = await supabase
                .from('desenfumages')
                .select('*')
                .eq('id_desenfumage', id_equipement)
                .single();
              if (des) verifiedEquipment.desenfumages.push(des);
              break;
              
            case 'rias':
              const { data: ria } = await supabase
                .from('rias')
                .select('*')
                .eq('id_ria', id_equipement)
                .single();
              if (ria) verifiedEquipment.rias.push(ria);
              break;
              
            case 'plans_evacuation':
              const { data: plan } = await supabase
                .from('plans_evacuation')
                .select('*')
                .eq('id_plan', id_equipement)
                .single();
              if (plan) verifiedEquipment.plans_evacuation.push(plan);
              break;
          }
        }
        
        console.log('‚úÖ √âquipements v√©rifi√©s r√©cup√©r√©s:', verifiedEquipment);
        return verifiedEquipment;
        
      } catch (error) {
        console.error('‚ùå Erreur lors de la r√©cup√©ration des √©quipements v√©rifi√©s:', error);
        return {};
      }
    }
    
    // Fonction pour r√©cup√©rer les observations de cette intervention
    async function getVerifiedObservations() {
      try {
        // R√©cup√©rer l'ID de l'intervention depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const interventionId = urlParams.get('intervention');
        
        if (!interventionId) {
          console.error('‚ùå ID d\'intervention manquant dans l\'URL');
          return [];
        }
        
        console.log('üîç R√©cup√©ration des observations pour l\'intervention:', interventionId);
        
        // R√©cup√©rer toutes les v√©rifications avec observations de cette intervention
        const { data: verifications, error } = await supabase
          .from('verifications')
          .select('type_equipement, id_equipement, observations')
          .eq('id_intervention', interventionId)
          .not('observations', 'is', null)
          .neq('observations', '');
        
        if (error) {
          console.error('‚ùå Erreur lors du chargement des observations:', error);
          return [];
        }
        
        console.log('üîç V√©rifications avec observations trouv√©es:', verifications);
        
        const observations = [];
        
        // R√©cup√©rer les d√©tails des √©quipements pour avoir leurs num√©ros
        for (const verification of verifications) {
          const { type_equipement, id_equipement, observations: observationText } = verification;
          
          if (!observationText || observationText.trim() === '') continue;
          
          // R√©cup√©rer le num√©ro de l'√©quipement selon son type
          let numero = 'N/A';
          let typeLabel = type_equipement;
          
          try {
            switch (type_equipement) {
              case 'extincteurs':
                const { data: ext } = await supabase
                  .from('extincteurs')
                  .select('num_ext')
                  .eq('id_ext', id_equipement)
                  .single();
                if (ext) numero = ext.num_ext || 'N/A';
                typeLabel = 'Extincteur';
                break;
                
              case 'eclairages':
                const { data: ecl } = await supabase
                  .from('eclairages')
                  .select('num_ecl')
                  .eq('id_ecl', id_equipement)
                  .single();
                if (ecl) numero = ecl.num_ecl || 'N/A';
                typeLabel = '√âclairage';
                break;
                
              case 'alarmes':
                const { data: alarm } = await supabase
                  .from('alarmes')
                  .select('num_alarme')
                  .eq('id_alarme', id_equipement)
                  .single();
                if (alarm) numero = alarm.num_alarme || 'N/A';
                typeLabel = 'Alarme';
                break;
                
              case 'desenfumages':
                const { data: des } = await supabase
                  .from('desenfumages')
                  .select('num_des')
                  .eq('id_desenfumage', id_equipement)
                  .single();
                if (des) numero = des.num_des || 'N/A';
                typeLabel = 'D√©senfumage';
                break;
                
              case 'rias':
                const { data: ria } = await supabase
                  .from('rias')
                  .select('num_ria')
                  .eq('id_ria', id_equipement)
                  .single();
                if (ria) numero = ria.num_ria || 'N/A';
                typeLabel = 'RIA';
                break;
                
              case 'plans_evacuation':
                const { data: plan } = await supabase
                  .from('plans_evacuation')
                  .select('num_plan')
                  .eq('id_plan', id_equipement)
                  .single();
                if (plan) numero = plan.num_plan || 'N/A';
                typeLabel = 'Plan d\'√©vacuation';
                break;
            }
          } catch (equipmentError) {
            console.error('‚ùå Erreur lors de la r√©cup√©ration du num√©ro d\'√©quipement:', equipmentError);
          }
          
          observations.push({
            type: typeLabel,
            numero: numero,
            observation: observationText.trim()
          });
        }
        
        console.log('‚úÖ Observations r√©cup√©r√©es:', observations);
        return observations;
        
      } catch (error) {
        console.error('‚ùå Erreur lors de la r√©cup√©ration des observations:', error);
        return [];
      }
    }
    
    // Fonction pour mettre √† jour le tableau des √©quipements
    async function updateEquipmentTable() {
      const tbody = document.getElementById('equipmentRecapTableBody');
      let html = '';
      
      // R√©cup√©rer les √©quipements v√©rifi√©s de cette intervention
      const verifiedEquipment = await getVerifiedEquipment();
      
      console.log('üîç Mise √† jour tableau - √âquipements v√©rifi√©s:', verifiedEquipment);
      
      // EXTINCTEURS par agent (avec nom long)
      if (verifiedEquipment.extincteurs.length > 0) {
        const extincteursByAgent = groupExtincteursByAgent(verifiedEquipment.extincteurs);
        console.log('üîç Extincteurs v√©rifi√©s group√©s par agent:', extincteursByAgent);
        
        Object.entries(extincteursByAgent).forEach(([groupKey, extincteurs]) => {
          // R√©cup√©rer le nom long depuis le premier extincteur du groupe
          const firstExtincteur = extincteurs[0];
          const agentName = firstExtincteur.agent_long_name || `Agent ${firstExtincteur.agent_ext}`;
          const capacite = firstExtincteur.capa_ext || '';
          const count = extincteurs.length;
          const displayText = capacite ? `${agentName} ${capacite}` : agentName;
          
          console.log(`üîç Ajout extincteur v√©rifi√©: ${displayText} - ${count} unit√©s`);
          
          html += `
            <tr>
              <td>Extincteur - ${displayText}</td>
              <td class="equipment-count">${count}</td>
            </tr>
          `;
        });
      } else {
        console.log('‚ùå Aucun extincteur v√©rifi√© √† afficher');
      }
      
      // √âCLAIRAGES par famille
      if (verifiedEquipment.eclairages.length > 0) {
        const eclairagesByFamily = groupEclairagesByFamily(verifiedEquipment.eclairages);
        Object.entries(eclairagesByFamily).forEach(([family, eclairages]) => {
          const count = eclairages.length;
          
          html += `
            <tr>
              <td>√âclairage de s√©curit√© - ${family}</td>
              <td class="equipment-count">${count}</td>
            </tr>
          `;
        });
      }
      
      // ALARMES par type
      if (verifiedEquipment.alarmes.length > 0) {
        const alarmesByType = groupAlarmesByType(verifiedEquipment.alarmes);
        Object.entries(alarmesByType).forEach(([type, alarmes]) => {
          const count = alarmes.length;
          
          html += `
            <tr>
              <td>Alarme - ${type}</td>
              <td class="equipment-count">${count}</td>
            </tr>
          `;
        });
      }
      
      // D√âSENFUMAGES par type d'√©quipement
      if (verifiedEquipment.desenfumages.length > 0) {
        const desenfumagesByType = groupDesenfumagesByType(verifiedEquipment.desenfumages);
        Object.entries(desenfumagesByType).forEach(([type, desenfumages]) => {
          const count = desenfumages.length;
          html += `
            <tr>
              <td>D√©senfumage - ${type}</td>
              <td class="equipment-count">${count}</td>
            </tr>
          `;
        });
      }
      
      // RIAS
      if (verifiedEquipment.rias.length > 0) {
        const count = verifiedEquipment.rias.length;
        
        html += `
          <tr>
            <td>RIA (Robinet d'Incendie Arm√©)</td>
            <td class="equipment-count">${count}</td>
          </tr>
        `;
      }
      
      // PLANS D'√âVACUATION
      if (verifiedEquipment.plans_evacuation.length > 0) {
        const count = verifiedEquipment.plans_evacuation.length;
        
        html += `
          <tr>
            <td>Plan d'√©vacuation</td>
            <td class="equipment-count">${count}</td>
          </tr>
        `;
      }
      
      // Si aucun √©quipement
      if (html === '') {
        html = '<tr><td colspan="2" style="text-align: center; color: #999; font-style: italic;">Aucun √©quipement enregistr√© pour ce site</td></tr>';
      }
      
      tbody.innerHTML = html;
    }
    
    // Fonctions de groupement par famille
    function groupExtincteursByAgent(extincteurs = equipmentData.extincteurs) {
      const groups = {};
      console.log('üîç Groupement extincteurs - donn√©es:', extincteurs);
      
      extincteurs.forEach(ext => {
        const agentId = ext.agent_ext || 'Autre';
        const capacite = ext.capa_ext || '';
        const groupKey = capacite ? `${agentId}_${capacite}` : `${agentId}`;
        console.log(`üîç Extincteur agent_ext: ${agentId}, capacit√©: ${capacite || 'Non sp√©cifi√©e'}`);
        if (!groups[groupKey]) groups[groupKey] = [];
        groups[groupKey].push(ext);
      });
      
      console.log('üîç Groupes finaux:', groups);
      return groups;
    }
    
    function groupEclairagesByFamily(eclairages = equipmentData.eclairages) {
      const groups = {};
      eclairages.forEach(ecl => {
        const family = ecl.family_ecl || 'Autre';
        if (!groups[family]) groups[family] = [];
        groups[family].push(ecl);
      });
      return groups;
    }
    
    function groupAlarmesByType(alarmes = equipmentData.alarmes) {
      const groups = {};
      alarmes.forEach(alarm => {
        const type = alarm.type_alarme || 'Autre';
        if (!groups[type]) groups[type] = [];
        groups[type].push(alarm);
      });
      return groups;
    }
    
    function groupDesenfumagesByType(desenfumages = equipmentData.desenfumages) {
      const groups = {};
      desenfumages.forEach(des => {
        // Utiliser le type d'√©quipement comme cl√© de groupement
        const type = des.equipement_desenfumage || 'Non sp√©cifi√©';
        if (!groups[type]) groups[type] = [];
        groups[type].push(des);
      });
      return groups;
    }
    
    // Fonction pour obtenir le nom long de l'agent extincteur
    function getAgentLongName(agentId) {
      // Mapping des agents extincteurs avec leurs noms longs
      const agentNames = {
        '1': 'Eau + Additif',
        '2': 'CO2',
        '3': 'Poudre',
        '4': 'Mousse',
        '5': 'Halon',
        '6': 'Eau pulv√©ris√©e',
        '7': 'Eau sous pression',
        '8': 'Autre'
      };
      
      return agentNames[agentId] || `Agent ${agentId}`;
    }
    

    
    // Mise √† jour de l'interface
    function updateInterface() {
      // Informations client
      document.getElementById('clientCode').textContent = clientData?.code_client || '--';
      document.getElementById('clientName').textContent = clientData?.nom_client || 'Client inconnu';
      document.getElementById('clientNameDetail').textContent = clientData?.nom_client || '--';
      
      // Informations site - Utilisation des bons champs
      document.getElementById('siteNumber').textContent = siteData?.num_site || '--';
      document.getElementById('siteName').textContent = siteData?.nom_site || 'Site inconnu';
      document.getElementById('siteNameDetail').textContent = siteData?.nom_site || '--';
      
      // Informations adresse - Utilisation du bon champ
      const address = siteData?.adr_site || '';
      const postalCode = siteData?.cp_site || '';
      const city = siteData?.ville_site || '';
      
      document.getElementById('siteAddress').textContent = address || '--';
      document.getElementById('siteCity').textContent = `${postalCode} ${city}`.trim() || '--';
      
      // Prochaine v√©rification (1 an apr√®s la date actuelle)
      const nextYear = new Date();
      nextYear.setFullYear(nextYear.getFullYear() + 1);
      document.getElementById('nextVerificationDate').textContent = nextYear.toLocaleDateString('fr-FR', { 
        month: 'long', 
        year: 'numeric' 
      });
    }
    
    // G√©n√©ration du PDF selon la structure demand√©e
    async function generatePDF() {
      try {
        document.getElementById('generateBtn').classList.add('loading');
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4',
          putOnlyUsedFonts: true,
          compress: true
        });
        
        // G√©n√©rer le num√©ro de bon si pas encore fait
        if (!numeroDeBon) {
          await generateBonNumber();
        }
        
        // Couleurs JPSI
        const jpsiRed = [155, 36, 35];
        const jpsiDark = [29, 29, 31];
        const jpsiGray = [107, 114, 128];
        
        // Variables de positionnement
        const pageWidth = 210;
        let currentY = 40; // Position par d√©faut
        
        // Fonction pour dessiner la grille de r√©f√©rence pr√©cise
        function drawGrid(doc) {
          doc.setDrawColor(200, 200, 200); // Gris clair
          doc.setLineWidth(0.1); // Ligne tr√®s fine
          
          // Grille verticale tous les 10mm (pr√©cision doubl√©e)
          for (let x = 10; x <= 200; x += 10) {
            doc.line(x, 0, x, 297);
          }
          
          // Grille horizontale tous les 10mm (pr√©cision doubl√©e)
          for (let y = 10; y <= 290; y += 10) {
            doc.line(0, y, 210, y);
          }
          
          // Num√©rotation des axes (tous les 20mm pour la lisibilit√©)
          doc.setFontSize(8);
          doc.setTextColor(150, 150, 150);
          
          // Num√©rotation horizontale (X)
          for (let x = 20; x <= 200; x += 20) {
            doc.text(x.toString(), x, 8);
          }
          
          // Num√©rotation verticale (Y)
          for (let y = 20; y <= 280; y += 20) {
            doc.text(y.toString(), 3, y);
          }
        }
        
        // Dessiner la grille de r√©f√©rence
        drawGrid(doc);
        
        // 0. Filigrane textuel simple (sans rotation)
        doc.setTextColor(220, 220, 220); // Gris tr√®s clair pour effet filigrane
        doc.setFontSize(72);
        doc.setFont('helvetica', 'bold');
        
        // Filigrane textuel centr√©
        const watermarkText = 'JPSI';
        const textWidth = doc.getTextWidth(watermarkText);
        const textX = (pageWidth - textWidth) / 2;
        const textY = 150; // Centre de la page
        
        // Texte filigrane simple
        doc.text(watermarkText, textX, textY);
        
        console.log('‚úÖ Filigrane JPSI ajout√© au PDF');
        
        // 1. Image d'en-t√™te en haut
        try {
          const img = new Image();
          img.src = 'img/entete.png';
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
          });
          
          // Calculer les dimensions pour que l'image s'adapte √† la largeur de la page
          const imgWidth = pageWidth - 20; // 10mm de marge de chaque c√¥t√©
          const imgHeight = (img.height * imgWidth) / img.width;
          
          doc.addImage(img, 'PNG', 10, 10, imgWidth, imgHeight);
          
          // Position de d√©part pour le contenu apr√®s l'image
          currentY = imgHeight + 20;
          
        } catch (error) {
          console.log('Image d\'en-t√™te non trouv√©e, utilisation d\'un titre de remplacement');
          doc.setFillColor(...jpsiRed);
          doc.rect(0, 0, 210, 30, 'F');
          doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
          doc.setFont('helvetica', 'bold');
          doc.text('JPSI - BON DE V√âRIFICATION', 105, 18, { align: 'center' });
          currentY = 40;
        }
        
        // Retour √† la couleur normale
        doc.setTextColor(...jpsiDark);
        
        // 2. Deux vignettes c√¥te √† c√¥te : Client et Site
        const vignetteWidth = 90;
        const margin = 10;
        const spaceBetween = 15; // R√©duit l'espace entre les vignettes
        const clientSiteY = 55; // Position Y fixe pour CLIENT et SITE
        
        // Calculer la hauteur n√©cessaire pour les vignettes (bas√© sur le contenu)
        const clientVignetteHeight = 30; // Hauteur fixe pour accommoder tout le contenu
        
        // Vignette Client (gauche) - Bordures arrondies noires avec fond transparent
        doc.setDrawColor(0, 0, 0); // Bordure noire
        doc.setLineWidth(0.2); // Bordure fine
        doc.roundedRect(margin, clientSiteY, vignetteWidth, clientVignetteHeight, 3, 3, 'S'); // Bordures arrondies
        
        // Titre CLIENT avec soulignement
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0); // Texte noir
        doc.text('CLIENT', margin + vignetteWidth/2, clientSiteY + 5, { align: 'center' });
        
        // Soulignement du titre CLIENT - juste sous le mot
        const clientTitleWidth = doc.getTextWidth('CLIENT');
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.3);
        doc.line(margin + vignetteWidth/2 - clientTitleWidth/2, clientSiteY + 6.5, margin + vignetteWidth/2 + clientTitleWidth/2, clientSiteY + 6.5);
        
        // Contenu client complet avec interlignes r√©duits
        doc.setTextColor(0, 0, 0); // Texte noir
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        const clientName = document.getElementById('clientName').textContent;
        doc.text(clientName, margin + 4, clientSiteY + 11);
        
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        const clientAddress = clientData?.adr_client || '';
        const clientCodePostal = clientData?.cp_client || '';
        const clientVille = clientData?.ville_client || '';
        const clientSiren = clientData?.siren_client || '';
        
        doc.text(clientAddress, margin + 4, clientSiteY + 16);
        doc.text(`${clientCodePostal} - ${clientVille}`, margin + 4, clientSiteY + 21);
        doc.text(`SIREN: ${clientSiren}`, margin + 4, clientSiteY + 26);
        
        // Vignette Site (droite) - Bordures arrondies noires avec fond transparent
        const siteX = 110; // Position X fixe pour SITE
        doc.setDrawColor(0, 0, 0); // Bordure noire
        doc.setLineWidth(0.2); // Bordure fine
        doc.roundedRect(siteX, clientSiteY, vignetteWidth, clientVignetteHeight, 3, 3, 'S'); // Bordures arrondies
        
        // Titre SITE avec soulignement
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0); // Texte noir
        doc.text('SITE', siteX + vignetteWidth/2, clientSiteY + 5, { align: 'center' });
        
        // Soulignement du titre SITE - juste sous le mot
        const siteTitleWidth = doc.getTextWidth('SITE');
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.3);
        doc.line(siteX + vignetteWidth/2 - siteTitleWidth/2, clientSiteY + 6.5, siteX + vignetteWidth/2 + siteTitleWidth/2, clientSiteY + 6.5);
        
        // Contenu site complet avec interlignes r√©duits
        doc.setTextColor(0, 0, 0); // Texte noir
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        const siteNumero = siteData?.num_site || '';
        const siteName = siteData?.nom_site || document.getElementById('siteName').textContent;
        doc.text(`${siteNumero} - ${siteName}`, siteX + 4, clientSiteY + 11);
        
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        const siteAddress = siteData?.adr_site || '';
        const siteCodePostal = siteData?.cp_site || '';
        const siteVille = siteData?.ville_site || '';
        
        doc.text(siteAddress, siteX + 4, clientSiteY + 16);
        doc.text(`${siteCodePostal} - ${siteVille}`, siteX + 4, clientSiteY + 21);
        
        // 3. Vignette avec num√©ro de bon et date - Bordures arrondies noires avec fond transparent
        const bonY = 90; // Position Y fixe pour le bon de v√©rification
        const bonHeight = 10; // Hauteur r√©duite √† 10mm
        const currentDate = new Date().toLocaleDateString('fr-FR');
        const bonText = `Bon de v√©rification n¬∞${numeroDeBon} du ${currentDate}`;
        
        doc.setDrawColor(0, 0, 0); // Bordure noire
        doc.setLineWidth(0.2); // Bordure fine
        doc.roundedRect(margin, bonY, pageWidth - 2*margin, bonHeight, 3, 3, 'S'); // Bordures arrondies
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0); // Texte noir
        // Centrage parfait horizontal et vertical dans la vignette
        doc.text(bonText, pageWidth/2, bonY + bonHeight/2 + 2, { align: 'center' });
        
        // 4. Texte de pr√©sentation des v√©rifications
        const presentationY = 108; // Position Y fixe pour le texte √† Y=108
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        const presentationText = "Suite √† notre v√©rification, nous vous prions de trouver ci-joint le r√©sum√© des v√©rifications r√©alis√©es";
        doc.text(presentationText, pageWidth/2, presentationY, { align: 'center' });
        
        // Pr√©parer les donn√©es du tableau simplifi√©
        const tableData = [];
        tableData.push(['Type d\'appareils', 'Quantit√©s']);
        
        // Ajouter les extincteurs
        if (equipmentData.extincteurs.length > 0) {
          const extincteursByAgent = groupExtincteursByAgent();
          Object.entries(extincteursByAgent).forEach(([groupKey, extincteurs]) => {
            const firstExtincteur = extincteurs[0];
            const agentName = getAgentLongName(firstExtincteur.agent_ext);
            const capacite = firstExtincteur.capa_ext || '';
            const count = extincteurs.length;
            const displayText = capacite ? `${agentName} ${capacite}` : agentName;
            tableData.push([`Extincteur - ${displayText}`, count.toString()]);
          });
        }
        
        // Ajouter les √©clairages
        if (equipmentData.eclairages.length > 0) {
          const eclairagesByFamily = groupEclairagesByFamily();
          Object.entries(eclairagesByFamily).forEach(([family, eclairages]) => {
            const count = eclairages.length;
            tableData.push([`√âclairage de s√©curit√© - ${family}`, count.toString()]);
          });
        }
        
        // Ajouter les alarmes
        if (equipmentData.alarmes.length > 0) {
          const alarmesByType = groupAlarmesByType();
          Object.entries(alarmesByType).forEach(([type, alarmes]) => {
            const count = alarmes.length;
            tableData.push([`Alarme - ${type}`, count.toString()]);
          });
        }
        
        // Ajouter les d√©senfumages par type d'√©quipement
        if (equipmentData.desenfumages.length > 0) {
          const desenfumagesByType = groupDesenfumagesByType();
          Object.entries(desenfumagesByType).forEach(([type, desenfumages]) => {
            const count = desenfumages.length;
            tableData.push([`D√©senfumage - ${type}`, count.toString()]);
          });
        }
        
        // Ajouter les RIAS
        if (equipmentData.rias.length > 0) {
          const count = equipmentData.rias.length;
          tableData.push(['RIA (Robinet d\'Incendie Arm√©)', count.toString()]);
        }
        
        // Ajouter les plans d'√©vacuation
        if (equipmentData.plans_evacuation.length > 0) {
          const count = equipmentData.plans_evacuation.length;
          tableData.push(['Plan d\'√©vacuation', count.toString()]);
        }
        
        // G√©n√©rer le tableau dans l'esprit des vignettes
        if (tableData.length > 1) {
          // Cr√©er un tableau unifi√© avec des bordures fines
          const tableY = 110; // Position Y fixe pour commencer le tableau √† Y=110
          const tableWidth = pageWidth - 2*margin;
          const rowHeight = 8; // Hauteur adapt√©e aux caract√®res
          const headerHeight = 10; // Hauteur pour l'en-t√™te
          const bodyRows = tableData.slice(1);
          const totalBodyHeight = bodyRows.length * rowHeight;
          const totalTableHeight = headerHeight + totalBodyHeight;
          
          // Tableau unifi√© (en-t√™te + corps) avec fond transparent
          doc.setDrawColor(0, 0, 0); // Bordure noire
          doc.setLineWidth(0.2); // Bordure fine
          doc.roundedRect(margin, tableY, tableWidth, totalTableHeight, 2, 2, 'S');
          
          // Ligne de s√©paration en-t√™te/corps
          doc.line(margin, tableY + headerHeight, margin + tableWidth, tableY + headerHeight);
          
          // Ligne verticale s√©parant les colonnes
          doc.line(margin + 140, tableY, margin + 140, tableY + totalTableHeight);
          
          // Lignes horizontales entre les lignes du corps
          for (let i = 1; i < bodyRows.length; i++) {
            const lineY = tableY + headerHeight + (i * rowHeight);
            doc.line(margin, lineY, margin + tableWidth, lineY);
          }
          
          // Texte de l'en-t√™te
          doc.setFontSize(10);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(0, 0, 0);
          doc.text('Type d\'appareils', margin + 70, tableY + 6, { align: 'center' });
          doc.text('Quantit√©s', 175, tableY + 6, { align: 'center' });
          
          // Contenu des lignes
          doc.setFontSize(9);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(0, 0, 0);
          
          bodyRows.forEach((row, index) => {
            const rowY = tableY + headerHeight + (index * rowHeight) + 5;
            doc.text(row[0], margin + 5, rowY); // Type d'appareil
            doc.text(row[1], 175, rowY, { align: 'center' }); // Quantit√© centr√©e √† X=175
          });
        }
        

        
        // 6. Vignette Observations critiques
        const obsVignetteHeight = 45; // Hauteur de la vignette observations (augment√©e de 10mm)
        const obsVignetteY = 235 - obsVignetteHeight; // Position Y pour que la vignette finisse √† Y=235
        
        // Vignette Observations - Bordures arrondies noires avec fond transparent
        doc.setDrawColor(0, 0, 0); // Bordure noire
        doc.setLineWidth(0.2); // Bordure fine
        doc.roundedRect(margin, obsVignetteY, pageWidth - 2*margin, obsVignetteHeight, 3, 3, 'S'); // Bordures arrondies
        
        // Titre Observations
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0); // Texte noir
        doc.text('OBSERVATIONS', pageWidth/2, obsVignetteY + 7, { align: 'center' });
        
        // Ligne de s√©paration sous le titre
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.3);
        doc.line(margin + 5, obsVignetteY + 10, pageWidth - margin - 5, obsVignetteY + 10);
        
        // Contenu des observations - Utilise le champ de saisie final
        const finalObservationsTextarea = document.getElementById('finalObservationsText');
        const observationsText = finalObservationsTextarea ? finalObservationsTextarea.value.trim() : '';
        
        if (observationsText && observationsText !== '') {
          // Il y a des observations
          doc.setFontSize(9);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(0, 0, 0);
          
          let obsY = obsVignetteY + 18;
          
          // Diviser le texte en lignes pour l'affichage
          const maxLineLength = 80; // Caract√®res par ligne
          const lines = [];
          let currentLine = '';
          
          observationsText.split(' ').forEach(word => {
            if ((currentLine + ' ' + word).length <= maxLineLength) {
              currentLine += (currentLine ? ' ' : '') + word;
            } else {
              if (currentLine) lines.push(currentLine);
              currentLine = word;
            }
          });
          if (currentLine) lines.push(currentLine);
          
          // Afficher les lignes d'observations
          lines.forEach((line, index) => {
            if (obsY + (index * 5) < obsVignetteY + obsVignetteHeight - 5) {
              doc.text(line, margin + 5, obsY + (index * 5));
            }
          });
        } else {
          // Aucune observation
          doc.setFontSize(10);
          doc.setFont('helvetica', 'italic');
          doc.setTextColor(128, 128, 128); // Gris
          doc.text('Aucune observation', pageWidth/2, obsVignetteY + 23, { align: 'center' });
        }
        
        // 7. Signatures : Client √† droite, Technicien √† gauche
        const signatureWidth = 80; // Largeur √† 80mm
        const signatureHeight = 40; // Hauteur pour le texte + signature
        const signatureY = obsVignetteY + obsVignetteHeight; // Position Y adapt√©e √† la vignette d'observations (remont√©e de 5mm)
        
        // Client commence √† X=15 et finit √† X=95
        const clientX = 15;
        const clientY = signatureY;
        
        // Technicien finit √† X=190, donc commence √† X=110
        const technicianX = 110;
        const technicianY = signatureY;
        
        // Zone signature Technicien (gauche) - sans bordure avec fond transparent
        
        // Titre technicien
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('Nom et signature du technicien', technicianX + signatureWidth/2, technicianY + 5, { align: 'center' });
        
        // Texte technicien centr√© sur 70mm
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        const techText = "Je reconnais avoir inform√© le client des op√©rations de maintenance faites ou √† effectuer, ainsi que des travaux √† r√©aliser.";
        doc.text(techText, technicianX + signatureWidth/2, technicianY + 9, { align: 'center', maxWidth: 70 });
        
        // Zone signature Client (droite) - sans bordure avec fond transparent
        
        // Titre client
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('Nom et signature du client', clientX + signatureWidth/2, clientY + 5, { align: 'center' });
        
        // Texte client centr√© sur 75mm
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        const clientText = "Je reconnais l'exactitude des quantitatifs indiqu√©s, des travaux r√©alis√©s, et prend connaissance des travaux √† r√©aliser.";
        doc.text(clientText, clientX + signatureWidth/2, clientY + 9, { align: 'center', maxWidth: 75 });
        
        // Ajouter les signatures si elles existent
        const clientCanvas = document.getElementById('clientSignature');
        const technicianCanvas = document.getElementById('technicianSignature');
        
        if (hasTechnicianSignature && technicianCanvas) {
          try {
            const technicianSignatureData = technicianCanvas.toDataURL('image/png');
            doc.addImage(technicianSignatureData, 'PNG', technicianX + 2, technicianY + 20, signatureWidth - 4, 18);
          } catch (error) {
            console.log('Signature technicien non disponible pour le PDF');
          }
        }
        
        if (hasClientSignature && clientCanvas) {
          try {
            const clientSignatureData = clientCanvas.toDataURL('image/png');
            doc.addImage(clientSignatureData, 'PNG', clientX + 2, clientY + 20, signatureWidth - 4, 18);
          } catch (error) {
            console.log('Signature client non disponible pour le PDF');
          }
        }
        
        // 7. Informations l√©gales en bas de page
        const legalY = 285; // Position Y fixe pour les informations l√©gales
        
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(100, 100, 100); // Gris fonc√© pour les informations l√©gales
        
                        // Ligne 1
                doc.text('Entreprise individuelle ‚Äì SIRET 794 660 365 00014 ‚Äì Code APE 4778C ‚Äì TVA non applicable selon l\'article 293-B du Code G√©n√©ral des Imp√¥ts', pageWidth/2, legalY, { align: 'center' });
                
                // Ligne 2
                doc.text('Immatricul√© au r√©pertoire des m√©tiers sous le num√©ro 794 660 365 RM 54 aupr√®s de la Chambre des M√©tiers de Laxou', pageWidth/2, legalY + 3, { align: 'center' });
                
                // Ligne 3
                doc.text('Immatricul√© au Registre du Commerce et des Soci√©t√©s sous le num√©ro 794 660 365 R.C.S. Nancy', pageWidth/2, legalY + 6, { align: 'center' });
                
                // Ligne 4
                doc.text('Voir conditions g√©n√©rales de vente', pageWidth/2, legalY + 9, { align: 'center' });
        
        // Sauvegarder le PDF avec le format obligatoire
        const nomClient = cleanFileName(clientData?.nom_client || 'Client_Inconnu');
        const nomSite = cleanFileName(siteData?.nom || 'Site_Inconnu');
        const fileName = `${numeroDeBon} - ${nomClient} - ${nomSite}.pdf`;
        
        console.log('üìÑ Nom du fichier PDF:', fileName);
        doc.save(fileName);
        
        document.getElementById('generateBtn').classList.remove('loading');
        
      } catch (error) {
        console.error('Erreur lors de la g√©n√©ration du PDF:', error);
        alert('Erreur lors de la g√©n√©ration du PDF');
        document.getElementById('generateBtn').classList.remove('loading');
      }
    }
    
    // Fonction pour g√©n√©rer le PDF d√©taill√©
    async function generatePDF2() {
      try {
        document.getElementById('generateBtn2').classList.add('loading');
        
        // ‚úÖ CORRECTION MINIMALE : Alias de compatibilit√© pour √©viter l'erreur nomClient
        const urlParams = new URLSearchParams(window.location.search);
        const clientName = urlParams.get('clientName') || 'Client_Inconnu';
        const siteName = urlParams.get('siteName') || 'Site_Inconnu';
        const nomClient = clientName;
        const nomSite = siteName;
        
        // R√©cup√©rer les √©quipements v√©rifi√©s et observations de cette intervention
        const verifiedEquipment = await getVerifiedEquipment();
        const verifiedObservations = await getVerifiedObservations();
        
        console.log('üîç G√©n√©ration PDF avec √©quipements v√©rifi√©s:', verifiedEquipment);
        console.log('üîç G√©n√©ration PDF avec observations v√©rifi√©es:', verifiedObservations);
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4',
          putOnlyUsedFonts: true,
          compress: true
        });
        
        // 0. Filigrane au milieu de la page
        try {
          const filigraneImg = new Image();
          filigraneImg.src = 'img/filigran.png';
          await new Promise((resolve, reject) => {
            filigraneImg.onload = resolve;
            filigraneImg.onerror = reject;
          });
          
          // Position au centre de la page A4 (210mm x 297mm)
          const pageWidth = 210;
          const pageHeight = 297;
          const filigraneWidth = filigraneImg.width * 0.26 * 0.6; // Conversion px vers mm et r√©duction 40%
          const filigraneHeight = filigraneImg.height * 0.26 * 0.6;
          
          // Centrer l'image (d√©cal√© de 7mm vers le bas)
          const filigraneX = (pageWidth - filigraneWidth) / 2;
          const filigraneY = (pageHeight - filigraneHeight) / 2 + 7;
          
          // Ajouter en mode filigrane (transparent)
          doc.addImage(filigraneImg, 'PNG', filigraneX, filigraneY, filigraneWidth, filigraneHeight, undefined, 'FAST', 0);
        } catch (error) {
          console.log('Image filigran.png non trouv√©e');
        }
        
        // 1. logobon.png √† X=18mm, Y=7mm, r√©duction de 40%
        try {
          const img = new Image();
          img.src = 'img/logobon.png';
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
          });
          const widthMm = 411 * 0.26 * 0.6 * 1.1 * 1.1; // ‚âà 77mm (agrandi de 10% + 10%)
          const heightMm = 288 * 0.26 * 0.6 * 1.1 * 1.1; // ‚âà 55mm (agrandi de 10% + 10%)
          doc.addImage(img, 'PNG', 13, 7, widthMm, heightMm);
        } catch (error) {
          console.log('Logo logobon.png non trouv√©');
        }
        
        // 2. coordo.png √† X=90mm, Y=15mm, r√©duction de 30%
        try {
          const coordoImg = new Image();
          coordoImg.src = 'img/coordo.png';
          await new Promise((resolve, reject) => {
            coordoImg.onload = resolve;
            coordoImg.onerror = reject;
          });
          const coordoWidth = coordoImg.width * 0.26 * 0.7 * 0.7 * 0.85; // R√©duction de 30% + 30% + 15% suppl√©mentaire
          const coordoHeight = coordoImg.height * 0.26 * 0.7 * 0.7 * 0.85; // R√©duction de 30% + 30% + 15% suppl√©mentaire
          doc.addImage(coordoImg, 'PNG', 112, 15, coordoWidth, coordoHeight);
        } catch (error) {
          console.log('Image coordo.png non trouv√©e');
        }
        
        // 3. Deux vignettes transparentes √©quilibr√©es
        const vignetteWidth = 90; // Largeur r√©duite de 95 √† 90mm (-5mm)
        const vignetteHeight = 45; // Hauteur adapt√©e pour 7 lignes de contenu
        const margin = 15; // Marge depuis les bords
        const spaceBetween = 20; // Espace entre les vignettes
        
        // Position Y pour la vignette SITE (apr√®s les images)
        const vignetteY = 42;
        
        // Vignette SITE (s'ach√®ve √† 10mm du bord droit)
        const siteX = 210 - vignetteWidth - 10; // Position pour finir √† 10mm du bord droit
        doc.setDrawColor(0, 0, 0); // Bordure noire
        doc.setLineWidth(0.1); // Bordure tr√®s fine
        doc.roundedRect(siteX, vignetteY, vignetteWidth, vignetteHeight, 1, 1, 'S'); // Bordure arrondie r√©duite
        
        // Vignette Date d'√©tablissement (align√©e avec la vignette SITE)
        const dateVignetteHeight = 20; // Hauteur de la vignette date
        const dateVignetteX = 10; // Commence √† X=10mm
        const dateVignetteWidth = siteX - dateVignetteX - 10; // Largeur pour finir √† 10mm de la vignette SITE
        const dateVignetteY = vignetteY + vignetteHeight - dateVignetteHeight; // Align√©e en bas avec la vignette SITE
        
        doc.setDrawColor(0, 0, 0); // Bordure noire
        doc.setLineWidth(0.1); // Bordure tr√®s fine
        doc.roundedRect(dateVignetteX, dateVignetteY, dateVignetteWidth, dateVignetteHeight, 1, 1, 'S'); // Bordure arrondie r√©duite
        
        // Titre "DATE D'√âTABLISSEMENT DU PR√âSENT RAPPORT" (10, normal, majuscule, centr√©, une ligne)
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text('DATE D\'√âTABLISSEMENT DU PR√âSENT RAPPORT', dateVignetteX + dateVignetteWidth/2, dateVignetteY + 8, { align: 'center' });
        
        // Date du jour (11, gras, centr√©, format long)
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        const currentDate = new Date().toLocaleDateString('fr-FR', {
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });
        doc.text(currentDate, dateVignetteX + dateVignetteWidth/2, dateVignetteY + 16, { align: 'center' });
        
        // Titre "Code Client:" dans l'√©l√©ment du haut
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('Code Client:', siteX + 4, vignetteY + 7);
        
        // Code client √† c√¥t√© du titre
        const clientCode = clientData?.code_client || '';
        const titleWidth = doc.getTextWidth('Code Client:');
        doc.text(clientCode, siteX + 4 + titleWidth + 2, vignetteY + 7);
        
        // Ligne de s√©paration sous le titre (plus proche du titre)
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.1);
        doc.line(siteX + 2, vignetteY + 10, siteX + vignetteWidth - 2, vignetteY + 10);
        
        // Contenu de la vignette SITE
        // Ligne 1 : NomClient (11, gras)
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        const siteClientName = clientData?.nom_client || '';
        doc.text(siteClientName, siteX + 4, vignetteY + 16);
        
        // Ligne 2 : NumSite - NomSite (10, gras, d√©cal√©)
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        const numSite = siteData?.num_site || '';
        // nomSite d√©j√† d√©clar√© plus haut
        // Formater le num√©ro du site sur 3 chiffres avec des z√©ros en t√™te
        const formattedNumSite = numSite.toString().padStart(3, '0');
        doc.text(`        ${formattedNumSite} - ${nomSite}`, siteX + 4, vignetteY + 20); // 4 tabulations
        
        // Ligne 3 : adrSite (9, normal, d√©cal√©)
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        const adrSite = siteData?.adr_site || '';
        doc.text(`        ${adrSite}`, siteX + 4, vignetteY + 24); // 4 tabulations
        
        // Ligne 4 : cpSite - villeSite (9, normal, d√©cal√©)
        const cpSite = siteData?.cp_site || '';
        const villeSite = siteData?.ville_site || '';
        doc.text(`        ${cpSite} - ${villeSite}`, siteX + 4, vignetteY + 28); // 4 tabulations
        
        // Ligne 5 : adrClient (10, normal)
        doc.setFontSize(10);
        const adrClient = clientData?.adr_client || '';
        doc.text(adrClient, siteX + 4, vignetteY + 32);
        
        // Ligne 6 : cpClient - villeClient (10, normal)
        const cpClient = clientData?.cp_client || '';
        const villeClient = clientData?.ville_client || '';
        doc.text(`${cpClient} - ${villeClient}`, siteX + 4, vignetteY + 36);
        
        // Ligne 7 : sirenClient (8, normal)
        doc.setFontSize(8);
        const sirenClient = clientData?.siren_client || '';
        doc.text(`SIREN: ${sirenClient}`, siteX + 4, vignetteY + 40);
        
        // Vignette "BON DE V√âRIFICATION N¬∞" (toute la largeur)
        const bonVignetteY = vignetteY + vignetteHeight + 5; // 5mm en dessous des vignettes existantes
        const bonVignetteX = 10; // 10mm de marge √† gauche
        const bonVignetteWidth = 210 - 20; // Toute la largeur moins 10mm de chaque c√¥t√©
        const bonVignetteHeight = 10; // Hauteur r√©duite √† 10mm
        
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.1);
        doc.roundedRect(bonVignetteX, bonVignetteY, bonVignetteWidth, bonVignetteHeight, 1, 1, 'S');
        
        // Titre "BON DE V√âRIFICATION N¬∞" avec num√©ro (14, gras, centr√©)
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        const bonNumber = numeroDeBon || document.getElementById('bonNumber')?.textContent || '001';
        doc.text(`BON DE V√âRIFICATION N¬∞ ${bonNumber}`, bonVignetteX + bonVignetteWidth/2, bonVignetteY + 7, { align: 'center' });
        
        // Texte introductif (6mm en dessous de la vignette BON DE V√âRIFICATION)
        const introTextY = bonVignetteY + bonVignetteHeight + 6;
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text('Suite √† notre v√©rification, nous vous prions de trouver ci-joint le r√©sum√© des v√©rifications r√©alis√©es', 105, introTextY, { align: 'center' });
        
        // Tableau des √©quipements contr√¥l√©s (2mm en dessous du texte introductif)
        const tableauY = introTextY + 2;
        const tableauX = 10; // Marge gauche
        const tableauWidth = 190; // Largeur totale (210 - 20mm de marge)
        const colonneTypeWidth = 140; // Largeur colonne "Type d'appareils"
        const colonneQteWidth = 50; // Largeur colonne "Quantit√©"
        const ligneHeight = 5.5; // Hauteur de chaque ligne (r√©duite √† 5.5mm)
        
        // En-t√™te du tableau
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        
        // Bordure de l'en-t√™te
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.2);
        doc.rect(tableauX, tableauY, tableauWidth, ligneHeight);
        doc.line(tableauX + colonneTypeWidth, tableauY, tableauX + colonneTypeWidth, tableauY + ligneHeight);
        
        // Bordures verticales de l'en-t√™te
        doc.line(tableauX, tableauY, tableauX, tableauY + ligneHeight);
        doc.line(tableauX + tableauWidth, tableauY, tableauX + tableauWidth, tableauY + ligneHeight);
        
        // Texte de l'en-t√™te (centr√© horizontalement et verticalement)
        doc.text('Type d\'appareils', tableauX + colonneTypeWidth/2, tableauY + 4.5, { align: 'center' });
        doc.text('Quantit√©', tableauX + colonneTypeWidth + colonneQteWidth/2, tableauY + 4.5, { align: 'center' });
        
        // 12 lignes pour les √©quipements (√† remplir dynamiquement)
        let totalEquipements = 0;
        for (let i = 0; i < 12; i++) {
          const ligneY = tableauY + ligneHeight + (i * ligneHeight);
          
          // Bordure de la ligne
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.1);
          doc.line(tableauX, ligneY, tableauX + tableauWidth, ligneY);
          doc.line(tableauX + colonneTypeWidth, ligneY, tableauX + colonneTypeWidth, ligneY + ligneHeight);
          
          // Bordures verticales de la ligne
          doc.line(tableauX, ligneY, tableauX, ligneY + ligneHeight);
          doc.line(tableauX + tableauWidth, ligneY, tableauX + tableauWidth, ligneY + ligneHeight);
          
          // Texte de la ligne (exemples)
          doc.setFontSize(10);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(0, 0, 0);
          
          // R√©cup√©ration des vraies donn√©es d'√©quipements
          let equipements = [];
          let quantites = [];
          
          // EXTINCTEURS par agent et capacit√©
          if (verifiedEquipment.extincteurs && verifiedEquipment.extincteurs.length > 0) {
            const extincteursByAgent = {};
            verifiedEquipment.extincteurs.forEach(ext => {
              const agentId = ext.agent_ext || 'Autre';
              const capacite = ext.capa_ext || '';
              const groupKey = capacite ? `${agentId}_${capacite}` : `${agentId}`;
              if (!extincteursByAgent[groupKey]) extincteursByAgent[groupKey] = [];
              extincteursByAgent[groupKey].push(ext);
            });
            
            Object.entries(extincteursByAgent).forEach(([groupKey, extincteurs]) => {
              const firstExtincteur = extincteurs[0];
              const agentName = firstExtincteur.agent_long_name || `Agent ${firstExtincteur.agent_ext}`;
              const capacite = firstExtincteur.capa_ext || '';
              const displayText = capacite ? `${agentName} ${capacite}` : agentName;
              equipements.push(`Extincteur - ${displayText}`);
              quantites.push(extincteurs.length);
            });
          }
          
          // √âCLAIRAGES par famille
          if (verifiedEquipment.eclairages && verifiedEquipment.eclairages.length > 0) {
            const eclairagesByFamily = {};
            verifiedEquipment.eclairages.forEach(ecl => {
              const family = ecl.family_ecl || 'Autre';
              if (!eclairagesByFamily[family]) eclairagesByFamily[family] = [];
              eclairagesByFamily[family].push(ecl);
            });
            
            Object.entries(eclairagesByFamily).forEach(([family, eclairages]) => {
              equipements.push(`√âclairage de s√©curit√© - ${family}`);
              quantites.push(eclairages.length);
            });
          }
          
          // ALARMES par type
          if (verifiedEquipment.alarmes && verifiedEquipment.alarmes.length > 0) {
            const alarmesByType = {};
            verifiedEquipment.alarmes.forEach(alarm => {
              const type = alarm.type_alarme || 'Autre';
              if (!alarmesByType[type]) alarmesByType[type] = [];
              alarmesByType[type].push(alarm);
            });
            
            Object.entries(alarmesByType).forEach(([type, alarmes]) => {
              equipements.push(`Alarme incendie - ${type}`);
              quantites.push(alarmes.length);
            });
          }
          
          // D√âSENFUMAGES par type d'√©quipement
          if (verifiedEquipment.desenfumages && verifiedEquipment.desenfumages.length > 0) {
            const desenfumagesByType = groupDesenfumagesByType(verifiedEquipment.desenfumages);
            Object.entries(desenfumagesByType).forEach(([type, desenfumages]) => {
              const count = desenfumages.length;
              equipements.push(`D√©senfumage - ${type}`);
              quantites.push(count);
            });
          }
          
          // RIAS
          if (verifiedEquipment.rias && verifiedEquipment.rias.length > 0) {
            equipements.push('RIA - Robinet d\'incendie arm√©');
            quantites.push(verifiedEquipment.rias.length);
          }
          
          // PLANS D'√âVACUATION
          if (verifiedEquipment.plans_evacuation && verifiedEquipment.plans_evacuation.length > 0) {
            equipements.push('Plan d\'√©vacuation');
            quantites.push(verifiedEquipment.plans_evacuation.length);
          }
          
          // Affichage des donn√©es r√©elles
          if (i < equipements.length) {
            doc.text(equipements[i], tableauX + 5, ligneY + 4.5);
            doc.text(quantites[i].toString(), tableauX + colonneTypeWidth + colonneQteWidth/2, ligneY + 4.5, { align: 'center' });
            totalEquipements += quantites[i];
          }
        }
        
        // Ligne de total
        const totalLigneY = tableauY + ligneHeight + (12 * ligneHeight);
        
        // Bordure de la ligne total
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.2);
        doc.line(tableauX, totalLigneY, tableauX + tableauWidth, totalLigneY);
        doc.line(tableauX + colonneTypeWidth, totalLigneY, tableauX + colonneTypeWidth, totalLigneY + ligneHeight);
        
        // Bordures verticales de la ligne total
        doc.line(tableauX, totalLigneY, tableauX, totalLigneY + ligneHeight);
        doc.line(tableauX + tableauWidth, totalLigneY, tableauX + tableauWidth, totalLigneY + ligneHeight);
        
        // Bordure inf√©rieure du tableau
        doc.line(tableauX, totalLigneY + ligneHeight, tableauX + tableauWidth, totalLigneY + ligneHeight);
        
        // Texte du total (centr√© horizontalement et verticalement)
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('TOTAL', tableauX + colonneTypeWidth/2, totalLigneY + 4.5, { align: 'center' });
        doc.text(totalEquipements.toString(), tableauX + colonneTypeWidth + colonneQteWidth/2, totalLigneY + 4.5, { align: 'center' });
        
        // Vignette Observations (5mm en dessous du tableau)
        const obsVignetteY = totalLigneY + ligneHeight + 5; // 5mm en dessous du tableau
        const obsVignetteX = 10; // M√™me marge que les autres vignettes
        const obsVignetteWidth = 190; // M√™me largeur que le tableau
        const obsVignetteHeight = 40; // Hauteur pour les observations (augment√©e de 10mm)
        
        // Bordure de la vignette Observations
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.1);
        doc.roundedRect(obsVignetteX, obsVignetteY, obsVignetteWidth, obsVignetteHeight, 1, 1, 'S');
        
        // Titre "Observations" dans l'√©l√©ment du haut (centr√©)
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('Observations', obsVignetteX + obsVignetteWidth/2, obsVignetteY + 7, { align: 'center' });
        
        // Ligne de s√©paration sous le titre
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.1);
        doc.line(obsVignetteX + 2, obsVignetteY + 10, obsVignetteX + obsVignetteWidth - 2, obsVignetteY + 10);
        
        // Contenu des observations des √©quipements contr√¥l√©s
        let obsY = obsVignetteY + 15; // Position de d√©part pour les observations
        const lineHeight = 5; // Hauteur de ligne pour les observations
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        
        // Utiliser les observations v√©rifi√©es de cette intervention
        let observations = [];
        
        // Utiliser verifiedObservations qui contient d√©j√† les observations de cette intervention
        verifiedObservations.forEach(obs => {
          observations.push({
            type: obs.type,
            numero: obs.numero,
            observation: obs.observation
          });
        });
        
        // Regrouper les observations par type d'√©quipement et par probl√®me
        const groupedObservations = {};
        
        observations.forEach(obs => {
          if (!groupedObservations[obs.type]) {
            groupedObservations[obs.type] = {};
          }
          
          // Normaliser l'observation pour le regroupement
          const normalizedObs = obs.observation.toLowerCase().trim();
          
          if (!groupedObservations[obs.type][normalizedObs]) {
            groupedObservations[obs.type][normalizedObs] = {
              numeros: [],
              originalText: obs.observation
            };
          }
          
          groupedObservations[obs.type][normalizedObs].numeros.push(obs.numero);
        });
        
        // Utiliser le contenu du champ de saisie final des observations
        const finalObservationsTextarea = document.getElementById('finalObservationsText');
        const observationsText = finalObservationsTextarea ? finalObservationsTextarea.value.trim() : '';
        
        if (observationsText && observationsText !== '') {
          // Diviser le texte en lignes pour l'affichage
          const lines = observationsText.split('\n').filter(line => line.trim() !== '');
          
          // Afficher les observations avec gestion de l'espace
          lines.forEach((line, index) => {
            const yPosition = obsY + (index * lineHeight);
            if (yPosition < obsVignetteY + obsVignetteHeight - 5) {
              // Tronquer le texte si n√©cessaire pour √©viter le d√©bordement
              const maxTextWidth = obsVignetteWidth - 8; // 4mm de marge de chaque c√¥t√©
              const truncatedLine = doc.splitTextToSize(line, maxTextWidth);
              
              if (truncatedLine.length === 1) {
                doc.text(truncatedLine[0], obsVignetteX + 4, yPosition);
              } else {
                // Si le texte est tronqu√© sur plusieurs lignes, ajuster l'espacement
                truncatedLine.forEach((lineText, lineIndex) => {
                  const adjustedY = yPosition + (lineIndex * lineHeight);
                  if (adjustedY < obsVignetteY + obsVignetteHeight - 5) {
                    doc.text(lineText, obsVignetteX + 4, adjustedY);
                  }
                });
              }
            }
          });
        } else {
          // Aucune observation
          doc.text('Aucune observation', obsVignetteX + obsVignetteWidth/2, obsVignetteY + obsVignetteHeight/2, { align: 'center' });
        }
        

        
        // Espaces de signatures (coll√©es √† la vignette Observations)
        const signatureY = obsVignetteY + obsVignetteHeight;
        const signatureWidth = 75; // Largeur augment√©e de 70 √† 75mm (+5mm)
        
        // Client (gauche) - commence √† 10mm du bord gauche
        const clientX = 10;
        const clientY = signatureY;
        
        // Titre client
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('Nom et signature du client', clientX + signatureWidth/2, clientY + 5, { align: 'center' });
        
        // Texte client centr√© sur 70mm
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        const clientText = "Je reconnais l'exactitude des quantitatifs indiqu√©s, des travaux r√©alis√©s, et prend connaissance des travaux √† r√©aliser.";
        doc.text(clientText, clientX + signatureWidth/2, clientY + 9, { align: 'center', maxWidth: 70 });
        
        // Nom du signataire client
        const clientNameInput = document.getElementById('clientNameInput');
        const clientNameValue = clientNameInput ? clientNameInput.value.trim() : '';
        if (clientNameValue) {
          doc.setFontSize(8);
          doc.setFont('courier', 'normal');
          doc.setTextColor(0, 0, 0);
          doc.text(clientNameValue, clientX + 2, clientY + 17);
        }
        
        // Technicien (droite) - finit √† 10mm du bord droit
        const technicianX = 210 - signatureWidth - 10; // 210 - 75 - 10 = 125mm
        const technicianY = signatureY;
        
        // Titre technicien
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('Nom et signature du technicien', technicianX + signatureWidth/2, technicianY + 5, { align: 'center' });
        
        // Texte technicien centr√© sur 75mm
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        const techText = "Je reconnais avoir inform√© le client des op√©rations de maintenance faites ou √† effectuer, ainsi que des travaux √† r√©aliser.";
        doc.text(techText, technicianX + signatureWidth/2, technicianY + 9, { align: 'center', maxWidth: 75 });
        
        // Nom du signataire technicien
        const technicianNameInput = document.getElementById('technicianNameInput');
        const technicianName = technicianNameInput ? technicianNameInput.value.trim() : '';
        if (technicianName) {
          doc.setFontSize(8);
          doc.setFont('courier', 'normal');
          doc.setTextColor(0, 0, 0);
          doc.text(technicianName, technicianX + 2, technicianY + 17);
        }
        
        // Ajouter les signatures si elles existent
        const clientCanvas = document.getElementById('clientSignature');
        const technicianCanvas = document.getElementById('technicianSignature');
        
        if (hasTechnicianSignature && technicianCanvas) {
          try {
            const technicianSignatureData = technicianCanvas.toDataURL('image/png');
            doc.addImage(technicianSignatureData, 'PNG', technicianX + 2, technicianY + 25, signatureWidth - 4, 18);
          } catch (error) {
            console.log('Signature technicien non disponible pour le PDF d√©taill√©');
          }
        }
        
        if (hasClientSignature && clientCanvas) {
          try {
            const clientSignatureData = clientCanvas.toDataURL('image/png');
            doc.addImage(clientSignatureData, 'PNG', clientX + 2, clientY + 25, signatureWidth - 4, 18);
          } catch (error) {
            console.log('Signature client non disponible pour le PDF d√©taill√©');
          }
        }
        
        // Informations l√©gales en bas de page
        const legalY = 285;
        
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(100, 100, 100); // Gris fonc√© pour les informations l√©gales
        
        // Ligne 1
        doc.text('Entreprise individuelle ‚Äì SIRET 794 660 365 00014 ‚Äì Code APE 4778C ‚Äì TVA non applicable selon l\'article 293-B du Code G√©n√©ral des Imp√¥ts', 105, legalY, { align: 'center' });
        
        // Ligne 2
        doc.text('Immatricul√© au r√©pertoire des m√©tiers sous le num√©ro 794 660 365 RM 54 aupr√®s de la Chambre des M√©tiers de Laxou', 105, legalY + 3, { align: 'center' });
        
        // Ligne 3
        doc.text('Immatricul√© au Registre du Commerce et des Soci√©t√©s sous le num√©ro 794 660 365 R.C.S. Nancy', 105, legalY + 6, { align: 'center' });
        
        // Ligne 4
        doc.text('Voir conditions g√©n√©rales de vente', 105, legalY + 9, { align: 'center' });
        
        // Disclaimer (image)
        try {
          const disclaimerImg = new Image();
          disclaimerImg.src = 'img/Disclaimer.png';
          await new Promise((resolve, reject) => {
            disclaimerImg.onload = resolve;
            disclaimerImg.onerror = reject;
          });
          
          // Position du disclaimer (en bas de page, centr√©)
          const disclaimerWidth = disclaimerImg.width * 0.26 * 0.8; // Conversion px vers mm et r√©duction 20%
          const disclaimerHeight = disclaimerImg.height * 0.26 * 0.8;
          const disclaimerX = (210 - disclaimerWidth) / 2; // Centr√© horizontalement
          const disclaimerY = legalY + 15; // 15mm en dessous des informations l√©gales
          
          doc.addImage(disclaimerImg, 'PNG', disclaimerX, disclaimerY, disclaimerWidth, disclaimerHeight);
        } catch (error) {
          console.log('Image Disclaimer.png non trouv√©e');
        }
        
        // Adapter la hauteur de la vignette SITE si besoin
        // (d√©j√† augment√©e √† 35mm, mais on laisse le code pour ajustement futur)
        
        // Cl√¥turer l'intervention avant de sauvegarder le PDF
        await closeIntervention();
        
        // Sauvegarder le PDF avec le bon nom de fichier
        const fileName = `${numeroDeBon} - ${nomClient} - ${nomSite}.pdf`;
        doc.save(fileName);
        
        // Upload vers Supabase Storage
        try {
          console.log('‚òÅÔ∏è Upload du PDF vers Supabase Storage...');
          const pdfBlob = doc.output('blob');
          const urlParams = new URLSearchParams(window.location.search);
          const interventionId = urlParams.get('intervention');
          
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('rapports-pdf')
            .upload(`interventions/${interventionId}/${fileName}`, pdfBlob, {
              contentType: 'application/pdf',
              upsert: true
            });

          if (uploadError) {
            console.error('‚ùå Erreur lors de l\'upload:', uploadError);
          } else {
            console.log('‚úÖ PDF upload√© avec succ√®s:', uploadData);
            const { data: urlData } = supabase.storage
              .from('rapports-pdf')
              .getPublicUrl(`interventions/${interventionId}/${fileName}`);
            await savePDFUrl(interventionId, urlData.publicUrl, fileName);
          }
        } catch (error) {
          console.error('‚ùå Erreur lors de l\'upload du PDF:', error);
        }
        
        document.getElementById('generateBtn2').classList.remove('loading');
        
        // Redirection vers verification.html apr√®s la g√©n√©ration du PDF
        setTimeout(() => {
          window.location.href = 'verification.html';
        }, 1000); // D√©lai de 1 seconde pour laisser le temps au PDF de se t√©l√©charger
      } catch (error) {
        console.error('Erreur lors de la g√©n√©ration du PDF d√©taill√©:', error);
        alert('Erreur lors de la g√©n√©ration du PDF d√©taill√©');
        document.getElementById('generateBtn2').classList.remove('loading');
      }
    }
    
    // Fonction pour cl√¥turer l'intervention
    async function closeIntervention() {
      try {
        // R√©cup√©rer l'ID de l'intervention depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const interventionId = urlParams.get('intervention');
        const clientId = urlParams.get('client');
        
        if (!interventionId) {
          console.error('‚ùå ID d\'intervention manquant dans l\'URL');
          return;
        }
        
        if (!numeroDeBon) {
          console.error('‚ùå Num√©ro de bon non g√©n√©r√©');
          return;
        }
        
        console.log('üîí Cl√¥ture de l\'intervention:', interventionId);
        console.log('üìã Num√©ro de bon √† enregistrer:', numeroDeBon);
        console.log('üë§ ID client:', clientId);
        
        // 1. Mettre √† jour l'√©tat de l'intervention
        const { error: interventionError } = await supabase
          .from('interventions')
          .update({ 
            etat_intervention: 'Termin√©',
            date_fin: new Date().toISOString(),
            updated_at: new Date().toISOString()
          })
          .eq('id_intervention', interventionId);
        
        if (interventionError) {
          console.error('‚ùå Erreur lors de la cl√¥ture de l\'intervention:', interventionError);
          throw new Error('Erreur lors de la cl√¥ture de l\'intervention');
        }
        
        // 2. Enregistrer le num√©ro de bon dans la table BV (d√©sactiv√© temporairement √† cause des RLS)
        // Extraire seulement le num√©ro (sans l'ann√©e) et le convertir en nombre
        const numeroOnly = parseInt(numeroDeBon.split('-')[1]); // 86 au lieu de "2025-0086"
        // R√©cup√©rer le nom du signataire client (si saisi)
        const clientNameInputEl = document.getElementById('clientNameInput');
        const nomSignataire = clientNameInputEl ? (clientNameInputEl.value || '').trim() : null;
        
        console.log('üî¢ Num√©ro extrait pour BV:', numeroOnly);
        console.log('üìã Enregistrement du bon dans la table BV...');
        
        // Enregistrer le num√©ro de bon dans la table BV
        const { error: bvError } = await supabase
          .from('BV')
          .insert({
            num_bv: numeroOnly,
            client_BV: clientId,
            inter: interventionId,
            nom_signataire: nomSignataire || null
          });
        
        if (bvError) {
          console.error('‚ùå Erreur lors de l\'enregistrement du bon:', bvError);
          throw new Error('Erreur lors de l\'enregistrement du bon');
        }
        
        console.log('‚úÖ Intervention cl√¥tur√©e avec succ√®s');
        console.log('‚úÖ Bon de v√©rification enregistr√©:', numeroDeBon);
        
        // üîÑ SYNCHRONISATION FINALE - Mode Offline-First
        if (window.offlineFirstManager) {
          console.log('üîÑ Synchronisation finale de toutes les donn√©es...');
          await window.offlineFirstManager.syncAllData();
          console.log('‚úÖ Synchronisation finale termin√©e');
          
          // üßπ Nettoyer les donn√©es pr√©charg√©es apr√®s finalisation
          await window.offlineFirstManager.clearPreloadedData();
          console.log('üßπ Donn√©es pr√©charg√©es nettoy√©es');
        }
        
      } catch (error) {
        console.error('‚ùå Erreur lors de la cl√¥ture:', error);
        throw error;
      }
    }

    // Persister l'URL du PDF sur l'intervention (si les colonnes existent)
    async function savePDFUrl(interventionId, publicUrl, fileName) {
      try {
        const { error } = await supabase
          .from('interventions')
          .update({
            pdf_url: publicUrl,
            pdf_filename: fileName,
            updated_at: new Date().toISOString()
          })
          .eq('id_intervention', interventionId);

        if (error) {
          console.warn('‚ö†Ô∏è Impossible d\'enregistrer l\'URL du PDF (colonnes manquantes ?):', error);
        } else {
          console.log('‚úÖ URL du PDF enregistr√©e pour l\'intervention', interventionId);
        }
      } catch (e) {
        console.warn('‚ö†Ô∏è savePDFUrl a √©chou√©:', e);
      }
    }
    
    // Fonction pour retourner √† la page pr√©c√©dente
    function goBack() {
      // R√©cup√©rer l'ID de l'intervention depuis l'URL
      const urlParams = new URLSearchParams(window.location.search);
      const interventionId = urlParams.get('intervention');
      
      if (interventionId) {
        // Retourner vers la page de v√©rification de l'intervention
        window.location.href = `verifSite.html?intervention=${encodeURIComponent(interventionId)}`;
      } else {
        // Retourner vers la page de s√©lection de v√©rification
        window.location.href = 'newVerification.html';
      }
    }
    
    // D√©tection iPad/iOS
    function isIPad() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    }
    

    
    // Fonction de test des canvas
    function testCanvas() {
      console.log('üß™ Test des canvas de signature...');
      
      const clientCanvas = document.getElementById('clientSignature');
      const technicianCanvas = document.getElementById('technicianSignature');
      
      if (!clientCanvas || !technicianCanvas) {
        console.error('‚ùå Canvas non trouv√©s');
        return false;
      }
      
      console.log('‚úÖ Canvas trouv√©s:', {
        client: clientCanvas.id,
        technician: technicianCanvas.id,
        clientWidth: clientCanvas.width,
        clientHeight: clientCanvas.height,
        technicianWidth: technicianCanvas.width,
        technicianHeight: technicianCanvas.height
      });
      
      // Test du contexte 2D
      try {
        const clientCtx = clientCanvas.getContext('2d');
        const technicianCtx = technicianCanvas.getContext('2d');
        
        if (!clientCtx || !technicianCtx) {
          console.error('‚ùå Contexte 2D non disponible');
          return false;
        }
        
        console.log('‚úÖ Contexte 2D disponible');
        return true;
      } catch (error) {
        console.error('‚ùå Erreur contexte 2D:', error);
        return false;
      }
    }
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Initialisation de verificationSummary.html...');
      
      // Activer imm√©diatement le bouton 2 pour les tests
      const generateBtn2 = document.getElementById('generateBtn2');
      if (generateBtn2) {
        generateBtn2.disabled = false;
        console.log('‚úÖ Bouton PDF d√©taill√© activ√© pour les tests');
      }
      
      // Test des canvas avant initialisation
      if (testCanvas()) {
      initSignatureCanvas();
      } else {
        console.error('‚ùå Impossible d\'initialiser les canvas');
      }
      
      loadVerificationData();
    });
    
    // Variables pour stocker les informations modifiables
    let editableData = {
      startDate: null,
      endDate: null,
      technician: '',
      observations: '',
      notes: ''
    };
    
    // Fonction pour ouvrir la modale
    function openEditModal() {
      console.log('üîß Ouverture de la modale de modification');
      
      // Remplir les champs avec les donn√©es actuelles
      document.getElementById('editStartDate').value = editableData.startDate || '';
      document.getElementById('editEndDate').value = editableData.endDate || '';
      document.getElementById('editTechnician').value = editableData.technician || '';
      document.getElementById('editObservations').value = editableData.observations || '';
      document.getElementById('editNotes').value = editableData.notes || '';
      
      // Afficher la modale
      document.getElementById('editModal').style.display = 'flex';
    }
    
    // Fonction pour fermer la modale
    function closeEditModal() {
      console.log('‚ùå Fermeture de la modale de modification');
      document.getElementById('editModal').style.display = 'none';
    }
    
    // Fonction pour sauvegarder les modifications
    function saveEditChanges() {
      console.log('üíæ Sauvegarde des modifications');
      
      // R√©cup√©rer les valeurs des champs
      editableData.startDate = document.getElementById('editStartDate').value;
      editableData.endDate = document.getElementById('editEndDate').value;
      editableData.technician = document.getElementById('editTechnician').value;
      editableData.observations = document.getElementById('editObservations').value;
      editableData.notes = document.getElementById('editNotes').value;
      
      // Mettre √† jour l'affichage
      updateDisplayWithEditableData();
      
      // Fermer la modale
      closeEditModal();
      
      // Afficher un message de confirmation
      if (window.Notifier) {
        Notifier.success('Modifications enregistr√©es avec succ√®s');
      } else {
        alert('Modifications enregistr√©es avec succ√®s');
      }
    }
    
    // Fonction pour mettre √† jour l'affichage avec les donn√©es modifi√©es
    function updateDisplayWithEditableData() {
      // Mettre √† jour les dates si elles ont √©t√© modifi√©es
      if (editableData.startDate) {
        const startDateElement = document.getElementById('startDate');
        if (startDateElement) {
          const date = new Date(editableData.startDate);
          startDateElement.textContent = date.toLocaleDateString('fr-FR');
        }
      }
      
      if (editableData.endDate) {
        const endDateElement = document.getElementById('endDate');
        if (endDateElement) {
          const date = new Date(editableData.endDate);
          endDateElement.textContent = date.toLocaleDateString('fr-FR');
        }
      }
      
      // Mettre √† jour le technicien si sp√©cifi√©
      if (editableData.technician) {
        // Chercher un √©l√©ment pour afficher le technicien ou en cr√©er un
        let technicianElement = document.getElementById('technicianName');
        if (!technicianElement) {
          // Cr√©er un √©l√©ment pour afficher le technicien
          const infoSection = document.querySelector('.info-section h3');
          if (infoSection) {
            const technicianDiv = document.createElement('div');
            technicianDiv.innerHTML = `
              <div class="info-line">
                <span class="info-label">Technicien :</span>
                <span class="info-name" id="technicianName">${editableData.technician}</span>
              </div>
            `;
            infoSection.parentNode.insertBefore(technicianDiv, infoSection.nextSibling);
          }
        } else {
          technicianElement.textContent = editableData.technician;
        }
      }
      
      console.log('‚úÖ Affichage mis √† jour avec les donn√©es modifi√©es:', editableData);
    }
    
    // Fermer la modale en cliquant sur l'overlay
    document.addEventListener('click', function(event) {
      const modal = document.getElementById('editModal');
      if (event.target === modal) {
        closeEditModal();
      }
    });
    
    // Fermer la modale avec la touche Escape
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeEditModal();
      }
    });
  </script>
  
  <!-- Modale de modification des informations -->
  <div id="editModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Modifier les informations du rapport</h3>
        <button class="modal-close" onclick="closeEditModal()">√ó</button>
      </div>
      
      <form id="editForm">
        <div class="form-group">
          <label class="form-label" for="editStartDate">Date de d√©but d'intervention</label>
          <input type="date" id="editStartDate" class="form-input" />
        </div>
        
        <div class="form-group">
          <label class="form-label" for="editEndDate">Date de fin d'intervention</label>
          <input type="date" id="editEndDate" class="form-input" />
        </div>
        
        <div class="form-group">
          <label class="form-label" for="editTechnician">Nom du technicien</label>
          <input type="text" id="editTechnician" class="form-input" placeholder="Nom du technicien" />
        </div>
        
        <div class="form-group">
          <label class="form-label" for="editObservations">Observations g√©n√©rales</label>
          <textarea id="editObservations" class="form-input form-textarea" placeholder="Observations g√©n√©rales sur l'intervention..."></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="editNotes">Notes internes</label>
          <textarea id="editNotes" class="form-input form-textarea" placeholder="Notes internes (non visibles sur le rapport client)..."></textarea>
        </div>
      </form>
      
      <div class="modal-actions">
        <button type="button" class="btn-cancel" onclick="closeEditModal()">Annuler</button>
        <button type="button" class="btn-save" onclick="saveEditChanges()">Enregistrer</button>
      </div>
    </div>
  </div>
</body>
</html> 