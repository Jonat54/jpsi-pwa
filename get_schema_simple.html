<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sch√©ma Base de Donn√©es JPSI</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'SF Pro Display', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
            color: #1e293b;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        .content {
            padding: 30px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #64748b;
        }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .table-section {
            margin-bottom: 40px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        .table-header {
            background: #f8fafc;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        .table-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 10px 0;
        }
        .table-description {
            color: #64748b;
            margin: 0;
        }
        .columns-table {
            width: 100%;
            border-collapse: collapse;
        }
        .columns-table th {
            background: #f1f5f9;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
        }
        .columns-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }
        .columns-table tr:hover {
            background: #f8fafc;
        }
        .primary-key {
            background: #dcfce7;
            color: #166534;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .foreign-key {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .nullable {
            color: #dc2626;
            font-weight: 600;
        }
        .not-nullable {
            color: #059669;
            font-weight: 600;
        }
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #fecaca;
        }
        .success {
            background: #dcfce7;
            color: #166534;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #bbf7d0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #3b82f6;
            margin: 0 0 5px 0;
        }
        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Sch√©ma Base de Donn√©es JPSI</h1>
            <p>Analyse compl√®te de la structure de la base de donn√©es Supabase</p>
        </div>
        
        <div class="content">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>üîç R√©cup√©ration du sch√©ma de la base de donn√©es...</p>
            </div>
            
            <div id="error" class="error" style="display: none;">
                <h3>‚ùå Erreur lors de la r√©cup√©ration du sch√©ma</h3>
                <p id="error-message"></p>
            </div>
            
            <div id="stats" class="stats" style="display: none;"></div>
            
            <div id="schema-content" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://anyzqzhjvankvbbajahj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFueXpxemhqdmFua3ZiYmFqYWhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NTIzMjgsImV4cCI6MjA2NjMyODMyOH0.74pICcGtU_Ks0COTtPsSOQ8qtLfOzRHTNa1A41BAiMU';

        // Initialiser Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Descriptions des tables (bas√©es sur DB.MD)
        const tableDescriptions = {
            'clients': 'Informations sur les clients de JPSI',
            'sites': 'Sites appartenant aux clients',
            'alarmes': 'Syst√®mes d\'alarme install√©s sur les sites',
            'peripheriques': 'P√©riph√©riques des syst√®mes d\'alarme',
            'eclairages': '√âclairages de s√©curit√©',
            'desenfumages': 'Syst√®mes de d√©senfumage',
            'extincteurs': 'Extincteurs install√©s',
            'agentextincteur': 'Types d\'agents extincteurs',
            'fire_extinguisher_certification_registry': 'Registre des certifications d\'extincteurs',
            'verifications': 'V√©rifications programm√©es',
            'eclairage_catalogue': 'Catalogue des √©clairages',
            'prospects': 'Prospects potentiels',
            'audits': 'Audits r√©alis√©s',
            'audit_equipements': '√âquipements propos√©s lors des audits'
        };

        async function getDatabaseSchema() {
            try {
                console.log('üîç D√©but de la r√©cup√©ration du sch√©ma...');

                // R√©cup√©rer toutes les tables
                const { data: tables, error: tablesError } = await supabase
                    .from('information_schema.tables')
                    .select('table_name')
                    .eq('table_schema', 'public')
                    .eq('table_type', 'BASE TABLE')
                    .order('table_name');

                if (tablesError) {
                    throw new Error(`Erreur lors de la r√©cup√©ration des tables: ${tablesError.message}`);
                }

                if (!tables || tables.length === 0) {
                    throw new Error('Aucune table trouv√©e dans le sch√©ma public');
                }

                console.log(`‚úÖ ${tables.length} tables trouv√©es`);

                // R√©cup√©rer les colonnes pour chaque table
                const schemaData = [];
                for (const table of tables) {
                    const { data: columns, error: columnsError } = await supabase
                        .from('information_schema.columns')
                        .select(`
                            column_name,
                            data_type,
                            is_nullable,
                            column_default,
                            character_maximum_length,
                            numeric_precision,
                            numeric_scale
                        `)
                        .eq('table_schema', 'public')
                        .eq('table_name', table.table_name)
                        .order('ordinal_position');

                    if (columnsError) {
                        console.error(`Erreur pour la table ${table.table_name}:`, columnsError);
                        continue;
                    }

                    // R√©cup√©rer les cl√©s primaires
                    const { data: primaryKeys, error: pkError } = await supabase
                        .from('information_schema.key_column_usage')
                        .select('column_name')
                        .eq('table_schema', 'public')
                        .eq('table_name', table.table_name)
                        .eq('constraint_name', `${table.table_name}_pkey`);

                    // R√©cup√©rer les cl√©s √©trang√®res
                    const { data: foreignKeys, error: fkError } = await supabase
                        .from('information_schema.referential_constraints')
                        .select(`
                            constraint_name,
                            unique_constraint_name
                        `)
                        .eq('constraint_schema', 'public')
                        .eq('table_name', table.table_name);

                    schemaData.push({
                        table: table.table_name,
                        columns: columns || [],
                        primaryKeys: primaryKeys || [],
                        foreignKeys: foreignKeys || []
                    });
                }

                return schemaData;

            } catch (error) {
                console.error('‚ùå Erreur:', error);
                throw error;
            }
        }

        function displaySchema(schemaData) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const statsEl = document.getElementById('stats');
            const contentEl = document.getElementById('schema-content');

            // Masquer le loading
            loadingEl.style.display = 'none';

            // Afficher les statistiques
            const totalTables = schemaData.length;
            const totalColumns = schemaData.reduce((sum, table) => sum + table.columns.length, 0);
            const totalPrimaryKeys = schemaData.reduce((sum, table) => sum + table.primaryKeys.length, 0);
            const totalForeignKeys = schemaData.reduce((sum, table) => sum + table.foreignKeys.length, 0);

            statsEl.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalTables}</div>
                    <div class="stat-label">Tables</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalColumns}</div>
                    <div class="stat-label">Colonnes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalPrimaryKeys}</div>
                    <div class="stat-label">Cl√©s Primaires</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalForeignKeys}</div>
                    <div class="stat-label">Cl√©s √âtrang√®res</div>
                </div>
            `;
            statsEl.style.display = 'grid';

            // Afficher le contenu du sch√©ma
            let schemaHTML = '';
            
            schemaData.forEach(tableData => {
                const tableName = tableData.table;
                const description = tableDescriptions[tableName] || 'Table sans description';
                
                schemaHTML += `
                    <div class="table-section">
                        <div class="table-header">
                            <h2 class="table-name">üè∑Ô∏è ${tableName}</h2>
                            <p class="table-description">${description}</p>
                        </div>
                        <table class="columns-table">
                            <thead>
                                <tr>
                                    <th>Colonne</th>
                                    <th>Type</th>
                                    <th>Nullable</th>
                                    <th>Valeur par d√©faut</th>
                                    <th>Cl√©s</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                tableData.columns.forEach(column => {
                    const isPrimaryKey = tableData.primaryKeys.some(pk => pk.column_name === column.column_name);
                    const isForeignKey = tableData.foreignKeys.some(fk => fk.constraint_name.includes(column.column_name));
                    
                    let keysHTML = '';
                    if (isPrimaryKey) {
                        keysHTML += '<span class="primary-key">PK</span> ';
                    }
                    if (isForeignKey) {
                        keysHTML += '<span class="foreign-key">FK</span>';
                    }

                    const type = column.data_type + 
                        (column.character_maximum_length ? `(${column.character_maximum_length})` : '') +
                        (column.numeric_precision ? `(${column.numeric_precision}${column.numeric_scale ? ',' + column.numeric_scale : ''})` : '');

                    const nullable = column.is_nullable === 'YES' ? 
                        '<span class="nullable">OUI</span>' : 
                        '<span class="not-nullable">NON</span>';

                    const defaultValue = column.column_default || '-';

                    schemaHTML += `
                        <tr>
                            <td><strong>${column.column_name}</strong></td>
                            <td>${type}</td>
                            <td>${nullable}</td>
                            <td>${defaultValue}</td>
                            <td>${keysHTML}</td>
                        </tr>
                    `;
                });

                schemaHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            contentEl.innerHTML = schemaHTML;
            contentEl.style.display = 'block';
        }

        function displayError(error) {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const errorMessageEl = document.getElementById('error-message');

            loadingEl.style.display = 'none';
            errorMessageEl.textContent = error.message || 'Une erreur inconnue est survenue';
            errorEl.style.display = 'block';
        }

        // Ex√©cuter l'analyse
        getDatabaseSchema()
            .then(schemaData => {
                displaySchema(schemaData);
            })
            .catch(error => {
                displayError(error);
            });
    </script>
</body>
</html> 