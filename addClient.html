<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JPSI - Ajouter un Client</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      min-height: 100vh;
      min-width: 100vw;
      background: repeating-linear-gradient(135deg, #23272b 0 10px, #262a2e 10px 20px);
      font-family: 'SF Pro Display', 'Segoe UI', Arial, sans-serif;
      box-sizing: border-box;
      overflow-x: hidden;
      overflow-y: auto;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    
    .header-card {
      background: #f6f7f9;
      border: 3.5px solid #9B2423;
      border-radius: 38px;
      box-shadow: 0 6px 24px 0 rgba(30,32,36,0.13), 0 1.5px 0 #e5e7eb inset;
      padding: 2rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }
    
    .back-button {
      background: #9B2423;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: 700;
      line-height: 1;
    }
    
    .back-button:hover {
      background: #7a1d1c;
    }
    
    .header-title {
      font-size: 2.2rem;
      font-weight: 700;
      color: #23272b;
      margin: 0;
    }
    
    .form-card {
      background: #f6f7f9;
      border: 3.5px solid #9B2423;
      border-radius: 38px;
      box-shadow: 0 6px 24px 0 rgba(30,32,36,0.13), 0 1.5px 0 #e5e7eb inset;
      padding: 2rem;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    
    .form-label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }
    
    .form-input {
      padding: 1rem 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1rem;
      background: white;
      transition: border-color 0.2s;
      font-family: inherit;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #9B2423;
    }
    
    .form-input.required {
      border-left: 4px solid #9B2423;
    }
    
    .form-textarea {
      padding: 1rem 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1rem;
      background: white;
      transition: border-color 0.2s;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
    }
    
    .form-textarea:focus {
      outline: none;
      border-color: #9B2423;
    }
    
    .form-input option {
      padding: 0.5rem;
      font-size: 1rem;
    }
    
    .form-input option:hover {
      background-color: #f3f4f6;
    }
    
    .buttons-container {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 2px solid #e5e7eb;
    }
    
    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .btn-primary {
      background: #9B2423;
      color: white;
    }
    
    .btn-primary:hover {
      background: #7a1d1c;
    }
    
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    .status-message {
      padding: 1rem 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      font-weight: 500;
      text-align: center;
    }
    
    .status-success {
      background: #dcfce7;
      color: #166534;
      border: 2px solid #bbf7d0;
    }
    
    .status-error {
      background: #fee2e2;
      color: #dc2626;
      border: 2px solid #fecaca;
    }
    
    .status-warning {
      background: #fef3c7;
      color: #d97706;
      border: 2px solid #fed7aa;
    }
    
    .required-field {
      color: #9B2423;
      font-weight: 600;
    }
    

    
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .buttons-container {
        flex-direction: column;
      }
      
      .container {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header Card -->
    <div class="header-card">
      <button class="back-button" onclick="goBack()" title="Retour">
        ‚Äπ
      </button>
      <h1 class="header-title">Ajouter un Client</h1>
    </div>
    
    <!-- Form Card -->
    <div class="form-card">
      <div id="statusMessage"></div>
      
      <form id="clientForm" onsubmit="saveClient(event)">
        <div class="form-grid">
          <!-- Code Client -->
          <div class="form-group">
            <label class="form-label" for="codeClient">
              Code Client <span class="required-field">*</span>
            </label>
            <input type="text" id="codeClient" class="form-input required" required>
          </div>
          
          <!-- Nom Client -->
          <div class="form-group">
            <label class="form-label" for="nomClient">
              Nom du Client <span class="required-field">*</span>
            </label>
            <input type="text" id="nomClient" class="form-input required" required>
          </div>
          
          <!-- Adresse -->
          <div class="form-group full-width">
            <label class="form-label" for="adrClient">Adresse</label>
            <input type="text" id="adrClient" class="form-input">
          </div>
          
          <!-- Ville -->
          <div class="form-group">
            <label class="form-label" for="villeClient">Ville</label>
            <select id="villeClient" class="form-input">
              <option value="">S√©lectionner une ville...</option>
            </select>
          </div>
          
          <!-- Code Postal -->
          <div class="form-group">
            <label class="form-label" for="cpClient">Code Postal</label>
            <input type="text" id="cpClient" class="form-input">
          </div>
          
          <!-- Email -->
          <div class="form-group">
            <label class="form-label" for="mailClient">Email</label>
            <input type="email" id="mailClient" class="form-input">
          </div>
          
          <!-- T√©l√©phone -->
          <div class="form-group">
            <label class="form-label" for="telClient">T√©l√©phone</label>
            <input type="tel" id="telClient" class="form-input">
          </div>
          
          <!-- SIREN -->
          <div class="form-group">
            <label class="form-label" for="sirenClient">SIREN</label>
            <input type="text" id="sirenClient" class="form-input">
          </div>
          
          <!-- Responsable -->
          <div class="form-group">
            <label class="form-label" for="respClient">Responsable</label>
            <input type="text" id="respClient" class="form-input">
          </div>
          
          <!-- Email Responsable -->
          <div class="form-group">
            <label class="form-label" for="mailrespClient">Email Responsable</label>
            <input type="email" id="mailrespClient" class="form-input">
          </div>
          
          <!-- T√©l√©phone Responsable -->
          <div class="form-group">
            <label class="form-label" for="telrespClient">T√©l√©phone Responsable</label>
            <input type="tel" id="telrespClient" class="form-input">
          </div>
          

        </div>
        
        <div class="buttons-container">
          <button type="submit" class="btn btn-primary">
            üíæ Sauvegarder
          </button>
          <button type="button" class="btn btn-secondary" onclick="goBack()">
            ‚ùå Annuler
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Configuration Supabase
    const SUPABASE_URL = 'https://anyzqzhjvankvbbajahj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFueXpxemhqdmFua3ZiYmFqYWhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NTIzMjgsImV4cCI6MjA2NjMyODMyOH0.74pICcGtU_Ks0COTtPsSOQ8qtLfOzRHTNa1A41BAiMU';
    
    // Initialisation de Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Sauvegarder le client
    async function saveClient(event) {
      event.preventDefault();
      
      // R√©cup√©rer les donn√©es du formulaire
      const clientData = {
        code_client: document.getElementById('codeClient').value.trim(),
        nom_client: document.getElementById('nomClient').value.trim(),
        adr_client: document.getElementById('adrClient').value.trim(),
        ville_client: document.getElementById('villeClient').value.trim(),
        cp_client: document.getElementById('cpClient').value.trim(),
        mail_client: document.getElementById('mailClient').value.trim(),
        tel_client: document.getElementById('telClient').value.trim(),
        siren_client: document.getElementById('sirenClient').value.trim(),
        resp_client: document.getElementById('respClient').value.trim(),
        mailresp_client: document.getElementById('mailrespClient').value.trim(),
        telresp_client: document.getElementById('telrespClient').value.trim()
      };
      
      // Validation des champs obligatoires
      if (!clientData.code_client || !clientData.nom_client) {
        showStatus('Veuillez remplir tous les champs obligatoires', 'error');
        return;
      }
      
      try {
        console.log('üìù Tentative de sauvegarde du client:', clientData);
        showStatus('Sauvegarde en cours...', 'info');
        
        // Ins√©rer le client dans Supabase
        const { data, error } = await supabase
          .from('clients')
          .insert([clientData])
          .select();
        
        if (error) {
          console.error('‚ùå Erreur lors de la sauvegarde:', error);
          
          // V√©rifier si c'est une erreur de doublon
          if (error.code === '23505') {
            showStatus('Un client avec ce code existe d√©j√†', 'error');
          } else {
            showStatus('Erreur lors de la sauvegarde: ' + error.message, 'error');
          }
          return;
        }
        
        console.log('‚úÖ Client sauvegard√© avec succ√®s:', data);
        showStatus('Client sauvegard√© avec succ√®s !', 'success');
        
        // Vider le formulaire
        document.getElementById('clientForm').reset();
        
        // Rediriger vers la liste apr√®s 2 secondes
        setTimeout(() => {
          window.location.href = 'ListClients.html';
        }, 2000);
        
      } catch (error) {
        console.error('‚ùå Erreur de connexion:', error);
        showStatus('Erreur de connexion √† la base de donn√©es', 'error');
      }
    }
    
    // Afficher un message de statut
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('statusMessage');
      const className = `status-message status-${type}`;
      
      statusDiv.className = className;
      statusDiv.textContent = message;
      
      // Masquer le message apr√®s 5 secondes pour les succ√®s
      if (type === 'success') {
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 5000);
      }
    }
    
    // Retour en arri√®re
    function goBack() {
      window.location.href = 'ListClients.html';
    }
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Page Ajouter Client initialis√©e');
      
      // Focus sur le premier champ
      document.getElementById('codeClient').focus();
      
      // Ajout de l'autocompl√©tion ville par code postal
      const cpInput = document.getElementById('cpClient');
      const villeInput = document.getElementById('villeClient');
      
      if (cpInput && villeInput) {
        cpInput.addEventListener('input', async () => {
          const cp = cpInput.value.trim();
          
          // R√©initialiser la liste d√©roulante
          villeInput.innerHTML = '<option value="">S√©lectionner une ville...</option>';
          
          if (cp.length === 5 && /^[0-9]{5}$/.test(cp)) {
            try {
              console.log(`üîç Recherche des villes pour le code postal: ${cp}`);
              const response = await fetch(`https://geo.api.gouv.fr/communes?codePostal=${cp}&fields=nom&format=json`);
              
              if (response.ok) {
                const villes = await response.json();
                console.log(`‚úÖ ${villes.length} ville(s) trouv√©e(s) pour le code postal ${cp}:`, villes);
                
                if (villes.length === 0) {
                  // Aucune ville trouv√©e
                  console.log(`‚ùå Aucune ville trouv√©e pour le code postal ${cp}`);
                  showStatus(`Aucune ville trouv√©e pour le code postal ${cp}`, 'error');
                } else {
                  // Ajouter toutes les villes √† la liste d√©roulante
                  villes.forEach(ville => {
                    const option = document.createElement('option');
                    option.value = ville.nom;
                    option.textContent = ville.nom;
                    villeInput.appendChild(option);
                  });
                  
                  // S√©lectionner automatiquement si une seule ville
                  if (villes.length === 1) {
                    villeInput.value = villes[0].nom;
                    console.log(`‚úÖ Ville automatiquement s√©lectionn√©e: ${villes[0].nom}`);
                    showStatus(`Ville trouv√©e: ${villes[0].nom}`, 'success');
                  } else {
                    console.log(`‚úÖ ${villes.length} villes disponibles pour s√©lection`);
                    showStatus(`${villes.length} villes trouv√©es pour ${cp}. Veuillez s√©lectionner.`, 'info');
                  }
                }
              } else {
                console.warn('‚ùå Erreur lors de la r√©cup√©ration des villes');
                showStatus('Erreur lors de la recherche des villes', 'error');
              }
            } catch (error) {
              console.error('‚ùå Erreur lors de la recherche des villes:', error);
              showStatus('Erreur de connexion lors de la recherche des villes', 'error');
            }
          }
        });
      }
    });
  </script>
</body>
</html> 