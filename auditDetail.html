<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>D√©tail Audit</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <!-- jsPDF pour g√©n√©rer le PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      min-width: 100vw;
      background: repeating-linear-gradient(135deg, #23272b 0 10px, #262a2e 10px 20px);
      font-family: 'SF Pro Display', 'Segoe UI', Arial, sans-serif;
      box-sizing: border-box;
      overflow-x: hidden;
      overflow-y: auto;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    /* Header uniforme avec le reste de l'app */
    .header-section {
      background: #f6f7f9;
      border: 3.5px solid #9B2423;
      border-radius: 38px;
      box-shadow: 0 6px 24px 0 rgba(30,32,36,0.13), 0 1.5px 0 #e5e7eb inset;
      padding: 2rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .back-btn {
      background: #9B2423;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: 700;
      line-height: 1;
    }

    .back-btn:hover {
      background: #7a1d1c;
    }

    .header-content h1 {
      color: #23272b;
      font-size: 2.2rem;
      font-weight: 700;
      margin: 0;
    }

    .header-content p {
      color: #6b7280;
      font-size: 1rem;
      margin-top: 0.5rem;
    }

    /* Grille principale */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      align-items: start;
    }

    /* Cartes uniformes */
    .card {
      background: #f6f7f9;
      border: 3.5px solid #9B2423;
      border-radius: 38px;
      box-shadow: 0 6px 24px 0 rgba(30,32,36,0.13), 0 1.5px 0 #e5e7eb inset;
      padding: 2rem;
      transition: all 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(30,32,36,0.18);
    }

    .card-title {
      color: #23272b;
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    /* Informations */
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid #e5e7eb;
      transition: all 0.2s ease;
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-item:hover {
      background: #f3f4f6;
      border-radius: 12px;
      padding-left: 1rem;
      padding-right: 1rem;
      margin: 0 -1rem;
    }

    .info-label {
      color: #6b7280;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .info-value {
      color: #23272b;
      font-weight: 700;
      text-align: right;
      max-width: 60%;
      word-break: break-word;
    }

    /* Liste des √©quipements */
    .equip-list {
      max-height: none;
      overflow-y: visible;
      padding-right: 0;
    }

    .equip-item {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 20px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.2s ease;
    }

    .equip-item:hover {
      transform: translateY(-1px);
      border-color: #9B2423;
      box-shadow: 0 4px 12px rgba(155, 36, 35, 0.1);
    }

    .equip-type {
      color: #23272b;
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }

    .equip-location {
      color: #6b7280;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .equip-justification {
      color: #9ca3af;
      font-style: italic;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }



    /* Actions */
    .actions-section {
      background: #f6f7f9;
      border: 3.5px solid #9B2423;
      border-radius: 38px;
      box-shadow: 0 6px 24px 0 rgba(30,32,36,0.13), 0 1.5px 0 #e5e7eb inset;
      padding: 2rem;
      display: flex;
      gap: 1.5rem;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    .action-btn {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 20px;
      padding: 1rem 2rem;
      color: #23272b;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-width: 180px;
      justify-content: center;
      font-family: inherit;
    }

    .action-btn:hover {
      background: #f9fafb;
      border-color: #d1d5db;
      transform: translateY(-1px);
    }

    .action-btn.primary {
      background: #9B2423;
      color: white;
      border-color: #9B2423;
    }

    .action-btn.primary:hover {
      background: #7a1d1c;
      border-color: #7a1d1c;
    }

    .action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* √âtats de chargement et erreur */
    .loading, .error {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
      font-size: 1.1rem;
    }

    .error {
      color: #dc2626;
    }

    /* Responsive uniforme */
    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .container {
        padding: 1.5rem;
        gap: 1.5rem;
      }
    }

    @media (max-width: 768px) {
      .header-section {
        padding: 1.5rem;
        border-radius: 18px;
        flex-direction: column;
        text-align: center;
        gap: 1rem;
      }

      .header-content h1 {
        font-size: 1.8rem;
      }

      .card {
        padding: 1.5rem;
        border-radius: 18px;
      }

      .actions-section {
        flex-direction: column;
        padding: 1.5rem;
        border-radius: 18px;
      }

      .action-btn {
        width: 100%;
        min-width: auto;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 1rem;
        gap: 1rem;
      }

      .card {
        padding: 1rem;
      }

      .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .info-value {
        text-align: left;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header moderne -->
    <div class="header-section">
      <button class="back-btn" onclick="goBack()" title="Retour">‚Äπ</button>
      <div class="header-content">
        <h1>D√©tail Audit</h1>
        <p>Consultez et g√©rez les informations de l'audit</p>
      </div>
    </div>

    <!-- Grille principale -->
    <div class="main-grid">
      <!-- Informations Prospect & Audit -->
      <div class="card">
        <h2 class="card-title">üìã Informations Prospect</h2>
        <div id="prospectInfo">
          <div class="loading">Chargement...</div>
        </div>
      </div>

      <!-- √âquipements Propos√©s -->
      <div class="card">
        <h2 class="card-title">üîß √âquipements Propos√©s</h2>
        <div id="equipementsList" class="equip-list">
          <div class="loading">Chargement...</div>
        </div>
      </div>
    </div>

    <!-- D√©tails Audit -->
    <div class="card">
      <h2 class="card-title">üìä D√©tails Audit</h2>
      <div id="auditInfo">
        <div class="loading">Chargement...</div>
      </div>
    </div>



    <!-- Actions -->
    <div class="actions-section">
      <button class="action-btn" onclick="goBack()">
        <span>‚Üê</span>
        Retour
      </button>
      <button class="action-btn primary" id="validateButton" onclick="validateAndGeneratePDF()">
        <span>‚úÖ</span>
        Valider & G√©n√©rer PDF
      </button>
      <button class="action-btn" onclick="updateStatut('Devis fait')">
        <span>üìã</span>
        Devis Fait
      </button>
    </div>
  </div>

  <script>
    // Fonction pour retourner √† la page pr√©c√©dente
    function goBack() {
        window.location.href = 'auditHistory.html';
    }
    
    // Configuration Supabase
    const SUPABASE_URL = 'https://anyzqzhjvankvbbajahj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFueXpxemhqdmFua3ZiYmFqYWhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NTIzMjgsImV4cCI6MjA2NjMyODMyOH0.74pICcGtU_Ks0COTtPsSOQ8qtLfOzRHTNa1A41BAiMU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const RECIPIENT_EMAIL = 'contact@jpsincendie.com';
    
    let currentAudit = null;
    let currentProspect = null;
    let equipements = [];
    
    // Fonction pour envoyer un email via Supabase Edge Function
    async function sendEmail(emailData) {
      try {
        const { data, error } = await supabase.functions.invoke('resend-email', {
          body: emailData
        });
        
        if (error) {
          throw new Error(error.message);
        }
        
        return data;
      } catch (error) {
        console.error('‚ùå Erreur envoi email:', error);
        throw error;
      }
    }
    
    function getAuditIdFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const auditId = urlParams.get('id');
      if (!auditId) {
        console.error('‚ùå Aucun ID d\'audit fourni dans l\'URL');
        return null;
      }
      return decodeURIComponent(auditId);
    }
    
    async function loadAuditData(auditId) {
      try {
        const { data: audit, error: auditError } = await supabase
          .from('audits')
          .select('*')
          .eq('id_audit', auditId)
          .single();
        if (auditError || !audit) {
          showError('Erreur lors du chargement de l\'audit');
          return;
        }
        currentAudit = audit;
        await loadProspectInfo(audit.id_prospect);
        await loadEquipements(auditId);
        updateDisplay();
      } catch (error) {
        showError('Erreur de connexion √† la base de donn√©es');
      }
    }
    
    async function loadProspectInfo(prospectId) {
      try {
        const { data: prospect, error } = await supabase
          .from('prospects')
          .select('*')
          .eq('id_prospect', prospectId)
          .single();
        if (error || !prospect) {
          showError('Erreur lors du chargement du prospect');
          return;
        }
        currentProspect = prospect;
      } catch (error) {
        showError('Erreur lors du chargement du prospect');
      }
    }
    
    async function loadEquipements(auditId) {
      try {
        console.log('üîç Chargement des √©quipements pour l\'audit:', auditId);
        
        const { data: equipementsData, error } = await supabase
          .from('audit_equipements')
          .select('*')
          .eq('id_audit', auditId)
          .order('type_extincteur');
          
        if (error) {
          console.error('‚ùå Erreur lors du chargement des √©quipements:', error);
          showError('Erreur lors du chargement des √©quipements');
          return;
        }
        
        equipements = equipementsData || [];
        console.log('‚úÖ √âquipements charg√©s:', equipements.length, '√©quipements');
        console.log('üìã Types d\'√©quipements:', equipements.map(e => e.type_extincteur));
        
      } catch (error) {
        console.error('‚ùå Erreur lors du chargement des √©quipements:', error);
        showError('Erreur lors du chargement des √©quipements');
      }
    }
    
    // Fonction pour obtenir l'ic√¥ne selon le type d'√©quipement
    function getEquipementIcon(type) {
      const typeLower = type.toLowerCase();
      
      // Extincteurs Eau
      if (typeLower.includes('ep6') || typeLower.includes('ep9') || typeLower.includes('eau')) {
        return 'üíß';
      }
      // Extincteurs CO‚ÇÇ
      if (typeLower.includes('co¬≤') || typeLower.includes('co2') || typeLower.includes('co')) {
        return '‚ùÑÔ∏è';
      }
      // Extincteurs Poudre
      if (typeLower.includes('pp') || typeLower.includes('poudre')) {
        return 'üß®';
      }
      // Plans
      if (typeLower.includes('plan') || typeLower.includes('√©vacuation') || typeLower.includes('evacuation')) {
        return 'üó∫Ô∏è';
      }
      // Signal√©tique
      if (typeLower.includes('signal') || typeLower.includes('consigne') || typeLower.includes('picto')) {
        return 'üö®';
      }
      // Autres √©quipements
      return 'üîß';
    }
    
    function updateDisplay() {
      if (!currentAudit || !currentProspect) return;
      
      // Prospect
      const prospectContainer = document.getElementById('prospectInfo');
      prospectContainer.innerHTML = `
        <div class="info-item">
          <span class="info-label">üè¢ Nom</span>
          <span class="info-value">${currentProspect.nom_prospect || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">üìç Adresse</span>
          <span class="info-value">${currentProspect.adr_prospect || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">üèôÔ∏è Ville</span>
          <span class="info-value">${currentProspect.ville_prospect || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">üìÆ Code Postal</span>
          <span class="info-value">${currentProspect.cp_prospect || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">üìû T√©l√©phone</span>
          <span class="info-value">${currentProspect.tel_prospect || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">‚úâÔ∏è Email</span>
          <span class="info-value">${currentProspect.mail_prospect || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">üë§ Responsable</span>
          <span class="info-value">${currentProspect.resp_prospect || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">üì± T√©l√©phone Responsable</span>
          <span class="info-value">${currentProspect.telresp_prospect || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">üìß Email Responsable</span>
          <span class="info-value">${currentProspect.mailresp_prospect || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">üèõÔ∏è SIREN</span>
          <span class="info-value">${currentProspect.siren_prospect || 'N/A'}</span>
        </div>
      `;
      
      // Audit
      const auditContainer = document.getElementById('auditInfo');
      auditContainer.innerHTML = `
        <div class="info-item">
          <span class="info-label">üî¢ Num√©ro Audit</span>
          <span class="info-value">${currentAudit.num_audit || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">üìÖ Date Audit</span>
          <span class="info-value">${currentAudit.date_audit_site || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">üìä Statut</span>
          <span class="info-value">${currentAudit.statut || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">üìù Observation</span>
          <span class="info-value">${currentAudit.observation_site || 'Aucune observation'}</span>
        </div>
      `;
      
      // √âquipements
      const equipementsContainer = document.getElementById('equipementsList');
      if (!equipements || equipements.length === 0) {
        equipementsContainer.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); font-style: italic; padding: 2rem;">Aucun √©quipement trouv√©.</div>';
      } else {
        console.log('üéØ Affichage de', equipements.length, '√©quipements');
        
        // Grouper les √©quipements par type
        const groupedEquipements = {};
        equipements.forEach(equip => {
          if (!groupedEquipements[equip.type_extincteur]) {
            groupedEquipements[equip.type_extincteur] = [];
          }
          groupedEquipements[equip.type_extincteur].push(equip);
        });
        
        let equipementsHTML = '';
        
        // Grouper les √©quipements par localisation
        const groupedByLocation = {};
        equipements.forEach(equip => {
          if (!groupedByLocation[equip.localisation]) {
            groupedByLocation[equip.localisation] = [];
          }
          groupedByLocation[equip.localisation].push(equip);
        });
        
        // Afficher chaque localisation avec ses √©quipements
        Object.entries(groupedByLocation).forEach(([location, equipList]) => {
          equipementsHTML += `
            <div class="equip-item">
              <div class="equip-location">üìç ${location}</div>
              <div style="margin-top: 0.5rem;">
                ${equipList.map(equip => `
                  <div class="equip-type" style="margin-bottom: 0.3rem;">
                    ${getEquipementIcon(equip.type_extincteur)} ${equip.type_extincteur}
                    ${equip.justification ? `<div class="equip-justification" style="margin-left: 1.5rem; margin-top: 0.2rem;">üí° ${equip.justification}</div>` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        });
        
        equipementsContainer.innerHTML = equipementsHTML;
      }
    }
    
    // Fonction pour g√©n√©rer le PDF professionnel
    function generatePDF() {
      if (!currentAudit || !currentProspect) {
        alert('‚ùå Impossible de g√©n√©rer le PDF : donn√©es manquantes');
        return null;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // === HEADER AVEC LOGO ===
      
             // Logo centr√© (vrai logo) - 20% plus grand
       try {
         const logoImg = new Image();
         logoImg.src = 'img/logo.png';
         doc.addImage(logoImg, 'PNG', 80, 10, 48, 24); // 40*1.2=48, 20*1.2=24
       } catch (error) {
         // Fallback si le logo ne charge pas
         doc.setTextColor(0, 0, 0);
         doc.setFontSize(16);
         doc.text('J.P. S√âCURIT√â INCENDIE', 105, 25, { align: 'center' });
       }
       
       // Titre en noir en dessous - en gras
       doc.setFontSize(14);
       doc.setFont(undefined, 'bold');
       doc.text('Rapport d\'audit s√©curit√© incendie', 105, 40, { align: 'center' });
       doc.setFont(undefined, 'normal');
      
             // === INFORMATIONS AUDIT ===
       let y = 50;
       
               // Cadre avec angles arrondis - marges r√©duites
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.2); // Encore plus fin
        doc.roundedRect(10, y, 190, 14, 2, 2); // Hauteur r√©duite : 15‚Üí14 (bas remont√© de 1px)
       
               doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        // Centrer verticalement le texte dans le cadre (hauteur 15, donc centr√© √† y+7.5)
        doc.text(`Num√©ro d'audit : ${currentAudit.num_audit || 'N/A'}`, 15, y+7.5); // Centr√© verticalement
        doc.text(`Date : ${new Date(currentAudit.date_audit_site).toLocaleDateString('fr-FR')}`, 115, y+7.5); // Centr√© verticalement
      
      y += 30;
      
             // === INFORMATIONS CLIENT ===
       
                       // Titre au-dessus du cadre - remont√© de 8px et en gras
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('INFORMATIONS CLIENT', 15, y-8); // Remont√© de 8px et en gras
        doc.setFont(undefined, 'normal');
        
        // Cadre fin noir avec angles arrondis - remont√© de 1px en dessous du titre
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.2); // M√™me √©paisseur que informations audit
        doc.roundedRect(10, y-7, 190, 25, 2, 2); // Hauteur ajust√©e : 45‚Üí25 (derni√®re ligne √† y+12, +2px = 14, donc hauteur 25)
        
        doc.setFontSize(10);
        
                          // Colonne de gauche - interlignes uniformis√©s √† 5px
         doc.text(`Raison sociale: ${currentProspect.nom_prospect || 'N/A'}`, 15, y-2);
         doc.text(`Adresse: ${currentProspect.adr_prospect || 'N/A'}`, 15, y+3); // Interligne uniforme de 5px
         doc.text(`${currentProspect.cp_prospect || ''} ${currentProspect.ville_prospect || ''}`, 15, y+8); // Interligne uniforme de 5px
         doc.text(`SIREN: ${currentProspect.siren_prospect || 'N/A'}`, 15, y+13); // Interligne uniforme de 5px
       
              y += 30; // M√™me espacement que entre audit et client (30 points)
         
         // === INFORMATIONS CONTACT ===
         
         // Titre au-dessus du cadre - remont√© de 8px et en gras
         doc.setTextColor(0, 0, 0);
         doc.setFontSize(12);
         doc.setFont(undefined, 'bold');
         doc.text('INFORMATIONS CONTACT', 15, y-8); // Remont√© de 8px et en gras
         doc.setFont(undefined, 'normal');
         
         // Cadre fin noir avec angles arrondis - remont√© de 1px en dessous du titre
         doc.setDrawColor(0, 0, 0);
         doc.setLineWidth(0.2); // M√™me √©paisseur que informations audit
         doc.roundedRect(10, y-7, 190, 20, 2, 2); // Hauteur ajust√©e pour 3 lignes
         
         doc.setFontSize(10);
         
         // Informations de contact - interlignes uniformis√©s √† 5px
         doc.text(`Contact: ${currentProspect.resp_prospect || 'N/A'}`, 15, y-2);
         doc.text(`T√©l√©phone: ${currentProspect.tel_prospect || 'N/A'}`, 15, y+3); // Interligne uniforme de 5px
         doc.text(`Email: ${currentProspect.mail_prospect || 'N/A'}`, 15, y+8); // Interligne uniforme de 5px
         
         y += 40;
        
        // === OBSERVATION ===
       if (currentAudit.observation_site && currentAudit.observation_site !== 'N/A') {
         doc.setTextColor(0, 0, 0);
         doc.setFontSize(12);
         doc.text('OBSERVATIONS', 15, y);
         
         doc.setFontSize(10);
         y += 8;
         
         // D√©couper le texte long - marges r√©duites
         const observations = doc.splitTextToSize(currentAudit.observation_site, 180);
         doc.text(observations, 15, y);
         y += observations.length * 5 + 10;
       }
      
                      // === √âQUIPEMENTS PROPOS√âS ===
        
        // Titre en gras, positionn√© √† 4px en dessous du cadre pr√©c√©dent
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('√âQUIPEMENTS PROPOS√âS', 15, y+4); // Positionn√© √† 4px en dessous du cadre pr√©c√©dent
        doc.setFont(undefined, 'normal');
        y += 10;
      
      if (equipements && equipements.length > 0) {
        equipements.forEach((equip, index) => {
          // V√©rifier si on a assez de place (grand cadre = 25 points minimum)
          if (y > 250) {
            doc.addPage();
            
            // Header simple sur nouvelle page
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.text('Rapport d\'audit s√©curit√© incendie (suite)', 105, 20, { align: 'center' });
            
            y = 40;
          }
          
                                // Grand cadre pour chaque √©quipement avec angles arrondis - marges r√©duites
           doc.setDrawColor(0, 0, 0);
           doc.setLineWidth(0.3);
           
           let hauteurCadre = 25; // Hauteur de base
           
           // Calculer hauteur si justification
           if (equip.justification) {
             const justifLines = doc.splitTextToSize(equip.justification, 180);
             hauteurCadre += (justifLines.length * 4) + 5;
           }
           
           doc.roundedRect(10, y, 190, hauteurCadre, 2, 2); // Marges r√©duites : 15‚Üí10, 180‚Üí190
           
           // S√©parateur vertical au milieu pour diviser emplacement/√©quipement
           doc.line(105, y, 105, y + 20);
           
           // EMPLACEMENT (√† gauche)
           doc.setFontSize(10);
           doc.text('EMPLACEMENT:', 15, y + 8);
           doc.setFontSize(11);
           doc.text(equip.localisation, 15, y + 15);
           
           // √âQUIPEMENT (√† droite)
           doc.setFontSize(10);
           doc.text('√âQUIPEMENT PROPOS√â:', 110, y + 8);
           doc.setFontSize(11);
           const icon = getEquipementIcon(equip.type_extincteur);
           doc.text(`${icon} ${equip.type_extincteur}`, 110, y + 15);
           
           // JUSTIFICATION (en dessous sur toute la largeur)
           if (equip.justification) {
             doc.setFontSize(10);
             doc.text('JUSTIFICATION:', 15, y + 25);
             doc.setFontSize(9);
             doc.setTextColor(60, 60, 60);
             const justifications = doc.splitTextToSize(equip.justification, 180);
             doc.text(justifications, 15, y + 32);
             doc.setTextColor(0, 0, 0);
           }
          
          y += hauteurCadre + 5; // Espacement entre les cadres
        });
             } else {
         doc.setTextColor(100, 100, 100);
         doc.setFontSize(11);
         doc.text('Aucun √©quipement propos√©.', 15, y);
         y += 20;
       }
      
      // === R√âSUM√â QUANTITATIF ===
      
      if (y > 200) {
        doc.addPage();
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(14);
        doc.text('Rapport d\'audit s√©curit√© incendie (suite)', 105, 20, { align: 'center' });
        y = 40;
      }
      
             doc.setTextColor(0, 0, 0);
       doc.setFontSize(12);
       doc.text('R√âSUM√â QUANTITATIF', 15, y);
       y += 10;
      
      // D√©tail par type avec noms longs
      const counts = {};
      const typesLongs = {
        'EP6': 'Extincteur √† eau pulv√©ris√©e 6 litres',
        'EP9': 'Extincteur √† eau pulv√©ris√©e 9 litres',
        'EP6A': 'Extincteur √† eau pulv√©ris√©e + additif 6 litres',
        'EP9A': 'Extincteur √† eau pulv√©ris√©e + additif 9 litres',
        'CO¬≤2kg': 'Extincteur au dioxyde de carbone 2 kg',
        'CO¬≤5kg': 'Extincteur au dioxyde de carbone 5 kg',
        'PP1': 'Extincteur √† poudre polyvalente 1 kg',
        'PP2': 'Extincteur √† poudre polyvalente 2 kg',
        'PP6': 'Extincteur √† poudre polyvalente 6 kg',
        'PP9': 'Extincteur √† poudre polyvalente 9 kg'
      };
      
      equipements.forEach(equip => {
        counts[equip.type_extincteur] = (counts[equip.type_extincteur] || 0) + 1;
      });
      
      // Calculer hauteur du cadre selon le nombre de types
      const nbTypes = Object.keys(counts).length;
      const hauteurCadre = Math.max(30, (nbTypes * 8) + 20);
      
                    // Grand cadre avec angles arrondis - marges r√©duites
       doc.setDrawColor(0, 0, 0);
       doc.setLineWidth(0.3);
       doc.roundedRect(10, y, 190, hauteurCadre, 2, 2); // Marges r√©duites : 15‚Üí10, 180‚Üí190
       
       doc.setFontSize(11);
       doc.text(`Total des √©quipements propos√©s: ${equipements.length}`, 15, y + 10);
       
       // Liste d√©taill√©e
       doc.setFontSize(10);
       let yInterne = y + 20;
       
       Object.entries(counts).forEach(([type, count]) => {
         const nomLong = typesLongs[type] || type;
         doc.text(`‚Ä¢ ${nomLong}: ${count}`, 15, yInterne);
         yInterne += 7;
       });
      
      y += hauteurCadre + 20;
      
      // === FOOTER SIMPLE ===
      
      // Aller au bas de la page pour le footer
      const pageHeight = doc.internal.pageSize.height;
      
             // Ligne s√©paratrice simple - marges r√©duites
       doc.setDrawColor(0, 0, 0);
       doc.setLineWidth(0.3);
       doc.line(15, pageHeight - 25, 195, pageHeight - 25);
       
       // Informations de contact discr√®tes
       doc.setTextColor(0, 0, 0);
       doc.setFontSize(9);
       doc.text('J.P. S√âCURIT√â INCENDIE', 15, pageHeight - 15);
       doc.text('contact@jpsincendie.com', 105, pageHeight - 15, { align: 'center' });
       
       doc.setTextColor(100, 100, 100);
       doc.setFontSize(8);
       doc.text(`Document g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, 195, pageHeight - 15, { align: 'right' });
      
      return doc;
    }
    
    // Fonction pour envoyer le PDF par email
    async function sendPDFByEmail(pdfBlob) {
      try {
        // Convertir le PDF en base64
        const reader = new FileReader();
        return new Promise((resolve, reject) => {
          reader.onload = async function() {
            const pdfBase64 = reader.result.split(',')[1];
            
            // Param√®tres pour EmailJS
            const templateParams = {
              to_email: RECIPIENT_EMAIL,
              audit_number: currentAudit.num_audit || 'N/A',
              prospect_name: currentProspect.nom_prospect || 'N/A',
              pdf_attachment: pdfBase64,
              message: `Rapport d'audit ${currentAudit.num_audit} pour ${currentProspect.nom_prospect}`
            };
            
            // Envoi via client email par d√©faut (temporaire en attendant la config du domaine)
            try {
              const pdfBlob = new Blob([pdf_attachment], { type: 'application/pdf' });
              const pdfUrl = URL.createObjectURL(pdfBlob);
              
              // Cr√©er le lien de t√©l√©chargement
              const link = document.createElement('a');
              link.href = pdfUrl;
              link.download = `Audit_${currentAudit.num_audit}_${currentProspect.nom_prospect}.pdf`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              
              // Lib√©rer l'URL
              URL.revokeObjectURL(pdfUrl);
              
              // Cr√©er le contenu de l'email
              const subject = `Rapport d'audit - ${currentAudit.num_audit}`;
              const body = `Bonjour,

Veuillez trouver ci-joint le rapport d'audit pour ${currentProspect.nom_prospect}.

Num√©ro d'audit : ${currentAudit.num_audit}

Cordialement,
J.P. S√âCURIT√â INCENDIE`;
              
              // Ouvrir le client email avec les informations pr√©-remplies
              const mailtoLink = `mailto:${RECIPIENT_EMAIL}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
              window.location.href = mailtoLink;
              
              console.log('‚úÖ Client email ouvert avec succ√®s');
              resolve(true);
            } catch (error) {
              console.error('‚ùå Erreur envoi email:', error);
              reject(error);
            }
          };
          reader.readAsDataURL(pdfBlob);
        });
      } catch (error) {
        console.error('‚ùå Erreur lors de l\'envoi:', error);
        throw error;
      }
    }
    
    // Fonction principale : valider audit + g√©n√©rer PDF
    async function validateAndGeneratePDF() {
      if (!currentAudit) {
        alert('‚ö†Ô∏è Impossible de valider : audit non charg√©');
        return;
      }
      
      const validateButton = document.getElementById('validateButton');
      validateButton.disabled = true;
      validateButton.textContent = '‚è≥ G√©n√©ration PDF...';
      
      try {
        // 1. Mettre √† jour le statut
        console.log('üíæ Mise √† jour du statut...');
        const { error } = await supabase
          .from('audits')
          .update({ statut: 'Faire devis' })
          .eq('id_audit', currentAudit.id_audit);
        
        if (error) {
          throw new Error('Erreur lors de la mise √† jour du statut');
        }
        
        // 2. G√©n√©rer le PDF
        console.log('üìÑ G√©n√©ration du PDF...');
        validateButton.textContent = 'üìÑ G√©n√©ration PDF...';
        const doc = generatePDF();
        if (!doc) {
          throw new Error('Erreur lors de la g√©n√©ration du PDF');
        }
        
        // 3. T√©l√©charger le PDF
        const pdfBlob = doc.output('blob');
        const url = URL.createObjectURL(pdfBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Audit_${currentAudit.num_audit}_${currentProspect.nom_prospect}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('‚úÖ Audit valid√© ! PDF t√©l√©charg√© avec succ√®s !');
        
        // 4. Recharger les donn√©es
        await loadAuditData(currentAudit.id_audit);
        
      } catch (error) {
        console.error('‚ùå Erreur:', error);
        alert(`‚ùå Erreur: ${error.message}`);
      } finally {
        validateButton.disabled = false;
        validateButton.textContent = '‚úÖ Valider & G√©n√©rer PDF';
      }
    }
    
    async function updateStatut(newStatut) {
      if (!currentAudit) {
        alert('‚ö†Ô∏è Impossible de mettre √† jour : audit non charg√©');
        return;
      }
      
      try {
        const { error } = await supabase
          .from('audits')
          .update({ statut: newStatut })
          .eq('id_audit', currentAudit.id_audit);
        
        if (error) {
          alert('‚ùå Erreur lors de la mise √† jour du statut');
          return;
        }
        
        alert(`‚úÖ Statut mis √† jour : ${newStatut}`);
        await loadAuditData(currentAudit.id_audit);
      } catch (error) {
        alert('‚ùå Erreur de connexion √† la base de donn√©es');
      }
    }
    
    function goBack() {
      window.location.href = 'auditHistory.html';
    }
    
    function showError(message) {
      document.getElementById('prospectInfo').innerHTML = `<div class="error">${message}</div>`;
      document.getElementById('auditInfo').innerHTML = `<div class="error">${message}</div>`;
      document.getElementById('equipementsList').innerHTML = `<div class="error">${message}</div>`;
      document.getElementById('summaryGrid').innerHTML = `<div class="error">${message}</div>`;
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
      const auditId = getAuditIdFromURL();
      if (auditId) {
        await loadAuditData(auditId);
      } else {
        showError('Aucun audit sp√©cifi√©');
      }
    });
  </script>
</body>
</html> 