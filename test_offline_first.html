<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Mode Offline-First - JPSI</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="js/indexedDB.js"></script>
  <script src="js/syncManager.js"></script>
  <script src="js/offlineSync.js"></script>
  <style>
    body {
      font-family: 'SF Pro Display', 'Segoe UI', Arial, sans-serif;
      background: repeating-linear-gradient(135deg, #23272b 0 10px, #262a2e 10px 20px);
      color: white;
      padding: 2rem;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 2rem;
      backdrop-filter: blur(10px);
    }
    
    .test-section {
      margin: 2rem 0;
      padding: 1.5rem;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .test-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #9B2423;
    }
    
    .test-button {
      background: #9B2423;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      margin: 0.5rem;
      font-size: 1rem;
    }
    
    .test-button:hover {
      background: #7a1d1c;
    }
    
    .test-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .status {
      margin: 1rem 0;
      padding: 1rem;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .status.success {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid #22c55e;
    }
    
    .status.error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
    }
    
    .status.info {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid #3b82f6;
    }
    
    .log {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 1rem;
      font-family: monospace;
      font-size: 0.8rem;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    .progress-bar {
      width: 100%;
      height: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      overflow: hidden;
      margin: 1rem 0;
    }
    
    .progress-fill {
      height: 100%;
      background: #9B2423;
      transition: width 0.3s ease;
      width: 0%;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª Test Mode Offline-First</h1>
    <p>Page de test pour valider le nouveau systÃ¨me offline-first</p>
    
    <div class="test-section">
      <h2 class="test-title">ğŸ”§ Tests de Base</h2>
      <button class="test-button" onclick="testIndexedDB()">Test IndexedDB</button>
      <button class="test-button" onclick="testSyncManager()">Test SyncManager</button>
      <button class="test-button" onclick="testOfflineFirstManager()">Test OfflineFirstManager</button>
      <div id="baseStatus" class="status info">En attente des tests...</div>
    </div>
    
    <div class="test-section">
      <h2 class="test-title">ğŸš€ Test PrÃ©chargement</h2>
      <input type="number" id="siteId" placeholder="ID Site" value="1" style="padding: 0.5rem; margin: 0.5rem; border-radius: 4px; border: none;">
      <input type="number" id="interventionId" placeholder="ID Intervention" value="1" style="padding: 0.5rem; margin: 0.5rem; border-radius: 4px; border: none;">
      <br>
      <button class="test-button" onclick="testPreload()">Test PrÃ©chargement</button>
      <button class="test-button" onclick="testPreloadStatus()">Statut PrÃ©chargement</button>
      <button class="test-button" onclick="clearPreloadedData()">Nettoyer DonnÃ©es</button>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div id="preloadStatus" class="status info">En attente du prÃ©chargement...</div>
    </div>
    
    <div class="test-section">
      <h2 class="test-title">ğŸ“Š Tests de Synchronisation</h2>
      <button class="test-button" onclick="testSyncQueue()">Test File d'Attente</button>
      <button class="test-button" onclick="testForceSync()">Test Sync ForcÃ©e</button>
      <button class="test-button" onclick="testSyncStatus()">Statut Sync</button>
      <div id="syncStatus" class="status info">En attente des tests de sync...</div>
    </div>
    
         <div class="test-section">
       <h2 class="test-title">ğŸ“ Logs</h2>
               <button class="test-button" onclick="clearLogs()">Nettoyer Logs</button>
        <button class="test-button" onclick="window.location.href='clear_indexeddb.html'">ğŸ§¹ Nettoyer IndexedDB</button>
        <button class="test-button" onclick="forceCleanIndexedDB()" style="background: #dc2626;">ğŸš¨ Nettoyage d'Urgence</button>
        <button class="test-button" onclick="clearSyncQueue()" style="background: #f59e0b;">ğŸ§¹ Nettoyer File Sync</button>
       <div class="log" id="logContainer"></div>
     </div>
  </div>

  <script>
    // Configuration Supabase
    const SUPABASE_URL = 'https://anyzqzhjvankvbbajahj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFueXpxemhqdmFua3ZiYmFqYWhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NTIzMjgsImV4cCI6MjA2NjMyODMyOH0.74pICcGtU_Ks0COTtPsSOQ8qtLfOzRHTNa1A41BAiMU';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Fonction de logging
    function log(message) {
      const logContainer = document.getElementById('logContainer');
      const timestamp = new Date().toLocaleTimeString();
      logContainer.textContent += `[${timestamp}] ${message}\n`;
      logContainer.scrollTop = logContainer.scrollHeight;
      console.log(message);
    }
    
         // Test IndexedDB
     async function testIndexedDB() {
       const status = document.getElementById('baseStatus');
       try {
         log('ğŸ§ª Test IndexedDB...');
         
         // VÃ©rifier si l'instance existe
         if (typeof indexedDBManager === 'undefined') {
           throw new Error('IndexedDBManager non disponible - instance globale manquante');
         }
         
         await indexedDBManager.init();
         log('âœ… IndexedDB initialisÃ©');
         
         // Test de sauvegarde
         await indexedDBManager.saveData('clients', { id_client: 1, nom_client: 'Test Client' });
         log('âœ… Test de sauvegarde rÃ©ussi');
         
         // Test de lecture
         const data = await indexedDBManager.getData('clients');
         log(`âœ… Test de lecture rÃ©ussi: ${JSON.stringify(data)}`);
         
         status.className = 'status success';
         status.textContent = 'âœ… IndexedDB fonctionne correctement';
         
       } catch (error) {
         log(`âŒ Erreur IndexedDB: ${error.message}`);
         status.className = 'status error';
         status.textContent = `âŒ Erreur IndexedDB: ${error.message}`;
       }
     }
    
         // Test SyncManager
     async function testSyncManager() {
       const status = document.getElementById('baseStatus');
       try {
         log('ğŸ§ª Test SyncManager...');
         
         if (typeof syncManager === 'undefined') {
           throw new Error('SyncManager non disponible - instance globale manquante');
         }
         
         log('âœ… SyncManager disponible');
         log(`ğŸ“¡ Statut rÃ©seau: ${syncManager.isOnline ? 'En ligne' : 'Hors ligne'}`);
         
         status.className = 'status success';
         status.textContent = 'âœ… SyncManager fonctionne correctement';
         
       } catch (error) {
         log(`âŒ Erreur SyncManager: ${error.message}`);
         status.className = 'status error';
         status.textContent = `âŒ Erreur SyncManager: ${error.message}`;
       }
     }
    
         // Test OfflineFirstManager
     async function testOfflineFirstManager() {
       const status = document.getElementById('baseStatus');
       try {
         log('ğŸ§ª Test OfflineFirstManager...');
         
         if (typeof offlineFirstManager === 'undefined') {
           throw new Error('OfflineFirstManager non disponible - instance globale manquante');
         }
         
         const preloadStatus = offlineFirstManager.getPreloadStatus();
         log(`âœ… OfflineFirstManager disponible`);
         log(`ğŸ“Š Statut prÃ©chargement: ${JSON.stringify(preloadStatus)}`);
         
         status.className = 'status success';
         status.textContent = 'âœ… OfflineFirstManager fonctionne correctement';
         
       } catch (error) {
         log(`âŒ Erreur OfflineFirstManager: ${error.message}`);
         status.className = 'status error';
         status.textContent = `âŒ Erreur OfflineFirstManager: ${error.message}`;
       }
     }
    
    // Test PrÃ©chargement
    async function testPreload() {
      const status = document.getElementById('preloadStatus');
      const progressFill = document.getElementById('progressFill');
      const siteId = parseInt(document.getElementById('siteId').value);
      const interventionId = parseInt(document.getElementById('interventionId').value);
      
      try {
        log(`ğŸš€ Test prÃ©chargement pour site ${siteId}, intervention ${interventionId}...`);
        status.className = 'status info';
        status.textContent = 'â³ PrÃ©chargement en cours...';
        
                 const success = await offlineFirstManager.preloadInterventionData(
           interventionId,
           siteId,
           (progress, label) => {
             progressFill.style.width = `${progress}%`;
             log(`ğŸ“Š Progression: ${progress}% - ${label}`);
           }
         );
        
        if (success) {
          log('âœ… PrÃ©chargement rÃ©ussi');
          status.className = 'status success';
          status.textContent = 'âœ… PrÃ©chargement terminÃ© avec succÃ¨s';
        } else {
          throw new Error('Ã‰chec du prÃ©chargement');
        }
        
      } catch (error) {
        log(`âŒ Erreur prÃ©chargement: ${error.message}`);
        status.className = 'status error';
        status.textContent = `âŒ Erreur prÃ©chargement: ${error.message}`;
      }
    }
    
    // Test Statut PrÃ©chargement
    async function testPreloadStatus() {
      const status = document.getElementById('preloadStatus');
      const siteId = parseInt(document.getElementById('siteId').value);
      const interventionId = parseInt(document.getElementById('interventionId').value);
      
      try {
        log('ğŸ“Š VÃ©rification statut prÃ©chargement...');
        
                 const isPreloaded = offlineFirstManager.isDataPreloaded(siteId, interventionId);
         const preloadStatus = offlineFirstManager.getPreloadStatus();
        
        log(`ğŸ” DonnÃ©es prÃ©chargÃ©es: ${isPreloaded ? 'Oui' : 'Non'}`);
        log(`ğŸ“Š Statut complet: ${JSON.stringify(preloadStatus)}`);
        
        status.className = 'status success';
        status.textContent = `ğŸ“Š PrÃ©chargÃ©: ${isPreloaded ? 'Oui' : 'Non'} | Sites: ${preloadStatus.preloadedSites} | Interventions: ${preloadStatus.preloadedInterventions}`;
        
      } catch (error) {
        log(`âŒ Erreur statut: ${error.message}`);
        status.className = 'status error';
        status.textContent = `âŒ Erreur statut: ${error.message}`;
      }
    }
    
    // Nettoyer donnÃ©es prÃ©chargÃ©es
    async function clearPreloadedData() {
      const status = document.getElementById('preloadStatus');
      try {
        log('ğŸ§¹ Nettoyage des donnÃ©es prÃ©chargÃ©es...');
        
                 await offlineFirstManager.clearPreloadedData();
        
        log('âœ… DonnÃ©es prÃ©chargÃ©es nettoyÃ©es');
        status.className = 'status success';
        status.textContent = 'âœ… DonnÃ©es prÃ©chargÃ©es nettoyÃ©es';
        
      } catch (error) {
        log(`âŒ Erreur nettoyage: ${error.message}`);
        status.className = 'status error';
        status.textContent = `âŒ Erreur nettoyage: ${error.message}`;
      }
    }
    
    // Test File d'Attente
    async function testSyncQueue() {
      const status = document.getElementById('syncStatus');
      try {
        log('ğŸ§ª Test file d\'attente de synchronisation...');
        
                 if (typeof offlineSyncManager === 'undefined') {
           throw new Error('OfflineSyncManager non disponible - instance globale manquante');
         }
         
         // Ajouter un Ã©lÃ©ment de test
         const syncId = await offlineSyncManager.addToSyncQueue({
          type: 'insert',
          table: 'pendingVerifications',
          data: { 
            id_equipement: 999, 
            type_equipement: 'extincteur',
            statut: 'Test Sync',
            date_verification: new Date().toISOString()
          }
        });
        
        log(`âœ… Ã‰lÃ©ment ajoutÃ© Ã  la file: ${syncId}`);
        
        const syncStatus = offlineSyncManager.getSyncStatus();
        log(`ğŸ“Š Statut file: ${JSON.stringify(syncStatus)}`);
        
        status.className = 'status success';
        status.textContent = `âœ… File d'attente: ${syncStatus.total} Ã©lÃ©ments`;
        
      } catch (error) {
        log(`âŒ Erreur file d'attente: ${error.message}`);
        status.className = 'status error';
        status.textContent = `âŒ Erreur file d'attente: ${error.message}`;
      }
    }
    
    // Test Sync ForcÃ©e
    async function testForceSync() {
      const status = document.getElementById('syncStatus');
      try {
        log('ğŸ”„ Test synchronisation forcÃ©e...');
        
                 await offlineSyncManager.forceSync();
        
        log('âœ… Synchronisation forcÃ©e terminÃ©e');
        status.className = 'status success';
        status.textContent = 'âœ… Synchronisation forcÃ©e terminÃ©e';
        
      } catch (error) {
        log(`âŒ Erreur sync forcÃ©e: ${error.message}`);
        status.className = 'status error';
        status.textContent = `âŒ Erreur sync forcÃ©e: ${error.message}`;
      }
    }
    
    // Test Statut Sync
    async function testSyncStatus() {
      const status = document.getElementById('syncStatus');
      try {
        log('ğŸ“Š VÃ©rification statut synchronisation...');
        
        const syncStatus = offlineSyncManager.getSyncStatus();
        log(`ğŸ“Š Statut sync: ${JSON.stringify(syncStatus)}`);
        
        status.className = 'status success';
        status.textContent = `ğŸ“Š Sync: ${syncStatus.total} total, ${syncStatus.pending} en attente, ${syncStatus.failed} Ã©checs`;
        
      } catch (error) {
        log(`âŒ Erreur statut sync: ${error.message}`);
        status.className = 'status error';
        status.textContent = `âŒ Erreur statut sync: ${error.message}`;
      }
    }
    
         // Nettoyer logs
     function clearLogs() {
       document.getElementById('logContainer').textContent = '';
       log('ğŸ§¹ Logs nettoyÃ©s');
     }
     
           // Nettoyer file d'attente de synchronisation
      async function clearSyncQueue() {
        try {
          log('ğŸ§¹ Nettoyage de la file d\'attente de synchronisation...');
          
          if (typeof offlineSyncManager !== 'undefined') {
            // Vider la file d'attente
            await offlineSyncManager.clearQueue();
            log('âœ… File d\'attente de synchronisation nettoyÃ©e');
          } else {
            // Fallback : nettoyer directement localStorage
            localStorage.removeItem('jpsi_sync_queue');
            log('âœ… File d\'attente nettoyÃ©e via localStorage');
          }
          
        } catch (error) {
          log(`âŒ Erreur nettoyage file sync: ${error.message}`);
          // Fallback en cas d'erreur
          try {
            localStorage.removeItem('jpsi_sync_queue');
            log('âœ… Nettoyage de secours via localStorage');
          } catch (fallbackError) {
            log(`âŒ Ã‰chec du nettoyage de secours: ${fallbackError.message}`);
          }
        }
      }
    
         // Nettoyer IndexedDB automatiquement si erreur de version
     async function forceCleanIndexedDB() {
       try {
         log('ğŸ§¹ Nettoyage forcÃ© d\'IndexedDB...');
         const deleteRequest = indexedDB.deleteDatabase('JPSIDatabase');
         
         deleteRequest.onsuccess = function() {
           log('âœ… IndexedDB supprimÃ© avec succÃ¨s');
           log('ğŸ”„ Rechargement de la page...');
           setTimeout(() => window.location.reload(), 1000);
         };
         
         deleteRequest.onerror = function() {
           log('âŒ Erreur lors de la suppression');
         };
         
       } catch (error) {
         log(`âŒ Erreur nettoyage: ${error.message}`);
       }
     }
     
     // Initialisation
     document.addEventListener('DOMContentLoaded', function() {
       log('ğŸš€ Page de test initialisÃ©e');
       log(`ğŸ“± User Agent: ${navigator.userAgent}`);
       log(`ğŸŒ En ligne: ${navigator.onLine}`);
       log(`ğŸ’¾ IndexedDB supportÃ©: ${'indexedDB' in window}`);
       log(`ğŸ”§ Service Worker supportÃ©: ${'serviceWorker' in navigator}`);
       
       // VÃ©rifier si IndexedDB fonctionne
       setTimeout(async () => {
         try {
                    if (typeof indexedDBManager !== 'undefined') {
           await indexedDBManager.init();
             log('âœ… IndexedDB initialisÃ© correctement');
           }
         } catch (error) {
           if (error.message.includes('higher version')) {
             log('âš ï¸ Conflit de version IndexedDB dÃ©tectÃ©');
             log('ğŸ”„ Nettoyage automatique en cours...');
             await forceCleanIndexedDB();
           }
         }
       }, 1000);
     });
  </script>
</body>
</html>
