<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JPSI - Vérification Alarme</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="supabase-config.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      min-height: 100vh;
      min-width: 100vw;
      background: repeating-linear-gradient(135deg, #23272b 0 10px, #262a2e 10px 20px);
      font-family: 'SF Pro Display', 'Segoe UI', Arial, sans-serif;
      box-sizing: border-box;
      overflow-x: hidden;
      overflow-y: auto;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    
    .header-card {
      background: #f6f7f9;
      border: 3.5px solid #FFD700;
      border-radius: 38px;
      box-shadow: 0 6px 24px 0 rgba(30,32,36,0.13), 0 1.5px 0 #e5e7eb inset;
      padding: 2rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }
    
    .back-button {
      background: #FFD700;
      color: #23272b;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .back-button:hover {
      background: #FFA500;
    }
    
    .header-title {
      font-size: 2.2rem;
      font-weight: 700;
      color: #23272b;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .header-subtitle {
      font-size: 0.9rem;
      font-weight: 500;
      color: #6b7280;
      margin: 0;
    }
    
    .equipment-info {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 2rem;
      margin-bottom: 2rem;
    }
    
    .equipment-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .equipment-icon {
      width: 60px;
      height: 60px;
      background: #FFD700;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #23272b;
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .equipment-details {
      flex: 1;
    }
    
    .equipment-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: #23272b;
      margin-bottom: 0.25rem;
    }
    
    .equipment-location {
      font-size: 1rem;
      color: #6b7280;
      font-weight: 500;
    }
    
    .equipment-type {
      font-size: 0.9rem;
      color: #9ca3af;
      font-style: italic;
    }
    
    .verification-form {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 2rem;
    }
    
    .form-section {
      margin-bottom: 2rem;
    }
    
    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #23272b;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-label {
      display: block;
      font-size: 1rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
      box-sizing: border-box;
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #FFD700;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .form-help {
      display: block;
      font-size: 0.875rem;
      color: #6b7280;
      margin-top: 0.5rem;
      font-style: italic;
    }
    
    .buttons-container {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 2px solid #e5e7eb;
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #FFD700;
      color: #23272b;
    }
    
    .btn-primary:hover {
      background: #FFA500;
    }
    
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    .loading {
      text-align: center;
      padding: 3rem;
      color: #6b7280;
    }
    
    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #FFD700;
      animation: spin 1s ease-in-out infinite;
      margin-left: 1rem;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .error {
      text-align: center;
      padding: 3rem;
      color: #ef4444;
      font-size: 1.1rem;
    }
    
    /* Optimisations pour iPad */
    @media (min-width: 768px) {
      .container {
        padding: 2.5rem;
      }
      
      .header-card {
        padding: 2.5rem;
      }
      
      .equipment-info,
      .verification-form {
        padding: 2.5rem;
      }
      
      .form-input,
      .form-select,
      .form-textarea {
        padding: 1rem 1.25rem;
        font-size: 1.1rem;
      }
      
      .btn {
        padding: 1rem 2rem;
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-card">
      <button class="back-button" onclick="goBack()">←</button>
      <div>
        <h1 class="header-title">
          Vérification Alarme
          <span class="header-subtitle" id="equipmentInfo">Chargement...</span>
        </h1>
      </div>
    </div>

    <div id="content">
      <div class="loading">Chargement des informations...</div>
    </div>
  </div>

  <script>
    // Utiliser la configuration Supabase existante
    let supabaseClient = null;
    
    let currentSite = null;
    let currentAlarme = null;

    // Initialisation
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Initialiser Supabase
        supabaseClient = window.supabaseClient;
        if (!supabaseClient) {
          // Attendre que Supabase soit initialisé
          await new Promise(resolve => {
            const checkSupabase = () => {
              if (window.supabaseClient) {
                supabaseClient = window.supabaseClient;
                resolve();
              } else {
                setTimeout(checkSupabase, 100);
              }
            };
            checkSupabase();
          });
        }
        
        // Récupérer les paramètres de l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const siteId = urlParams.get('site');
        const alarmeId = urlParams.get('alarme');
        
        if (!siteId || !alarmeId) {
          throw new Error('Paramètres manquants');
        }
        
        console.log('Chargement pour site:', siteId, 'alarme:', alarmeId);
        
        // Charger les données
        await loadSiteData(siteId);
        await loadAlarmeData(alarmeId);
        
      } catch (error) {
        console.error('Erreur d\'initialisation:', error);
        showError('Erreur d\'initialisation: ' + error.message);
      }
    });

    // Charger les données du site
    async function loadSiteData(siteId) {
      try {
        console.log('Chargement du site:', siteId);
        
        const { data: site, error } = await supabaseClient
          .from('sites')
          .select('*')
          .eq('id_site', siteId)
          .single();

        if (error) {
          console.error('Erreur site:', error);
          throw error;
        }

        currentSite = site;
        console.log('Site chargé:', site);
        
      } catch (error) {
        console.error('Erreur lors du chargement du site:', error);
        throw error;
      }
    }

    // Charger les données de l'alarme et la dernière vérification
    async function loadAlarmeData(alarmeId) {
      try {
        console.log('Chargement de l\'alarme:', alarmeId);
        
        const { data: alarme, error } = await supabaseClient
          .from('alarmes')
          .select('*')
          .eq('id_alarme', alarmeId)
          .single();

        if (error) {
          console.error('Erreur alarme:', error);
          throw error;
        }

        currentAlarme = alarme;
        console.log('Alarme chargée:', alarme);
        
        // Charger la dernière vérification pour cet équipement
        await loadLastVerification(alarmeId);
        
        displayVerificationForm();
        
      } catch (error) {
        console.error('Erreur lors du chargement de l\'alarme:', error);
        throw error;
      }
    }
    
    // Charger la dernière vérification
    async function loadLastVerification(alarmeId) {
      try {
        console.log('Chargement de la dernière vérification pour:', alarmeId);
        
        const { data: lastVerification, error } = await supabaseClient
          .from('verifications')
          .select('*')
          .eq('id_equipement', alarmeId)
          .eq('type_equipement', 'alarmes')
          .order('date_verification', { ascending: false })
          .limit(1)
          .single();

        if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
          console.error('Erreur vérification:', error);
          throw error;
        }

        currentAlarme.lastVerification = lastVerification || null;
        console.log('Dernière vérification chargée:', lastVerification);
        
      } catch (error) {
        console.error('Erreur lors du chargement de la vérification:', error);
        currentAlarme.lastVerification = null;
      }
    }

    // Afficher le formulaire de vérification
    function displayVerificationForm() {
      const content = document.getElementById('content');
      const equipmentInfo = document.getElementById('equipmentInfo');
      
      // Mettre à jour le titre
      equipmentInfo.textContent = `${currentSite.nom_site} - ${currentAlarme.type_alarme || 'N/A'}`;
      
      // Déterminer l'état actuel basé sur la dernière vérification
      let currentState = '';
      if (currentAlarme.lastVerification) {
        if (currentAlarme.lastVerification.etat_verification === 'OK') {
          currentState = 'Fonctionnel';
        } else if (currentAlarme.lastVerification.etat_verification === 'Défaut') {
          currentState = 'Défaut';
        } else if (currentAlarme.lastVerification.etat_verification === 'Hors service') {
          currentState = 'Hors service';
        }
      }
      
      content.innerHTML = `
        <div class="equipment-info">
          <div class="equipment-header">
            <div class="equipment-icon">🚨</div>
            <div class="equipment-details">
              <div class="equipment-number">Alarme ${currentAlarme.type_alarme || 'N/A'}</div>
              <div class="equipment-location">${currentAlarme.marque_alarme || 'Marque non spécifiée'} - ${currentAlarme.modele_alarme || 'Modèle non spécifié'}</div>
              <div class="equipment-type">Système d'alarme incendie</div>
            </div>
          </div>
        </div>

        <div class="verification-form">
          <form id="verificationForm" onsubmit="saveVerification(event)">
            <div class="form-section">
              <h2 class="section-title">État de fonctionnement</h2>
              <div class="form-group">
                <label for="functioning" class="form-label">État de fonctionnement</label>
                <select id="functioning" name="functioning" class="form-select" required>
                  <option value="">Sélectionnez un état</option>
                  <option value="Fonctionnel" ${currentState === 'Fonctionnel' ? 'selected' : ''}>🟢 Fonctionnel</option>
                  <option value="Défaut" ${currentState === 'Défaut' ? 'selected' : ''}>🟠 Défaut</option>
                  <option value="Hors service" ${currentState === 'Hors service' ? 'selected' : ''}>🔴 Hors service</option>
                </select>
                <small class="form-help">Cette vérification sera enregistrée avec la date du jour</small>
              </div>
            </div>

            <div class="form-section">
              <h2 class="section-title">Observations</h2>
              <div class="form-group">
                <label for="observations" class="form-label">Observations et remarques</label>
                <textarea id="observations" name="observations" class="form-textarea" placeholder="Décrivez l'état, les anomalies, les actions effectuées...">${currentAlarme.notes_alarme || ''}</textarea>
              </div>
            </div>

            <div class="buttons-container">
              <button type="button" class="btn btn-secondary" onclick="goBack()">
                Annuler
              </button>
              <button type="submit" class="btn btn-primary" id="saveButton">
                <span id="saveButtonText">Enregistrer la vérification</span>
              </button>
            </div>
          </form>
        </div>
      `;
    }

    // Sauvegarder la vérification
    async function saveVerification(event) {
      event.preventDefault();
      
      if (!currentSite || !currentAlarme) {
        alert('❌ Données non chargées');
        return;
      }
      
      const formData = new FormData(event.target);
      const functioning = formData.get('functioning');
      const observations = formData.get('observations');
      
      if (!functioning) {
        alert('Veuillez sélectionner l\'état de fonctionnement');
        return;
      }
      
      const verificationDate = new Date().toISOString();
      
      console.log('💾 État de fonctionnement:', functioning);
      console.log('💾 Date de vérification:', verificationDate);
      
      const saveButton = document.getElementById('saveButton');
      const saveButtonText = document.getElementById('saveButtonText');
      saveButton.disabled = true;
      saveButtonText.textContent = 'Enregistrement...';
      
      try {
        // Récupérer l'ID de l'intervention depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const interventionId = urlParams.get('intervention');
        
        // Convertir l'état de fonctionnement en état de vérification
        let etatVerification = 'OK';
        if (functioning === 'Défaut') {
          etatVerification = 'Défaut';
        } else if (functioning === 'Hors service') {
          etatVerification = 'Hors service';
        }
        
        // Créer l'enregistrement de vérification
        const verificationData = {
          id_intervention: interventionId,
          id_equipement: currentAlarme.id_alarme,
          type_equipement: 'alarmes',
          etat_verification: etatVerification,
          observations: observations,
          date_verification: verificationDate,
          created_at: verificationDate
        };
        
        console.log('💾 Données de vérification à sauvegarder:', verificationData);
        
        // Vérifier si une vérification existe déjà pour cette intervention et cet équipement
        let existingVerification = null;
        let checkError = null;
        
        if (interventionId) {
          // Mode intervention - vérifier si une vérification existe déjà
          const { data, error } = await supabaseClient
            .from('verifications')
            .select('*')
            .eq('id_intervention', interventionId)
            .eq('id_equipement', currentAlarme.id_alarme)
            .eq('type_equipement', 'alarmes')
            .single();
          
          existingVerification = data;
          checkError = error;
        }
        
        if (checkError && checkError.code !== 'PGRST116') {
          console.error('❌ Erreur vérification existence:', checkError);
          throw checkError;
        }
        
        let verificationError;
        if (existingVerification && interventionId) {
          // Mettre à jour la vérification existante (mode intervention)
          console.log('🔄 Mise à jour de la vérification existante');
          const { error } = await supabaseClient
            .from('verifications')
            .update(verificationData)
            .eq('id_intervention', interventionId)
            .eq('id_equipement', currentAlarme.id_alarme)
            .eq('type_equipement', 'alarmes');
          verificationError = error;
        } else {
          // Insérer une nouvelle vérification (mode parc ou nouvelle intervention)
          console.log('➕ Insertion d\'une nouvelle vérification');
          const { data, error } = await supabaseClient
            .from('verifications')
            .insert([verificationData])
            .select()
            .single();
          verificationError = error;
          if (!error) {
            console.log('✅ Vérification créée:', data);
          }
        }
        
        if (verificationError) {
          console.error('❌ Erreur sauvegarde vérification:', verificationError);
          throw verificationError;
        }
        
        // Mettre à jour la date de vérification et les observations dans la table alarmes
        const { error: updateError } = await supabaseClient
          .from('alarmes')
          .update({ 
            last_alarme: verificationDate,
            notes_alarme: observations
          })
          .eq('id_alarme', currentAlarme.id_alarme);
        
        if (updateError) {
          console.error('❌ Erreur mise à jour alarme:', updateError);
          throw updateError;
        }
        
        console.log('✅ Vérification enregistrée avec succès');
        console.log('✅ Date de vérification enregistrée:', verificationDate);
        console.log('✅ État de vérification:', etatVerification);
        
        alert('✅ Vérification enregistrée avec succès !\n\n' +
              `État: ${functioning}\n` +
              `Date: ${new Date(verificationDate).toLocaleDateString('fr-FR')}`);
        
        goBack();
        
      } catch (error) {
        console.error('❌ Erreur lors de la sauvegarde:', error);
        alert('❌ Erreur lors de la sauvegarde: ' + error.message);
      } finally {
        saveButton.disabled = false;
        saveButtonText.textContent = 'Enregistrer la vérification';
      }
    }

    // Retourner à la page précédente
    function goBack() {
      if (currentSite) {
        // Récupérer l'ID de l'intervention depuis l'URL actuelle
        const urlParams = new URLSearchParams(window.location.search);
        const interventionId = urlParams.get('intervention');
        
        let returnUrl = 'alarmeSite.html?site=' + encodeURIComponent(currentSite.id_site);
        if (interventionId) {
          returnUrl += '&intervention=' + encodeURIComponent(interventionId);
        }
        
        window.location.href = returnUrl;
      } else {
        window.history.back();
      }
    }

    // Afficher une erreur
    function showError(message) {
      const content = document.getElementById('content');
      content.innerHTML = `
        <div class="error">
          <h3>Erreur</h3>
          <p>${message}</p>
          <button class="btn btn-secondary" onclick="goBack()">Retour</button>
        </div>
      `;
    }
  </script>
</body>
</html>
